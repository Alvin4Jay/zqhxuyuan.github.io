<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra数据迁移3 多数据中心数据迁移 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="接上文: 迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace不重复(DC1,DC3).">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra数据迁移3 多数据中心数据迁移">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="接上文: 迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace不重复(DC1,DC3).">
<meta property="og:updated_time" content="2015-12-19T08:39:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra数据迁移3 多数据中心数据迁移">
<meta name="twitter:description" content="接上文: 迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace不重复(DC1,DC3).">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/cassandra/" style="font-size: 20px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 18px;">drill</a> <a href="/tags/druid/" style="font-size: 14px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/hbase/" style="font-size: 16px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/scala/" style="font-size: 12px;">scala</a> <a href="/tags/spark/" style="font-size: 14px;">spark</a> <a href="/tags/storm/" style="font-size: 16px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12px;">timeseries</a> <a href="/tags/work/" style="font-size: 12px;">work</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-08-28-Cassandra-Migration3_TestSandbox" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/" class="article-date">
  	<time datetime="2015-08-27T16:00:00.000Z" itemprop="datePublished">2015-08-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra数据迁移3 多数据中心数据迁移
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>接上文: 迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace不重复(DC1,DC3).  </p>
<a id="more"></a>
<h2 id="线下测试方案2:_DC1,_DC3">线下测试方案2: DC1, DC3</h2><p>停掉所有节点,并把每个节点的数据文件都删掉,启动原数据中心DC1节点,重新建库表,导入数据,再启动新数据中心DC3.  </p>
<blockquote>
<p>这里我们修改了forseti, forseti_fp的副本数为1, 因为要模拟线上的环境并一定每个节点都有数据.<br>如果这里为2的话,线下环境每个数据中心只有两个节点, 结果就是每个节点都有数据,而为1的话,就只存储一个节点.  </p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin jps | grep CassandraDaemon |awk <span class="string">'&#123;print $1&#125;'</span> | xargs sudo -u admin kill -<span class="number">9</span></span><br><span class="line">sudo rm -rf <span class="regexp">/var/</span>lib<span class="regexp">/cassandra/</span>commitlog &amp;&amp; sudo rm -rf <span class="regexp">/var/</span>lib<span class="regexp">/cassandra/</span>data &amp;&amp; sudo rm <span class="regexp">/var/</span>log<span class="regexp">/cassandra/</span>*</span><br><span class="line">注意要先启动种子节点<span class="number">52</span>, 然后启动<span class="number">53.</span> </span><br><span class="line">sudo -u admin <span class="regexp">/usr/</span>install<span class="regexp">/apache-cassandra-2.0.16/</span>bin/cassandra</span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/apache-cassandra-2.0.16/</span>bin/nodetool status</span><br><span class="line"></span><br><span class="line">nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> status</span><br><span class="line">cqlsh <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> -f <span class="regexp">~/Documents/</span>forseti.cql </span><br><span class="line">cqlsh <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> -f <span class="regexp">~/Documents/</span>forseti_fp.cql</span><br><span class="line">cqlsh <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> -f <span class="regexp">~/github/</span>cassandra-bulkload-example/forseti_schema.cql</span><br><span class="line">sstableloader -d <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> <span class="regexp">~/github/</span>cassandra-bulkload-example<span class="regexp">/data/</span>forseti/historical_prices</span><br><span class="line">sstableloader -d <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> <span class="regexp">~/github/</span>cassandra-bulkload-example<span class="regexp">/data/</span>forseti_fp/historical_prices</span><br></pre></td></tr></table></figure>
<p>在方案1的第四步修改56,57的cassandra-rackdc.properties数据中心为DC3, 并启动56,57.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u admin vi <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>conf/cassandra-rackdc.properties</span><br><span class="line">dc=DC3</span><br><span class="line">rack=RAC1</span><br></pre></td></tr></table></figure>
<p>使用cqlsh连接原数据中心的52, 或者新数据中心的56都可以正常查询到数据.   </p>
<blockquote>
<p>不过实际运用中,一般业务代码访问的还都是原数据中心, 尽量保证业务代码不更改.</p>
</blockquote>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  cqlsh 192.168.6.52</span><br><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">➜  ~  cqlsh 192.168.6.56</span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span></span><br></pre></td></tr></table></figure>
<p>因为新的数据中心为DC3, 而现在的forset,forseti_fp的副本策略都只是DC1, DC2,<br>所以实际上DC3即使加入集群中, 也不会贡献力量.所以我们修改forseti_fp, 加入DC3:  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cqlsh&gt; ALTER KEYSPACE forseti_fp WITH REPLICATION = &#123; 'class' : 'NetworkTopologyStrategy', 'DC2' : 1, 'DC1' : 1, 'DC3' : 1&#125;;</span><br><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"></span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">(1 rows)</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"></span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span></span><br></pre></td></tr></table></figure>
<h3 id="模拟新数据写入">模拟新数据写入</h3><p>修改cassandra_bulk_example的BulkLoad的CSV_URL添加时间限制: +”&amp;a=6&amp;b=1&amp;c=2015”. 因为之前导的数据是7月份之前的.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">sstableloader -d <span class="number">192.168.6.52</span> ~/github/cassandra-bulkload-example/data_<span class="number">20150914</span>/forseti/historical_prices</span><br><span class="line"></span><br><span class="line">查询forseti是否有新的记录:  </span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices where  ticker='ORCL' and date='<span class="number">2015-09-01</span> <span class="number">00:00:00+08</span>00'<span class="comment">;</span></span><br><span class="line"> ticker | date                     | adj_close | close     | high      | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-----------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015-09-01</span> <span class="number">00:00:00+08</span>00 | <span class="number">36.009998</span> | <span class="number">36.009998</span> | <span class="number">36.549999</span> | <span class="number">35.889999</span> | <span class="number">36.330002</span> | <span class="number">19860700</span></span><br><span class="line"></span><br><span class="line">cqlsh&gt; select count(*) from forseti.historical_prices where  ticker='ORCL' and date&gt;='<span class="number">2015-07-01</span> <span class="number">00:00:00+08</span>00'<span class="comment">;</span></span><br><span class="line"> count</span><br><span class="line">-------</span><br><span class="line">    51</span><br><span class="line"></span><br><span class="line">数据文件查询,还是写入到53上.  </span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/</span><br><span class="line">-rw-r--r--. 1 admin admin <span class="number">1072677 9</span>月  12 15:02 forseti-historical_prices-jb-1-Data.db</span><br><span class="line">-rw-r--r--. 1 admin admin   <span class="number">15043 9</span>月  14 09:43 forseti-historical_prices-jb-2-Data.db    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sstableloader -d <span class="number">192.168.6.52</span> ~/github/cassandra-bulkload-example/data_<span class="number">20150914</span>/forseti_fp/historical_prices</span><br><span class="line"></span><br><span class="line">查询数据文件, 写入到了DC1的53, 写入到了DC3的56,57:  </span><br><span class="line">[qihuang.zheng@dp0652 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/</span><br><span class="line">总用量 0</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/</span><br><span class="line">-rw-r--r--. 1 admin admin <span class="number">1072677 9</span>月  12 15:02 forseti_fp-historical_prices-jb-1-Data.db</span><br><span class="line">-rw-r--r--. 1 admin admin   <span class="number">15043 9</span>月  14 09:49 forseti_fp-historical_prices-jb-2-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0656 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/</span><br><span class="line">-rw-r--r-- 1 admin admin 5178 9月  14 09:49 forseti_fp-historical_prices-jb-1-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0657 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/</span><br><span class="line">-rw-r--r-- 1 admin admin <span class="number">10123 9</span>月  14 09:49 forseti_fp-historical_prices-jb-1-Data.db</span><br><span class="line"></span><br><span class="line">查询forseti_fp是否有新记录:</span><br><span class="line">cqlsh&gt; select count(*) from forseti_fp.historical_prices where  ticker='ORCL' and date&gt;='<span class="number">2015-07-01</span> <span class="number">00:00:00+08</span>00'<span class="comment">;</span></span><br><span class="line"> count</span><br><span class="line">-------</span><br><span class="line">    51</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where  ticker='ORCL' and date='<span class="number">2015-09-01</span> <span class="number">00:00:00+08</span>00'<span class="comment">;</span></span><br><span class="line"> ticker | date                     | adj_close | close     | high      | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-----------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015-09-01</span> <span class="number">00:00:00+08</span>00 | <span class="number">36.009998</span> | <span class="number">36.009998</span> | <span class="number">36.549999</span> | <span class="number">35.889999</span> | <span class="number">36.330002</span> | <span class="number">19860700</span></span><br></pre></td></tr></table></figure>
<p>查询集群状态:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">✗ nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">364.36</span> KB  <span class="number">256</span>     <span class="number">26.0</span>%  <span class="number">19799</span>dc0-a25b-<span class="number">46f</span>8-<span class="number">930f</span>-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.43</span> MB    <span class="number">256</span>     <span class="number">25.8</span>%  fbccd93f-<span class="number">3</span>d0d-<span class="number">4e1</span>e-<span class="number">9696</span>-d3d1f2c6d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>  <span class="number">349.06</span> KB  <span class="number">256</span>     <span class="number">22.5</span>%  a51114e7-c17f-<span class="number">48</span>c9-a72e-<span class="number">679f</span>3f3ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>  <span class="number">412.46</span> KB  <span class="number">256</span>     <span class="number">25.6</span>%  <span class="number">319e9</span>e84-d38b-<span class="number">4</span>cd5-<span class="number">898f</span>-<span class="number">8e2</span>b3661f05f  RAC1</span><br></pre></td></tr></table></figure>
<p>查询forseti数据库的集群状态: 因为forseti只有DC1,DC2. 所以下面的DC3没有forseti的数据:Owns=0.0%  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">✗ nodetool -h 192.168.6.52 status forseti</span><br><span class="line"><span class="header">Datacenter: DC1</span><br><span class="line">===============</span></span><br><span class="line"><span class="bullet">--  </span>Address       Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  192.168.6.52  364.36 KB  256     49.0%             19799dc0-a25b-46f8-930f-c2a5ea6687df  RAC1</span><br><span class="line">UN  192.168.6.53  2.43 MB    256     51.0%             fbccd93f-3d0d-4e1e-9696-d3d1f2c6d380  RAC1</span><br><span class="line"><span class="header">Datacenter: DC3</span><br><span class="line">===============</span></span><br><span class="line"><span class="bullet">--  </span>Address       Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  192.168.6.56  349.06 KB  256     0.0%              a51114e7-c17f-48c9-a72e-679f3f3ad291  RAC1</span><br><span class="line">UN  192.168.6.57  412.46 KB  256     0.0%              319e9e84-d38b-4cd5-898f-8e2b3661f05f  RAC1</span><br></pre></td></tr></table></figure>
<p>查询forseti_fp数据库的集群状态: 因为forseti_fp写入了三个数据中心:DC1,DC2,DC3.<br>而DC2在集群中没有用到, 所以数据的Owns分布到了DC1,DC3上.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  cassandra-bulkload-example git:(master) ✗ nodetool -h <span class="number">192.168.6.52</span> status forseti_fp</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.52</span>  364.36 KB  256     49.0%             19799dc0-a25b-<span class="number">46f8-930</span>f-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.53</span>  2.43 MB    256     51.0%             fbccd93f-3d0d-4e1e-9696-d<span class="number">3d1f2c6</span>d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.56</span>  349.06 KB  256     48.6%             a<span class="number">51114e7</span>-c17f-48c9-a72e-<span class="number">679f3f3</span>ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.57</span>  412.46 KB  256     51.4%             <span class="number">319e9e84</span>-d38b-4cd5-898f-<span class="number">8e2b3661</span>f05f  RAC1</span><br></pre></td></tr></table></figure>
<p>目前成功验证了: <strong>新数据中心设置为DC3, 给forseti_fp添加新数据中心DC3, 数据会写入到DC1和DC3. 而forseti的设置没有变化,所以数据还是会写入到DC1中.</strong>  </p>
<h3 id="数据从原DC同步到新DC">数据从原DC同步到新DC</h3><p>接下来的问题是: 怎么把forseti_fp的数据中心从DC1完全迁移到DC3中, 也就是最终数据只要写入到DC3, 不能写入到DC1中, 查询时也只查询DC3.<br>首先一个不可避免的问题: 原数据中心DC1中的数据需要完全同步到新数据中心DC3中. 这样关掉写入DC1,只查询DC3时, 数据存在DC3中.  </p>
<p><a href="http://www.planetcassandra.org/blog/cassandra-migration-to-ec2/" target="_blank" rel="external">http://www.planetcassandra.org/blog/cassandra-migration-to-ec2/</a> </p>
<blockquote>
<p>We were able to migrate Cassandra with zero downtime using its awesome multi-data center support.使用C*的多数据中心特性可以在不宕机情况下迁移数据<br>Cassandra allows you to distribute your data in such a way that a complete set of data<br>is guaranteed to be placed on every logical group of nodes (eg. nodes that are on the same data-center, rack).<br>This feature is a perfect fit for migrating data from one data-center to another.<br>利用这种特性, Cassandra允许这样分布你的数据: 数据的全集确保放在节点的每个逻辑组中(逻辑组:在相同数据中心, 或者相同机架上的节点).  </p>
<p>For multi dc deployments the right strategy to use is the NetworkTopologyStrategy.<br>This strategy allows you to specify how many replicas you want in each data center and rack.<br>For example: { ‘class’ : ‘NetworkTopologyStrategy’[’dc1’ : 3, ‘dc2’ : 2]};<br>defines a replication policy where the data is replicated on 3 nodes for the datacenter ‘dc1’ and on 2 nodes for the datacenter ‘dc2’.<br>Cassandra multi-datacenter deployments require an appropriate configuration of the data replication strategy (per keyspace) and snitch.<br>The snitch is used to group nodes per datacenter and rack (determine the topology of the network).<br>The replication strategy defines how data should be replicated amongst these groups (across the nodes).<br>Changing the snitch alters the topology of your Cassandra network. After making this change you need to <code>run a full repair</code>.  </p>
</blockquote>
<p>这里的示例假设从non EC2 data center迁移到EC2上的数据中心.<br>与之对比的是线上的迁移业务:  将forseti_fp迁移到新的数据中心, 而forseti则保留原数据中心.    </p>
<h4 id="一-_Cassandra_Multi_DC_Support:">一. Cassandra Multi DC Support:</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.修改<span class="constant">SimpleSnitch</span>为<span class="constant">PropertyFileSnitch</span>, 集群中所有节点的配置都一样, 并依次重启每个节点.  </span><br><span class="line">  <span class="constant">PropertyFileSnitch</span>读取cassandra-topology.properties文件<span class="symbol">:</span>配置所有节点所在的数据中心和机架. </span><br><span class="line">  而<span class="constant">GossipingPropertyFileSnitch</span>读取的是casssandra-rackdc.properties配置的是本节点所在的<span class="constant">DC</span>和<span class="constant">Rack</span>.  </span><br><span class="line">  <span class="comment"># Data Center One</span></span><br><span class="line">  <span class="number">175.56</span>.<span class="number">12.105</span> =<span class="constant">DC1</span><span class="symbol">:RAC1</span></span><br><span class="line">  <span class="number">175.50</span>.<span class="number">13.200</span> =<span class="constant">DC1</span><span class="symbol">:RAC1</span></span><br><span class="line">  <span class="number">175.54</span>.<span class="number">35.197</span> =<span class="constant">DC1</span><span class="symbol">:RAC1</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.修改<span class="constant">SimpleStrategy</span>为<span class="constant">NetworkTopologyStrategy</span>, 数据中心使用上面配置的<span class="constant">DC1</span>.  </span><br><span class="line">  <span class="constant">ALTER</span> <span class="constant">KEYSPACE</span> <span class="string">"stream_data"</span> <span class="constant">WITH</span> <span class="constant">REPLICATION</span> = &#123; <span class="string">'class'</span> <span class="symbol">:</span> <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> <span class="symbol">:</span> <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.更新客户端连接设置为<span class="symbol">:</span> <span class="constant">DCAwareRoundRobinPolicy</span>, 设置local data center为<span class="constant">DC1</span>.  </span><br><span class="line">  确保客户端的读写发生在本地数据中心<span class="constant">DC1</span>, 而不是接下去要创建的<span class="constant">EC2</span>数据中心.  </span><br><span class="line"></span><br><span class="line">这三个步骤并没有影响副本在<span class="constant">DC1</span>上是怎么存放的, 或者客户端是怎么连接到集群的.  </span><br><span class="line">目的<span class="symbol">:</span> 确保可以安全地添加第二个数据中心(<span class="constant">EC2</span>,虽然这里还没有开始添加).</span><br></pre></td></tr></table></figure>
<p>对应的线上迁移步骤:<br>不需要做任何操作. 因为系统原有的配置都满足了.  </p>
<blockquote>
<p>线上原数据中心每台节点使用的都是GossipingPropertyFileSnitch. 并且cassandra-rackdc.properties都是dc=DC1, rack=RAC1默认DC1.<br>但是建表语句forseti,forseti_fp都是NetworkTopologyStrategy, ‘DC1’ : 3, ‘DC2’ : 2<br>所以这里要添加的第二个数据中心名称不能为DC2, 应该是DC3.  </p>
</blockquote>
<h4 id="二-_Setup_Cassandra_On_EC2">二. Setup Cassandra On EC2</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.在EC2上启动集群,由于是使用AMI,会直接启动,而默认使用的新的集群.而我们这里是要同一个集群,不同的数据中心. 所以要停掉集群并删除system文件夹.  </span><br><span class="line">  如果不是使用EC2, 这一步不需要做, 但是要手工配置使用和原数据中心一样的集群名称cluster_name.   </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.修改cassandra.yaml使用相同的cluster_name, 并设置auto_bootstrap: <span class="literal">false</span>. 这个选项的目的是启动节点时不要从其他节点同步数据到新节点.  </span><br><span class="line">  问题: seeds种子节点怎么配置? 是原数据中心的节点, 还是新数据中心的节点, 或者原数据中心+新数据中心的节点?   </span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.启动新数据中心的所有节点</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>.更新keyspace, 添加新的数据中心us-east, 使得数据可以复制/写入到新数据中心:</span><br><span class="line">  ALTER KEYSPACE <span class="string">"stream_data"</span> WITH REPLICATION = &#123; 'class' : 'NetworkTopologyStrategy', 'DC1' : <span class="number">3</span>, 'us-east' : <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>.在EC2新数据中心的所有节点重建数据, 使得原数据中心的数据都能拷贝一份数据到新数据中心上(这样后面删除原数据中心时就不会丢失数据):  </span><br><span class="line">  nodetool rebuild DC1</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>.当所有节点重建完毕, 至少将EC2数据中心的一个节点提升为种子节点. <span class="literal">promote</span> at least one <span class="keyword">node</span><span class="identifier"> </span><span class="title">in</span> the EC2 cluster to a seed <span class="keyword">node</span>.<span class="identifier">  </span><br><span class="line">  </span><span class="title">说明新数据中心之前的种子节点配置的是原数据中心的种子节点. </span><br><span class="line">  问题: 提升为种子节点, 要修改cassandra</span>.yaml配置文件, 一旦修改配置文件, 就要重启节点.    </span><br><span class="line"></span><br><span class="line">这里在第二步中没有修改关于拓扑的配置文件(比如cassandra-topology.properties)是因为使用EC2在第一步时会自动设置节点所在的DC和Rack.</span><br></pre></td></tr></table></figure>
<p>对应的线上迁移步骤:   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.修改新数据中心的cassandra.yaml使用相同的cluster_name, auto_bootstrap:false, seeds为原数据中心的节点+新数据中心的节点.</span><br><span class="line">  修改新数据中心的cassandra-rackdc.properties使用dc=DC3, rack=RAC1</span><br><span class="line">2.启动新数据的所有节点</span><br><span class="line">3.给forseti_fp添加新数据中心DC3</span><br><span class="line">  <span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> : <span class="number">3</span>, <span class="string">'DC2'</span> : <span class="number">2</span>, <span class="string">'DC3'</span> : <span class="number">3</span> &#125;;</span></span><br><span class="line">4.在新数据中心的所有节点执行nodetool rebuild DC1</span><br><span class="line">  cqlsh 192.168.6.56 </span><br><span class="line">  nodetool -h 192.168.6.56 status</span><br><span class="line">  nodetool -h 192.168.6.56 rebuild DC1</span><br><span class="line">  nodetool -h 192.168.6.57 rebuild DC1</span><br></pre></td></tr></table></figure>
<p>测试环境步骤:<br>1.2.3已经在方案2中完成了, 接着执行4:    </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span> status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">365.5</span> KB   <span class="number">256</span>     <span class="number">26.0</span>%  <span class="number">19799</span>dc0-a25b-<span class="number">46f</span>8-<span class="number">930f</span>-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.43</span> MB    <span class="number">256</span>     <span class="number">25.8</span>%  fbccd93f-<span class="number">3</span>d0d-<span class="number">4e1</span>e-<span class="number">9696</span>-d3d1f2c6d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>  <span class="number">350.49</span> KB  <span class="number">256</span>     <span class="number">22.5</span>%  a51114e7-c17f-<span class="number">48</span>c9-a72e-<span class="number">679f</span>3f3ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>  <span class="number">399.7</span> KB   <span class="number">256</span>     <span class="number">25.6</span>%  <span class="number">319e9</span>e84-d38b-<span class="number">4</span>cd5-<span class="number">898f</span>-<span class="number">8e2</span>b3661f05f  RAC1</span><br><span class="line"></span><br><span class="line">再执行两次rebuild后(可以使用-h参数指定要重建的节点,而不需要登陆到那台机器上去执行),  </span><br><span class="line">再次查看, 可以看到新数据中心的两个节点<span class="number">56</span>,<span class="number">57</span>的Load已经上升, 说明数据从DC1拷贝到了DC3.    </span><br><span class="line"></span><br><span class="line">nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span> rebuild DC1</span><br><span class="line">nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span> rebuild DC1</span><br><span class="line"></span><br><span class="line">➜  ~  nodetool -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span> status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">365.5</span> KB   <span class="number">256</span>     <span class="number">26.0</span>%  <span class="number">19799</span>dc0-a25b-<span class="number">46f</span>8-<span class="number">930f</span>-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.43</span> MB    <span class="number">256</span>     <span class="number">25.8</span>%  fbccd93f-<span class="number">3</span>d0d-<span class="number">4e1</span>e-<span class="number">9696</span>-d3d1f2c6d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>  <span class="number">1.04</span> MB    <span class="number">256</span>     <span class="number">22.5</span>%  a51114e7-c17f-<span class="number">48</span>c9-a72e-<span class="number">679f</span>3f3ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>  <span class="number">941.47</span> KB  <span class="number">256</span>     <span class="number">25.6</span>%  <span class="number">319e9</span>e84-d38b-<span class="number">4</span>cd5-<span class="number">898f</span>-<span class="number">8e2</span>b3661f05f  RAC1</span><br><span class="line"></span><br><span class="line">用 cqlsh <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span> 验证查询也是没有问题的. 对应rebuild会在新数据中心的每个节点产生数据文件:</span><br><span class="line">由于只有forseti_fp才有DC3, 所以只会同步forseti_fp数据. 不会同步forseti数据. </span><br><span class="line">[qihuang.zheng@dp0656 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">5.1</span>K <span class="number">9</span>月  <span class="number">14</span> <span class="number">09</span>:<span class="number">49</span> forseti_fp-historical_prices-jb-<span class="number">1</span>-Data.db</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">615</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">14</span>:<span class="number">50</span> forseti_fp-historical_prices-jb-<span class="number">2</span>-Data.db</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">5.1</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">14</span>:<span class="number">50</span> forseti_fp-historical_prices-jb-<span class="number">3</span>-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0657 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">9.9</span>K <span class="number">9</span>月  <span class="number">14</span> <span class="number">09</span>:<span class="number">49</span> forseti_fp-historical_prices-jb-<span class="number">1</span>-Data.db</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">9.9</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">14</span>:<span class="number">50</span> forseti_fp-historical_prices-jb-<span class="number">2</span>-Data.db</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">433</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">14</span>:<span class="number">50</span> forseti_fp-historical_prices-jb-<span class="number">3</span>-Data.db</span><br></pre></td></tr></table></figure>
<p>和EC2不同的步骤有:<br>第一步手动修改cassandra-rackdc.properties的数据中心为DC3. 并且seeds种子节点添加了新数据中心的节点.<br>所以在重建完毕后, 并不需要提升新数据中心的节点为种子节点.   </p>
<blockquote>
<p>注意: 重建会根据原数据中心节点的数据规模耗费的时间不等. 实际运用中要等到完全重建后, 才能做下面的步骤.<br>怎么确认已经重建完毕? 查看新数据中心的Load没有继续上升? 不对, 因为forseti_fp已经设置了DC3,<br>而线上数据会不停地写入, 即使没有进行rebuild操作, DC3节点的Load也会一直上升的.  </p>
</blockquote>
<h4 id="三-_Decommission_The_Old_DC_And_Cleanup">三. Decommission The Old DC And Cleanup</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>Decommission the seed node(s) 退役(原数据中心的)种子节点</span><br><span class="line">  Remove the IPs of nodes <span class="keyword">in</span> the seed <span class="built_in">list</span> that are <span class="keyword">in</span> DC1 <span class="subst">and</span> run a rolling restart<span class="built_in">.</span><br><span class="line">  </span>在(新数据中心的每个配置文件中)种子节点列表中移除属于DC1的IP, 并依次重启(新数据中心的)每个节点<span class="built_in">. </span><br><span class="line">  </span>注意现在是在新数据中心了, 所以修改的是新数据中心每个节点的配置文件<span class="built_in">. </span>因为最终要弃用原数据中心, 所以原数据中心的种子节点就不能被使用的<span class="built_in">.  </span><br><span class="line">  </span>原数据中心的配置文件不需要更改, 因为最终原数据中心节点不用了, 即使修改了也起不到任何作用<span class="built_in">. </span>想下,节点都下线了,再修改配置文件肯定没有意义<span class="built_in">.  </span><br><span class="line"></span><br><span class="line"></span><span class="number">2.</span>更新客户端连接设置为: DCAwareRoundRobinPolicy, 设置<span class="built_in">local</span> <span class="built_in">data</span> center为us<span class="attribute">-east</span><span class="built_in">.</span><br><span class="line">  </span>这一步和一中一样, 不过变化的是<span class="built_in">local</span> <span class="built_in">data</span> center从DC1修改为了us<span class="attribute">-east</span><span class="built_in">. </span><br><span class="line">  </span>因为我们的目的是用新数据中心us<span class="attribute">-east</span>替换掉原数据中心DC1<span class="built_in">. </span>所以客户端不能连接被替换掉的原数据中心DC1<span class="built_in">.</span><br><span class="line"></span><br><span class="line"></span><span class="number">3.</span>Decommission the old <span class="built_in">data</span> center 退役原数据中心</span><br><span class="line">  参考: http:<span class="comment">//docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_decomission_dc_t.html</span></span><br><span class="line">    <span class="number">1</span>) Make sure no clients are still writing <span class="keyword">to</span> any nodes <span class="keyword">in</span> the <span class="built_in">data</span> center<span class="built_in">. </span>确保没有客户端还往这个原数据中心写数据<span class="built_in">. </span><br><span class="line">    </span><span class="number">2</span>) Run a <span class="literal">full</span> repair <span class="keyword">with</span> nodetool repair<span class="built_in">. </span>在原数据中心的每个节点执行修复命令, 将即将退役的数据中心的数据传播到其他节点(其他数据中心)</span><br><span class="line">       This ensures that <span class="literal">all</span> <span class="built_in">data</span> is propagated(传播) from the <span class="built_in">data</span> center being decommissioned<span class="built_in">.</span><br><span class="line">    </span><span class="number">3</span>) Change <span class="literal">all</span> keyspaces so they no longer reference the <span class="built_in">data</span> center being removed<span class="built_in">. </span>修改ks不再执行这个原数据中心<span class="built_in">.</span><br><span class="line">    </span><span class="number">4</span>) Run nodetool decommission <span class="keyword">on</span> every node <span class="keyword">in</span> the <span class="built_in">data</span> center being removed<span class="built_in">. </span>在每个节点执行decommission来移除节点</span><br><span class="line">  注意应该先修复, 最后停止节点<span class="built_in">. </span>如果停止节点了, 就无法执行修复命令<span class="subst">!</span>  </span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>确保完全修复后(即上面的步骤<span class="number">3.2</span>), 更新ks: 将原数据中心从中移除(即上面的步骤<span class="number">3.3</span>)<span class="built_in">. </span><br><span class="line">  </span>Make sure that you update your keyspace <span class="keyword">to</span> stop replicating <span class="keyword">to</span> the old datacenter after you run the <span class="literal">full</span> repair<span class="built_in">.</span><br><span class="line">  </span>比如DC1被完全修复后,并被退役了, 则数据将不会写入到DC1, 现在数据将只会写入到新数据中心us<span class="attribute">-east</span>:  </span><br><span class="line">  ALTER KEYSPACE <span class="string">"stream_data"</span> <span class="keyword">WITH</span> REPLICATION = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'us-east'</span> : <span class="number">3</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>对应的线上迁移步骤:  </p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修改新数据中心的每个节点配置文件中的种子节点, 把属于原数据中心的种子都去掉, 并依次重启新数据中心的每个节点.</span><br><span class="line"><span class="number">2.</span>由于我们这里还要保留原数据中心用于<span class="atom">forseti</span>, 所以不需要做退役操作. 但是<span class="atom">repair</span>操作要不要做?</span><br><span class="line"><span class="number">3.</span>修改<span class="atom">forseti_fp</span>把<span class="name">DC1</span>删除掉: </span><br><span class="line">  <span class="name">ALTER</span> <span class="name">KEYSPACE</span> <span class="atom">forseti_fp</span> <span class="name">WITH</span> <span class="name">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC2'</span> : <span class="number">1</span>, <span class="string">'DC3'</span> : <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">&gt;<span class="number">1.</span>去掉种子节点是否是必要的?</span><br><span class="line"></span><br><span class="line">使用<span class="atom">cqlsh</span>连接<span class="number">52</span>,<span class="number">56</span>查询也都没有问题.</span><br></pre></td></tr></table></figure>
<h4 id="验证数据写入">验证数据写入</h4><p>验证forseti_fp新数据只会写入到新数据中心中: </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">sstableloader -d <span class="number">192.168.6.52</span> ~/github/cassandra-bulkload-example/data_<span class="number">20150915</span>/forseti/historical_prices</span><br><span class="line">Streaming relevant part of /Users/zhengqh/github/cassandra-bulkload-example/data_<span class="number">20150915</span>/forseti/historical_prices/quote-historical_prices-jb-1-Data.db to [/<span class="number">192.168.6.52</span>, /<span class="number">192.168.6.53</span>]</span><br><span class="line">Streaming session ID: 9e0be<span class="number">7b0-5b80</span>-<span class="number">11e5-8d8</span>a-e3b1dd01ca85</span><br><span class="line">progress: [/<span class="number">192.168.6.52</span> 1/1 (100%)] [/<span class="number">192.168.6.53</span> 1/1 (100%)] [total: 100% - 0MB/s (avg: 0MB/s)]%</span><br><span class="line"></span><br><span class="line">sstableloader -d <span class="number">192.168.6.52</span> ~/github/cassandra-bulkload-example/data_<span class="number">20150915</span>/forseti_fp/historical_prices</span><br><span class="line">Streaming relevant part of /Users/zhengqh/github/cassandra-bulkload-example/data_<span class="number">20150915</span>/forseti_fp/historical_prices/quote-historical_prices-jb-1-Data.db to [/<span class="number">192.168.6.56</span>, /<span class="number">192.168.6.57</span>]</span><br><span class="line">Streaming session ID: c<span class="number">2f53720-5</span>b80-11e5-af1a-e3b1dd01ca85</span><br><span class="line">progress: [/<span class="number">192.168.6.56</span> 1/1 (100%)] [/<span class="number">192.168.6.57</span> 1/1 (100%)] [total: 100% - 0MB/s (avg: 0MB/s)]%</span><br><span class="line"></span><br><span class="line">实际上可以从上面的Streaming relevant part of ...  to []可以看出数据文件写到哪几个节点上. </span><br><span class="line">由于forseti使用DC1,DC2, 所以写到了DC1的52,53. 由于forseti_fp使用了DC2,DC3, 所以写到了DC3的56,57.  </span><br><span class="line">这里-d参数仍然是<span class="number">192.168.6.52</span>是因为对于同一个集群而言, 只要指定一个节点就可以, 52节点相当于Coordinator,并不一定是数据真正写入的节点.  </span><br><span class="line"></span><br><span class="line">导入新数据之前:  </span><br><span class="line">➜  ✗ nodetool -h <span class="number">192.168.6.52</span> status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.52</span>  482.2 KB   256     26.0%  19799dc0-a25b-<span class="number">46f8-930</span>f-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.53</span>  2.45 MB    256     25.8%  fbccd93f-3d0d-4e1e-9696-d<span class="number">3d1f2c6</span>d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.56</span>  875.39 KB  256     22.5%  a<span class="number">51114e7</span>-c17f-48c9-a72e-<span class="number">679f3f3</span>ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.57</span>  716.34 KB  256     25.6%  <span class="number">319e9e84</span>-d38b-4cd5-898f-<span class="number">8e2b3661</span>f05f  RAC1</span><br><span class="line"></span><br><span class="line">导入新数据之后:  </span><br><span class="line">➜  ✗ nodetool -h <span class="number">192.168.6.52</span> status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.52</span>  487.52 KB  256     26.0%  19799dc0-a25b-<span class="number">46f8-930</span>f-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.53</span>  2.45 MB    256     25.8%  fbccd93f-3d0d-4e1e-9696-d<span class="number">3d1f2c6</span>d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.6.56</span>  880.53 KB  256     22.5%  a<span class="number">51114e7</span>-c17f-48c9-a72e-<span class="number">679f3f3</span>ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168.6.57</span>  716.34 KB  256     25.6%  <span class="number">319e9e84</span>-d38b-4cd5-898f-<span class="number">8e2b3661</span>f05f  RAC1</span><br><span class="line"></span><br><span class="line">查询新数据: </span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices where ticker='ORCL' and date&gt;='<span class="number">2015-09-11</span> <span class="number">00:00:00+08</span>00' <span class="comment">;</span></span><br><span class="line"> ticker | date                     | adj_close | close     | high      | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-----------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015-09-14</span> <span class="number">00:00:00+08</span>00 | <span class="number">37.560001</span> | <span class="number">37.560001</span> | <span class="number">37.939999</span> | <span class="number">37.369999</span> | <span class="number">37.810001</span> | <span class="number">14956500</span></span><br><span class="line">   ORCL | <span class="number">2015-09-11</span> <span class="number">00:00:00+08</span>00 | <span class="number">37.919998</span> | <span class="number">37.919998</span> | <span class="number">37.959999</span> | <span class="number">37.400002</span> | <span class="number">37.450001</span> | <span class="number">12928400</span></span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where ticker='ORCL' and date&gt;='<span class="number">2015-09-11</span> <span class="number">00:00:00+08</span>00' <span class="comment">;</span></span><br><span class="line"> ticker | date                     | adj_close | close     | high      | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-----------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015-09-14</span> <span class="number">00:00:00+08</span>00 | <span class="number">37.560001</span> | <span class="number">37.560001</span> | <span class="number">37.939999</span> | <span class="number">37.369999</span> | <span class="number">37.810001</span> | <span class="number">14956500</span></span><br><span class="line">   ORCL | <span class="number">2015-09-11</span> <span class="number">00:00:00+08</span>00 | <span class="number">37.919998</span> | <span class="number">37.919998</span> | <span class="number">37.959999</span> | <span class="number">37.400002</span> | <span class="number">37.450001</span> | <span class="number">12928400</span></span><br><span class="line"></span><br><span class="line">cqlsh&gt; select count(*) from forseti_fp.historical_prices where ticker='ORCL'<span class="comment">;   //7436  </span></span><br><span class="line">cqlsh&gt; select count(*) from forseti.historical_prices where ticker='GOOG'<span class="comment">;      //366</span></span><br><span class="line">cqlsh&gt; select count(*) from forseti.historical_prices where ticker='YHOO'<span class="comment">;      //4885</span></span><br></pre></td></tr></table></figure>
<h4 id="验证数据查询">验证数据查询</h4><p>验证查询forseti_fp只走新数据中心, forseti只走原数据中心:  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">客户端连接原数据中心, 查询fp数据时会转发到新数据中心的节点56上去: </span><br><span class="line">➜  ~  cqlsh 192.168.6.52</span><br><span class="line">cqlsh&gt; select count(<span class="keyword">*</span>) from forseti_fp.historical_prices where ticker='ORCL';</span><br><span class="line"> activity                                                                                   |<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">--------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                         execute_cql3_query </span>|<span class="string"> 11:20:46,237 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">              0</span><br><span class="line"> Parsing select count(*) from forseti_fp.historical_prices where ticker='ORCL' LIMIT 10000; </span>|<span class="string"> 11:20:46,237 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            149</span><br><span class="line">                                                                        Preparing statement </span>|<span class="string"> 11:20:46,237 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            392</span><br><span class="line">                                                           Sending message to /192.168.6.56 </span>|<span class="string"> 11:20:46,238 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">           1027</span><br><span class="line">                                                        Message received from /192.168.6.52 </span>|<span class="string"> 11:20:46,268 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">            150</span><br><span class="line">                                      Executing single-partition query on historical_prices </span>|<span class="string"> 11:20:46,271 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3155</span><br><span class="line">                                                               Acquiring sstable references </span>|<span class="string"> 11:20:46,271 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3196</span><br><span class="line">                                                                Merging memtable tombstones </span>|<span class="string"> 11:20:46,271 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3319</span><br><span class="line">                                                                Key cache hit for sstable 6 </span>|<span class="string"> 11:20:46,271 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3557</span><br><span class="line">                                                Seeking to partition beginning in data file </span>|<span class="string"> 11:20:46,271 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3581</span><br><span class="line">                                                                Key cache hit for sstable 5 </span>|<span class="string"> 11:20:46,272 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           4395</span><br><span class="line">                                                Seeking to partition beginning in data file </span>|<span class="string"> 11:20:46,272 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           4416</span><br><span class="line">                  Skipped 0/2 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 11:20:46,273 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           5026</span><br><span class="line">                                                 Merging data from memtables and 2 sstables </span>|<span class="string"> 11:20:46,273 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           5058</span><br><span class="line">                                                       Read 7436 live and 0 tombstone cells </span>|<span class="string"> 11:20:46,363 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">          95832</span><br><span class="line">                                                        Enqueuing response to /192.168.6.52 </span>|<span class="string"> 11:20:46,364 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">          96406</span><br><span class="line">                                                           Sending message to /192.168.6.52 </span>|<span class="string"> 11:20:46,364 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">          96870</span><br><span class="line">                                                        Message received from /192.168.6.56 </span>|<span class="string"> 11:20:46,459 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         222965</span><br><span class="line">                                                     Processing response from /192.168.6.56 </span>|<span class="string"> 11:20:46,460 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         223617</span><br><span class="line">                                                                           Request complete </span>|<span class="string"> 11:20:46,525 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         288656</span><br><span class="line"></span><br><span class="line">客户端连接新数据中心, 因为fp就在新数据中心上, 所以直接请求新数据中心的节点56: </span><br><span class="line">➜  ~  cqlsh 192.168.6.56</span><br><span class="line">cqlsh&gt; select count(*) from forseti_fp.historical_prices where ticker='ORCL';</span><br><span class="line"> activity                                                                                   </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">--------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                         execute_cql3_query </span>|<span class="string"> 11:21:02,659 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">              0</span><br><span class="line"> Parsing select count(*) from forseti_fp.historical_prices where ticker='ORCL' LIMIT 10000; </span>|<span class="string"> 11:21:02,660 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           1295</span><br><span class="line">                                                                        Preparing statement </span>|<span class="string"> 11:21:02,661 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           1511</span><br><span class="line">                                      Executing single-partition query on historical_prices </span>|<span class="string"> 11:21:02,662 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3317</span><br><span class="line">                                                               Acquiring sstable references </span>|<span class="string"> 11:21:02,662 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3353</span><br><span class="line">                                                                Merging memtable tombstones </span>|<span class="string"> 11:21:02,663 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3513</span><br><span class="line">                                                                Key cache hit for sstable 6 </span>|<span class="string"> 11:21:02,663 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3782</span><br><span class="line">                                                Seeking to partition beginning in data file </span>|<span class="string"> 11:21:02,663 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           3806</span><br><span class="line">                                                                Key cache hit for sstable 5 </span>|<span class="string"> 11:21:02,664 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           4545</span><br><span class="line">                                                Seeking to partition beginning in data file </span>|<span class="string"> 11:21:02,664 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           4566</span><br><span class="line">                  Skipped 0/2 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 11:21:02,664 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           5072</span><br><span class="line">                                                 Merging data from memtables and 2 sstables </span>|<span class="string"> 11:21:02,664 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           5103</span><br><span class="line">                                                       Read 7436 live and 0 tombstone cells </span>|<span class="string"> 11:21:02,795 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">         135736</span><br><span class="line">                                                                           Request complete </span>|<span class="string"> 11:21:02,899 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">         240075</span><br><span class="line"></span><br><span class="line">同理, 如果查询forseti数据, 连接的是新数据中心, 则会转发到原数据中心的节点:</span><br><span class="line">cqlsh&gt; select count(*) from forseti.historical_prices where ticker='ORCL';</span><br><span class="line"> activity                                                                                </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">-----------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                      execute_cql3_query </span>|<span class="string"> 11:24:56,519 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">              0</span><br><span class="line">                                                     Message received from /192.168.6.56 </span>|<span class="string"> 11:24:56,502 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">             79</span><br><span class="line">                                   Executing single-partition query on historical_prices </span>|<span class="string"> 11:24:56,503 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            762</span><br><span class="line">                                                            Acquiring sstable references </span>|<span class="string"> 11:24:56,503 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            819</span><br><span class="line">                                                             Merging memtable tombstones </span>|<span class="string"> 11:24:56,503 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            906</span><br><span class="line">                                                             Key cache hit for sstable 3 </span>|<span class="string"> 11:24:56,503 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1052</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:24:56,503 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1067</span><br><span class="line">                                                             Key cache hit for sstable 2 </span>|<span class="string"> 11:24:56,504 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1732</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:24:56,504 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1748</span><br><span class="line">                                                             Key cache hit for sstable 1 </span>|<span class="string"> 11:24:56,505 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2206</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:24:56,505 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2221</span><br><span class="line">               Skipped 0/3 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 11:24:56,505 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2655</span><br><span class="line">                                              Merging data from memtables and 3 sstables </span>|<span class="string"> 11:24:56,505 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2678</span><br><span class="line"> Parsing select count(*) from forseti.historical_prices where ticker='ORCL' LIMIT 10000; </span>|<span class="string"> 11:24:56,519 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">            105</span><br><span class="line">                                                                     Preparing statement </span>|<span class="string"> 11:24:56,519 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">            293</span><br><span class="line">                                                        Sending message to /192.168.6.53 </span>|<span class="string"> 11:24:56,520 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">           1096</span><br><span class="line">                                                    Read 7436 live and 0 tombstone cells </span>|<span class="string"> 11:24:56,580 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          77576</span><br><span class="line">                                                     Enqueuing response to /192.168.6.56 </span>|<span class="string"> 11:24:56,580 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          78028</span><br><span class="line">                                                        Sending message to /192.168.6.56 </span>|<span class="string"> 11:24:56,581 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          78378</span><br><span class="line">                                                     Message received from /192.168.6.53 </span>|<span class="string"> 11:24:56,746 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">         227145</span><br><span class="line">                                                  Processing response from /192.168.6.53 </span>|<span class="string"> 11:24:56,747 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">         228679</span><br><span class="line">                                                                        Request complete </span>|<span class="string"> 11:24:56,824 </span>|<span class="string"> 192.168.6.56 </span>|<span class="string">         305246</span><br><span class="line"></span><br><span class="line">查询forseti, 连接的是原数据中心, 由于ORCL的数据在53上, 所以会转发到相同数据中心的53节点(当然如果没有条件的count会连接两个节点查询全部数据). </span><br><span class="line">➜  ~  cqlsh 192.168.6.52</span><br><span class="line">cqlsh&gt; select count(*) from forseti.historical_prices where ticker='ORCL';</span><br><span class="line"> activity                                                                                </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">-----------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                      execute_cql3_query </span>|<span class="string"> 11:26:02,413 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">              0</span><br><span class="line"> Parsing select count(*) from forseti.historical_prices where ticker='ORCL' LIMIT 10000; </span>|<span class="string"> 11:26:02,413 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">             88</span><br><span class="line">                                                                     Preparing statement </span>|<span class="string"> 11:26:02,414 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            247</span><br><span class="line">                                                        Sending message to /192.168.6.53 </span>|<span class="string"> 11:26:02,414 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            756</span><br><span class="line">                                                     Message received from /192.168.6.52 </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">             41</span><br><span class="line">                                   Executing single-partition query on historical_prices </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            636</span><br><span class="line">                                                            Acquiring sstable references </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            660</span><br><span class="line">                                                             Merging memtable tombstones </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            739</span><br><span class="line">                                                             Key cache hit for sstable 3 </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            881</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:26:02,420 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            896</span><br><span class="line">                                                             Key cache hit for sstable 2 </span>|<span class="string"> 11:26:02,421 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1544</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:26:02,421 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1560</span><br><span class="line">                                                             Key cache hit for sstable 1 </span>|<span class="string"> 11:26:02,422 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2038</span><br><span class="line">                                             Seeking to partition beginning in data file </span>|<span class="string"> 11:26:02,422 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2053</span><br><span class="line">               Skipped 0/3 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 11:26:02,422 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2551</span><br><span class="line">                                              Merging data from memtables and 3 sstables </span>|<span class="string"> 11:26:02,422 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2574</span><br><span class="line">                                                    Read 7436 live and 0 tombstone cells </span>|<span class="string"> 11:26:02,497 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          77697</span><br><span class="line">                                                     Enqueuing response to /192.168.6.52 </span>|<span class="string"> 11:26:02,498 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          77991</span><br><span class="line">                                                        Sending message to /192.168.6.52 </span>|<span class="string"> 11:26:02,498 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">          78127</span><br><span class="line">                                                     Message received from /192.168.6.53 </span>|<span class="string"> 11:26:02,589 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         176118</span><br><span class="line">                                                  Processing response from /192.168.6.53 </span>|<span class="string"> 11:26:02,590 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         176597</span><br><span class="line">                                                                        Request complete </span>|<span class="string"> 11:26:02,629 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         216755</span></span><br></pre></td></tr></table></figure>
<p>查看新数据文件: 52,53只有forseti, 56,57只有forseti_fp.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">[qihuang.zheng@dp0652 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">558</span> <span class="number">9</span>月  <span class="number">15</span> <span class="number">16</span>:<span class="number">06</span> forseti-historical_prices-jb-<span class="number">1</span>-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">1.1</span>M <span class="number">9</span>月  <span class="number">12</span> <span class="number">15</span>:<span class="number">02</span> forseti_fp-historical_prices-jb-<span class="number">1</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">15</span>K <span class="number">9</span>月  <span class="number">14</span> <span class="number">09</span>:<span class="number">49</span> forseti_fp-historical_prices-jb-<span class="number">2</span>-Data.db</span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">1.1</span>M <span class="number">9</span>月  <span class="number">12</span> <span class="number">15</span>:<span class="number">02</span> forseti-historical_prices-jb-<span class="number">1</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">15</span>K <span class="number">9</span>月  <span class="number">14</span> <span class="number">09</span>:<span class="number">43</span> forseti-historical_prices-jb-<span class="number">2</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">396</span> <span class="number">9</span>月  <span class="number">15</span> <span class="number">16</span>:<span class="number">06</span> forseti-historical_prices-jb-<span class="number">3</span>-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0656 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/ -h | grep Data</span><br><span class="line">[qihuang.zheng@dp0656 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">621</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">15</span>:<span class="number">35</span> forseti_fp-historical_prices-jb-<span class="number">5</span>-Data.db</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin  <span class="number">399</span> <span class="number">9</span>月  <span class="number">15</span> <span class="number">16</span>:<span class="number">07</span> forseti_fp-historical_prices-jb-<span class="number">6</span>-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0657 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/ -h | grep Data</span><br><span class="line">[qihuang.zheng@dp0657 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h | grep Data</span><br><span class="line">-rw-r--r-- <span class="number">1</span> admin admin <span class="number">444</span>K <span class="number">9</span>月  <span class="number">15</span> <span class="number">16</span>:<span class="number">07</span> forseti_fp-historical_prices-jb-<span class="number">5</span>-Data.db</span><br></pre></td></tr></table></figure>
<p>注意到上面53中的forseti_fp是最开始的数据, 实际情况中原数据中心的各个节点都有可能有forseti_fp数据.<br>所以现在要清理原数据中心的forseti_fp数据, 因为这部分数据已经通过rebuild在新数据中心中都有备份了.<br>怎么清理文件: 使用nodetool cleanup forseti_fp命令貌似并不会删除掉文件, 直接删除文件.  </p>
<h3 id="沙盒环境测试">沙盒环境测试</h3><p>沙盒环境是单机的Cassandra. 它的主要配置信息如下:  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cassandra.yaml</span><br><span class="line">- <span class="symbol">seeds:</span> <span class="string">"127.0.0.1"</span></span><br><span class="line"><span class="symbol">endpoint_snitch:</span> <span class="constant">PropertyFileSnitch</span></span><br><span class="line"><span class="symbol">cluster_name:</span> <span class="string">'Test Cluster'</span></span><br><span class="line"><span class="symbol">data_file_directories:</span></span><br><span class="line">    - <span class="regexp">/var/lib</span><span class="regexp">/cassandra/data</span></span><br><span class="line"><span class="symbol">commitlog_directory:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">commitlog</span></span></span><br><span class="line"><span class="symbol">saved_caches_directory:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">saved_caches</span></span></span><br><span class="line"><span class="symbol">listen_address:</span> <span class="number">192.168</span>.<span class="number">47.12</span></span><br><span class="line"><span class="symbol">rpc_address:</span> <span class="number">192.168</span>.<span class="number">47.12</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>cassandra-topology.properties</span><br><span class="line"><span class="number">192.168</span>.<span class="number">47.12</span>=<span class="constant">DC1</span>:<span class="constant">RAC1</span></span><br></pre></td></tr></table></figure>
<p>修改为使用GossipingPropertyFileSnitch:  </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">-</span> <span class="tag">seeds</span>: "192<span class="class">.168</span><span class="class">.47</span><span class="class">.12</span>"</span><br><span class="line"><span class="tag">endpoint_snitch</span>: <span class="tag">GossipingPropertyFileSnitch</span></span><br></pre></td></tr></table></figure>
<p>重启节点(这里使用的是root用户):  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo jps | <span class="keyword">grep</span> CassandraDaemon |awk <span class="string">'&#123;print $1&#125;'</span> | xargs sudo kill -<span class="number">9</span></span><br><span class="line">sudo <span class="regexp">/usr/i</span>nstall<span class="regexp">/cassandra/</span>bin<span class="regexp">/cassandra</span></span><br></pre></td></tr></table></figure>
<p>重启后, 修改forseti_fp的策略为NetworkTopologyStrategy, 并使用DC1, 由于只有一个节点,所以副本数=1:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'SimpleStrategy'</span>,</span><br><span class="line">  <span class="string">'replication_factor'</span>: <span class="string">'1'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> : <span class="number">1</span> &#125;;</span></span><br></pre></td></tr></table></figure>
<p>假设我们要把沙盒的Cassandra迁移到47.229上.  而229之前已经在测试库测试过了,拷贝一份配置, 后面迁移正式库时换回来.<br>由于/home/admin/cassandra用于正式库的, 所以新建一个数据目录和提交日志目录用于沙盒环境的测试:<br>注意这里的种子节点是沙盒环境的12以及自身节点. 因为只迁移到一个节点上.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> conf]$ sudo -u admin cp cassandra.yaml  cassandra_product.yaml</span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> conf]$ sudo -u admin vi cassandra.yaml</span><br><span class="line"><span class="string">listen_address:</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"><span class="string">rpc_address:</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line">  - &#123;<span class="string">seeds:</span> <span class="string">'192.168.47.12,192.168.47.229'</span>&#125;</span><br><span class="line"><span class="string">endpoint_snitch:</span> GossipingPropertyFileSnitch</span><br><span class="line"><span class="string">cluster_name:</span> <span class="string">'Test Cluster'</span></span><br><span class="line"><span class="string">data_file_directories:</span> [<span class="regexp">/home/</span>admin<span class="regexp">/cassandra_sandbox/</span>data]</span><br><span class="line"><span class="string">commitlog_directory:</span> <span class="regexp">/data/</span>cassandra_sandbox/commitlog</span><br><span class="line"><span class="string">saved_caches_directory:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra_sandbox/</span>saved_caches</span><br><span class="line"><span class="string">auto_bootstrap:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">sudo mkdir <span class="regexp">/home/</span>admin<span class="regexp">/cassandra_sandbox /</span>data/cassandra_sandbox</span><br><span class="line">sudo chown -R <span class="string">admin:</span>admin <span class="regexp">/home/</span>admin<span class="regexp">/cassandra_sandbox /</span>data/cassandra_sandbox</span><br></pre></td></tr></table></figure>
<p>从原来测试留下来的集群中下线229并重启:    </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;' | xargs sudo -u admin kill -9</span><br><span class="line"></span><br><span class="line">注意这里不能直接重启, 因为229之前被用于生产环境的测试库, 需要先把229从之前的集群中下线, 否则启动时提示: 并且status看不到12节点.12也看不到229.    </span><br><span class="line">WARN <span class="number">10:17:20,26</span>1 ClusterName mismatch from /<span class="number">192.168.47.204</span> forseti_cluster!=Test Cluster</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool status -h <span class="number">192.168.47.202</span></span><br><span class="line">Datacenter: DC3</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  116.21 MB  256     7.1%   f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168.47.229</span>  236.69 MB  256     7.8%   b<span class="number">9b9e891</span>-cbe8-400d-9061-08cb56c8415d  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  205.56 MB  256     7.3%   57eb<span class="number">6f83-734</span>d-48ef-855b-e<span class="number">745001e82</span>07  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool -h <span class="number">192.168.47.202</span> removenode b<span class="number">9b9e891</span>-cbe8-400d-9061-08cb56c8415d</span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool status -h <span class="number">192.168.47.202</span></span><br><span class="line">Datacenter: DC3</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  5.87 MB    256     7.7%   f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  204.02 MB  256     7.9%   57eb<span class="number">6f83-734</span>d-48ef-855b-e<span class="number">745001e82</span>07  RAC1</span><br><span class="line"></span><br><span class="line">sudo -u admin /usr/install/cassandra/bin/cassandra</span><br></pre></td></tr></table></figure>
<p>status无法看到对方, 但229的日志中显示和12进行握手连接.   </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">INFO <span class="number">10</span>:<span class="number">25</span>:<span class="number">06</span>,<span class="number">446</span> Handshaking version with /<span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span></span><br><span class="line"></span><br><span class="line">在<span class="number">12</span>的日志上看到下面的错误: </span><br><span class="line">ERROR [MessagingService-Outgoing-<span class="regexp">/192.168.47.229] 2015-09-19 10:17:19,058 CassandraDaemon.java (line 258) Exception in thread Thread[MessagingService-Outgoing-/</span><span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>,<span class="number">5</span>,main]</span><br><span class="line">java.lang.<span class="string">RuntimeException:</span> Unknown host /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> with no <span class="keyword">default</span> configured</span><br><span class="line">  at org.apache.cassandra.locator.PropertyFileSnitch.getEndpointInfo(PropertyFileSnitch.<span class="string">java:</span><span class="number">92</span>)</span><br><span class="line">  at org.apache.cassandra.locator.PropertyFileSnitch.getDatacenter(PropertyFileSnitch.<span class="string">java:</span><span class="number">115</span>)</span><br><span class="line">  at org.apache.cassandra.locator.GossipingPropertyFileSnitch.getDatacenter(GossipingPropertyFileSnitch.<span class="string">java:</span><span class="number">92</span>)</span><br><span class="line">  at org.apache.cassandra.locator.DynamicEndpointSnitch.getDatacenter(DynamicEndpointSnitch.<span class="string">java:</span><span class="number">131</span>)</span><br><span class="line">  at org.apache.cassandra.net.OutboundTcpConnection.isLocalDC(OutboundTcpConnection.<span class="string">java:</span><span class="number">82</span>)</span><br><span class="line">  at org.apache.cassandra.net.OutboundTcpConnection.connect(OutboundTcpConnection.<span class="string">java:</span><span class="number">301</span>)</span><br><span class="line">  at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.<span class="string">java:</span><span class="number">150</span>)</span><br><span class="line"></span><br><span class="line">解决办法是给<span class="number">12</span>的cassandra-topology.properties添加上: <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>=<span class="string">DC3:</span>RAC1, 并重启<span class="number">12.</span>  </span><br><span class="line">[qihuang.zheng<span class="annotation">@mysql</span>047012 conf]$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/nodetool status forseti_fp</span><br><span class="line"><span class="string">Datacenter:</span> DC3</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">139.92</span> KB  <span class="number">256</span>     <span class="number">0.0</span>%              d8128782-<span class="number">8898</span>-<span class="number">48</span>f5-b1b0-<span class="number">7</span>ee09a6287b4  RAC1</span><br><span class="line"><span class="string">Datacenter:</span> DC1</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span>   <span class="number">25.58</span> GB   <span class="number">256</span>     <span class="number">100.0</span>%            <span class="number">3</span>c1897d9-<span class="number">6522</span>-<span class="number">4e3</span>a-<span class="number">8</span>deb-<span class="number">8</span>f5691d302cf  RAC1</span><br></pre></td></tr></table></figure>
<p>修改forseti_fp添加DC3, 并重建数据. 重建完毕后, 可以删除DC1.    </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> : <span class="number">1</span>, <span class="string">'DC3'</span> : <span class="number">1</span>&#125;;</span></span><br><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> <span class="keyword">rebuild</span> DC1</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC3'</span> : <span class="number">1</span>&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> forseti_fp.android_device_session <span class="keyword">limit</span> <span class="number">1</span>;</span></span><br></pre></td></tr></table></figure>
<p>上面在rebuild时和添加DC3时有个问题: 客户端现在可以连上DC1和DC3的任何一个节点. 而还没有完全同步数据之前, 只有DC1的12上有数据, DC3上的229并没有数据.<br>导致如果客户端将请求下发到229时, 会查询不到数据的. 如果是limit 1这种请求, 则一般都会返回数据, 因为只要任何一条数据. 如果是精确查询可能有问题.   </p>
<p>当修改forset_fp的策略删除DC1后, 就可以将12上的forseti_fp文件夹删除掉. 不过为了方便, 可以暂时移动到某个备份位置.  </p>
<p>同步rebuild的时候发生了什么: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@mysql047012 conf]$ /usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">status</span> forseti_fp</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">7.41</span> GB    <span class="number">256</span>     <span class="number">100.0</span>%            d8128782-<span class="number">8898</span>-<span class="number">48</span>f5-b1b0-<span class="number">7</span>ee09a6287b4  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span>   <span class="number">25.58</span> GB   <span class="number">256</span>     <span class="number">100.0</span>%            <span class="number">3</span>c1897d9-<span class="number">6522</span>-<span class="number">4e3</span>a-<span class="number">8</span>deb-<span class="number">8</span>f5691d302cf  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@mysql047012 conf]$ /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool netstats</span><br><span class="line"><span class="keyword">Mode</span>: <span class="keyword">NORMAL</span></span><br><span class="line"><span class="keyword">Rebuild</span> f9ae14d0-<span class="number">5e78</span>-<span class="number">11e5</span>-<span class="number">9</span>c0f-af42c3e536e5</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line">        Sending <span class="number">104</span> files, <span class="number">16171377236</span> <span class="keyword">bytes</span> total</span><br><span class="line">            /<span class="keyword">var</span>/lib/cassandra/<span class="keyword">data</span>/forseti_fp/android_device_session/forseti_fp-android_device_session-jb-<span class="number">199</span>-<span class="keyword">Data</span>.db <span class="number">167774995</span>/<span class="number">167774995</span> <span class="keyword">bytes</span>(<span class="number">100</span>%) sent <span class="keyword">to</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line">            /<span class="keyword">var</span>/lib/cassandra/<span class="keyword">data</span>/forseti_fp/android_device_session/forseti_fp-android_device_session-jb-<span class="number">197</span>-<span class="keyword">Data</span>.db <span class="number">167784338</span>/<span class="number">167784338</span> <span class="keyword">bytes</span>(<span class="number">100</span>%) sent <span class="keyword">to</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> conf]$ /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool netstats</span><br><span class="line"><span class="keyword">Mode</span>: <span class="keyword">NORMAL</span></span><br><span class="line"><span class="keyword">Rebuild</span> f9ae14d0-<span class="number">5e78</span>-<span class="number">11e5</span>-<span class="number">9</span>c0f-af42c3e536e5</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span></span><br><span class="line">        Receiving <span class="number">104</span> files, <span class="number">16171377236</span> <span class="keyword">bytes</span> total</span><br><span class="line">            /home/<span class="keyword">admin</span>/cassandra_sandbox/<span class="keyword">data</span>/forseti_fp/tcp_stack_ua/forseti_fp-tcp_stack_ua-tmp-jb-<span class="number">1</span>-<span class="keyword">Data</span>.db <span class="number">4508331</span>/<span class="number">20036222</span> <span class="keyword">bytes</span>(<span class="number">22</span>%) received <span class="keyword">from</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span></span><br><span class="line">            /home/<span class="keyword">admin</span>/cassandra_sandbox/<span class="keyword">data</span>/forseti_fp/android_device_index/forseti_fp-android_device_index-tmp-jb-<span class="number">1</span>-<span class="keyword">Data</span>.db <span class="number">84066</span>/<span class="number">84066</span> <span class="keyword">bytes</span>(<span class="number">100</span>%) received <span class="keyword">from</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">rebuild</span>完毕: </span><br><span class="line">[qihuang.zheng@mysql047012 device_session]$ /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool netstats</span><br><span class="line"><span class="keyword">Mode</span>: <span class="keyword">NORMAL</span></span><br><span class="line"><span class="keyword">Not</span> sending <span class="keyword">any</span> streams.</span><br><span class="line"><span class="keyword">Read</span> <span class="keyword">Repair</span> <span class="keyword">Statistics</span>:</span><br><span class="line">Attempted: <span class="number">129</span></span><br><span class="line">Mismatch (Blocking): <span class="number">0</span></span><br><span class="line">Mismatch (Background): <span class="number">6</span></span><br><span class="line">Pool <span class="keyword">Name</span>                    Active   Pending      Completed</span><br><span class="line">Commands                        <span class="keyword">n</span>/a         <span class="number">0</span>           <span class="number">5980</span></span><br><span class="line">Responses                       <span class="keyword">n</span>/a         <span class="number">0</span>          <span class="number">15758</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> forseti_fp]$ /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">status</span>  forseti_fp</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">15.75</span> GB   <span class="number">256</span>     <span class="number">100.0</span>%            d8128782-<span class="number">8898</span>-<span class="number">48</span>f5-b1b0-<span class="number">7</span>ee09a6287b4  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span>   <span class="number">25.58</span> GB   <span class="number">256</span>     <span class="number">100.0</span>%            <span class="number">3</span>c1897d9-<span class="number">6522</span>-<span class="number">4e3</span>a-<span class="number">8</span>deb-<span class="number">8</span>f5691d302cf  RAC1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这里看到forseti_fp的<span class="keyword">Load</span>有点不一样, 通过du <span class="comment">--max-depth=1 . 定位到是到device_session文件夹少了. 发现是12中多了一个无关的文件.  </span></span><br><span class="line">-rw<span class="comment">-------. 1 root root 5.0G 2月   6 2015 java_pid31235.hprof</span></span><br><span class="line"></span><br><span class="line">现在查看forseti_fp的状态, 数据只分布在DC3上.  </span><br><span class="line">[qihuang.zheng@mysql047012 <span class="keyword">data</span>]$ /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">status</span>  forseti_fp</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">15.75</span> GB   <span class="number">256</span>     <span class="number">100.0</span>%            d8128782-<span class="number">8898</span>-<span class="number">48</span>f5-b1b0-<span class="number">7</span>ee09a6287b4  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line"><span class="comment">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.12</span>   <span class="number">25.58</span> GB   <span class="number">256</span>     <span class="number">0.0</span>%              <span class="number">3</span>c1897d9-<span class="number">6522</span>-<span class="number">4e3</span>a-<span class="number">8</span>deb-<span class="number">8</span>f5691d302cf  RAC1</span></span><br></pre></td></tr></table></figure>
<p>在切回原来集群状态时遇到一个问题:  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">现在forseti_fp的策略是: </span><br><span class="line">ALTER KEYSPACE forseti_fp WITH REPLICATION = &#123; 'class' : 'NetworkTopologyStrategy', 'DC3' : 1&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">要改回原来的DC1, 先改为DC1和DC3</span><br><span class="line">ALTER KEYSPACE forseti_fp WITH REPLICATION = &#123; 'class' : 'NetworkTopologyStrategy', 'DC1' : 1, 'DC3' : 1&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">但是上面的指令如果连接229, 会很快执行完, 但是一开始连接的是12, 一直没有反应. 并且连接不同节点, 状态的Own也不一样.  </span><br><span class="line">可以看到因为在229上alter成功了,所以现在数据100%分布在DC1和DC3上. 但是在12上没有执行成功,所以DC1为0%.  </span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool -h <span class="number">192.168.47.12</span> status forseti_fp</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.229</span>  15.78 GB   256     100.0%            d<span class="number">8128782-88</span>98-48f5-b1b0-7ee<span class="number">09a6287b4</span>  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.12</span>   25.58 GB   256     0.0%              <span class="number">3c1897d9</span>-<span class="number">6522-4e3</span>a-8deb-<span class="number">8f5691d30</span>2cf  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool -h <span class="number">192.168.47.229</span> status forseti_fp</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.229</span>  15.78 GB   256     100.0%            d<span class="number">8128782-88</span>98-48f5-b1b0-7ee<span class="number">09a6287b4</span>  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address         Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.12</span>   25.58 GB   256     100.0%            <span class="number">3c1897d9</span>-<span class="number">6522-4e3</span>a-8deb-<span class="number">8f5691d30</span>2cf  RAC1</span><br><span class="line"></span><br><span class="line">解决办法是重启12, 这时连接12查看forseti_fp的策略修改成了DC1,DC3.</span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/cqlsh <span class="number">192.168.47.12</span> -e "desc keyspace forseti_fp<span class="comment">;" | head</span></span><br><span class="line">CREATE KEYSPACE forseti_fp WITH replication = &#123;</span><br><span class="line">  'class': 'NetworkTopologyStrategy',</span><br><span class="line">  'DC3': '1',</span><br><span class="line">  'DC1': '1'</span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">再次修改成只有DC1. 这样就和一开始的环境一样了, 因为229这个节点要用于正式环境.  </span><br><span class="line">ALTER KEYSPACE forseti_fp WITH REPLICATION = &#123; 'class' : 'NetworkTopologyStrategy', 'DC1' : 1&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">验证现在的查询都是走12节点:  </span><br><span class="line">cqlsh&gt; select * from forseti_fp.android_device_session limit 1<span class="comment">;</span></span><br><span class="line"> activity                                                                                         | timestamp    | source        | source_elapsed</span><br><span class="line">--------------------------------------------------------------------------------------------------+--------------+---------------+----------------</span><br><span class="line">                                                                               execute_cql3_query | <span class="number">11:04:42,65</span>5 | <span class="number">192.168.47.12</span> |              0</span><br><span class="line">                                 Parsing select * from forseti_fp.android_device_session limit 1<span class="comment">; | 11:04:42,655 | 192.168.47.12 |            102</span></span><br><span class="line">                                                                              Preparing statement | <span class="number">11:04:42,65</span>5 | <span class="number">192.168.47.12</span> |            234</span><br><span class="line">                                                                    Determining replicas to query | <span class="number">11:04:42,65</span>6 | <span class="number">192.168.47.12</span> |            434</span><br><span class="line"> Executing seq scan across 18 sstables for [min(-<span class="number">922337203685</span><span class="number">4775808</span>), min(-<span class="number">922337203685</span><span class="number">4775808</span>)] | <span class="number">11:04:42,70</span>0 | <span class="number">192.168.47.12</span> |          45074</span><br><span class="line">                                                      Seeking to partition beginning in data file | <span class="number">11:04:42,71</span>6 | <span class="number">192.168.47.12</span> |          61098</span><br><span class="line">                                                                Read 1 live and 0 tombstone cells | <span class="number">11:04:42,71</span>7 | <span class="number">192.168.47.12</span> |          61539</span><br><span class="line">                                                      Seeking to partition beginning in data file | <span class="number">11:04:42,71</span>7 | <span class="number">192.168.47.12</span> |          61596</span><br><span class="line">                                                                Read 1 live and 0 tombstone cells | <span class="number">11:04:42,71</span>7 | <span class="number">192.168.47.12</span> |          61643</span><br><span class="line">                                                                     Scanned 1 rows and matched 1 | <span class="number">11:04:42,71</span>7 | <span class="number">192.168.47.12</span> |          61980</span><br><span class="line">                                                                                 Request complete | <span class="number">11:04:42,71</span>7 | <span class="number">192.168.47.12</span> |          62365</span><br><span class="line"></span><br><span class="line">现在可以停掉229, 并在12上将229下线, 这样229就可以用于接下来的生产环境.  </span><br><span class="line">[qihuang.zheng@fd047022 ~]$ /usr/install/cassandra/bin/nodetool -h <span class="number">192.168.47.12</span> status forseti_fp</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address        Load       Tokens  Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.12</span>  25.59 GB   256     100.0%            <span class="number">3c1897d9</span>-<span class="number">6522-4e3</span>a-8deb-<span class="number">8f5691d30</span>2cf  RAC1</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/">Cassandra数据迁移3 多数据中心数据迁移</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年08月28日 - 00时00分</p>
  <p><span>最后更新:</span>2015年12月19日 - 16时39分</p>
  <p>
    <span>原始链接:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/" title="Cassandra数据迁移3 多数据中心数据迁移">http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/">
        Cassandra数据迁移1 新集群sstableloader
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/">
        Apache Cassandra架构理解
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#线下测试方案2:_DC1,_DC3"><span class="toc-number">1.</span> <span class="toc-text">线下测试方案2: DC1, DC3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#模拟新数据写入"><span class="toc-number">1.1.</span> <span class="toc-text">模拟新数据写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据从原DC同步到新DC"><span class="toc-number">1.2.</span> <span class="toc-text">数据从原DC同步到新DC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一-_Cassandra_Multi_DC_Support:"><span class="toc-number">1.2.1.</span> <span class="toc-text">一. Cassandra Multi DC Support:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二-_Setup_Cassandra_On_EC2"><span class="toc-number">1.2.2.</span> <span class="toc-text">二. Setup Cassandra On EC2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三-_Decommission_The_Old_DC_And_Cleanup"><span class="toc-number">1.2.3.</span> <span class="toc-text">三. Decommission The Old DC And Cleanup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#验证数据写入"><span class="toc-number">1.2.4.</span> <span class="toc-text">验证数据写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#验证数据查询"><span class="toc-number">1.2.5.</span> <span class="toc-text">验证数据查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#沙盒环境测试"><span class="toc-number">1.3.</span> <span class="toc-text">沙盒环境测试</span></a></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
</script>


<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/" title="上一篇: Cassandra数据迁移1 新集群sstableloader">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/" title="下一篇: Apache Cassandra架构理解">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2016 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>