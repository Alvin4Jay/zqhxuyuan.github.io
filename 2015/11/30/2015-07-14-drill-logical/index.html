	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Apache Drill源码阅读(4) 逻辑计划 | 任何忧伤,都抵不过世界的美丽</title>
  <meta name="author" content="zqhxuyuan">
  
  <meta name="description" content="在前面说过, Calcite的SQL节点转换为Drill的DrillRel节点,在DefaultSqlHandler.convertToDrel会包装上一个Screen: DrillScreenRel  
12345protected DrillRel convertToDrel(RelNode r">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Apache Drill源码阅读(4) 逻辑计划"/>
  <meta property="og:site_name" content="任何忧伤,都抵不过世界的美丽"/>

  
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <!-- 百度统计 -->
  

  <!-- 谷歌统计 -->
  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">任何忧伤,都抵不过世界的美丽</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	<div class="col-md-8">
	  <!-- index -->
	  
			<h1>Apache Drill源码阅读(4) 逻辑计划</h1>
			
			<div>
				<i class="fa fa-clock-o"></i>
				<span class="post-time">2015-11-30 09:21:38</span>
			</div>
			
	  

		<div class="content">
			<!-- index -->
		  
					<p>在前面说过, Calcite的SQL节点转换为Drill的DrillRel节点,在DefaultSqlHandler.convertToDrel会包装上一个Screen: DrillScreenRel  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function">DrillRel <span class="title">convertToDrel</span><span class="params">(RelNode relNode, RelDataType validatedRowType)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Put a non-trivial topProject to ensure the final output field name is preserved, when necessary.</span></span><br><span class="line">      DrillRel topPreservedNameProj = addRenamedProject((DrillRel) convertedRelNode, validatedRowType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DrillScreenRel(topPreservedNameProj.getCluster(), topPreservedNameProj.getTraitSet(), topPreservedNameProj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么convertToDrel中的RelNode以及更早之前的SqlNode到底是个什么样的数据结构? 为了解开这个谜题,我们要debug下drill的源码才能知晓. </p>
<h3 id="sqlline">sqlline</h3><p>SQL语句: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> department_id,<span class="keyword">count</span>(*) cnt  	→ <span class="keyword">Project</span></span><br><span class="line"><span class="keyword">from</span> cp.<span class="string">`employee.json`</span> 			→ <span class="keyword">Scan</span> 		</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_id 				→ HashAgg</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span> 				→ <span class="keyword">Sort</span></span></span><br></pre></td></tr></table></figure>
<p>生成的物理计划:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>-<span class="number">00</span>    Screen : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1023.2299999999999</span> rows, <span class="number">10798.630541406654</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">361</span></span><br><span class="line"><span class="number">00</span>-<span class="number">01</span>      Project(department_id=[$<span class="number">0</span>], cnt=[$<span class="number">1</span>]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1018.5999999999999</span> rows, <span class="number">10794.000541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">360</span></span><br><span class="line"><span class="number">00</span>-<span class="number">02</span>        SelectionVectorRemover : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1018.5999999999999</span> rows, <span class="number">10794.000541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">359</span></span><br><span class="line"><span class="number">00</span>-<span class="number">03</span>          Sort(sort0=[$<span class="number">1</span>], dir0=[DESC]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">972.3</span> rows, <span class="number">10747.700541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">358</span></span><br><span class="line"><span class="number">00</span>-<span class="number">04</span>            HashAgg(group=[&#123;<span class="number">0</span>&#125;], cnt=[COUNT()]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">926.0</span> rows, <span class="number">9723.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8148.800000000001</span> memory&#125;, id = <span class="number">357</span></span><br><span class="line"><span class="number">00</span>-<span class="number">05</span>              Scan(groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=<span class="number">1</span>, columns=[`department_id`], files=[classpath:/employee.json]]]) : rowType = RecordType(ANY department_id): rowcount = <span class="number">463.0</span>, cumulative cost = &#123;<span class="number">463.0</span> rows, <span class="number">463.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">356</span></span><br></pre></td></tr></table></figure>
<p>可视化的计划图:</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill21.png" alt=""></p>
<h3 id="Debug">Debug</h3><p>使用<code>mvn clean install -DskipTests</code>编译源码工程后, 在drill-jdbc的test工程下的DrillResultSetTest测试类下新建一个测试方法: </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">testQueryCP</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">  Connection connection = <span class="keyword">new</span> Driver().connect( <span class="string">"jdbc:drill:zk=local"</span>, JdbcAssert.getDefaultProperties() );</span><br><span class="line">  Statement statement = connection.createStatement();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//SQL</span></span><br><span class="line">  ResultSet resultSet = statement.executeQuery( <span class="string">"select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc"</span> );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//物理计划</span></span><br><span class="line">  <span class="comment">//ResultSet resultSet = statement.executeQuery( "explain plan for select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc" );</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//逻辑计划</span></span><br><span class="line">  <span class="comment">//ResultSet resultSet = statement.executeQuery( "explain plan without implementation for select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc" );</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在DrillSqlWorker.getPlan的<code>sqlNode = planner.parse(sql)</code>打上断点: </p>
<p><strong>SqlNode:</strong></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-sqlnode.png" alt=""></p>
<p>这里的sqlNode是一个SqlOrderBy解析树节点.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parse tree node that represents an "ORDER BY" on a query other than a "SELECT" (e.g. "VALUES" or "UNION").</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SqlOrderBy</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SqlCall</span> &#123;</span></span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> query;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNodeList</span> orderList;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> offset;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> fetch;</span><br></pre></td></tr></table></figure>
<p>其中query节点是SqlSelect. 一个完整的select语句有多个部分组成:  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A SqlSelect is a node of a parse tree which represents a select statement.</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SqlSelect</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SqlCall</span> &#123;</span></span><br><span class="line">  <span class="type">SqlNodeList</span> keywordList;</span><br><span class="line">  <span class="type">SqlNodeList</span> selectList;</span><br><span class="line">  <span class="type">SqlNode</span> from;</span><br><span class="line">  <span class="type">SqlNode</span> where;</span><br><span class="line">  <span class="type">SqlNodeList</span> groupBy;</span><br><span class="line">  <span class="type">SqlNode</span> having;</span><br><span class="line">  <span class="type">SqlNodeList</span> windowDecls;</span><br><span class="line">  <span class="type">SqlNodeList</span> orderBy;</span><br><span class="line">  <span class="type">SqlNode</span> offset;</span><br><span class="line">  <span class="type">SqlNode</span> fetch;</span><br></pre></td></tr></table></figure>
<p>注意上面的sqlNode有自己的orderList即count(*) desc, 所以SqlSelect中的order by为null.  </p>
<blockquote>
<p>注意到类名字后面跟的@数字吗, 这是一个对象的字符串值表示形式:Class@1234,<br>其中数字还代表了创建对象的顺序. 数字越大, 则对象创建的时间越晚.  </p>
</blockquote>
<p><strong>①RelNode:</strong>  </p>
<p>RelNode是Calcite的关系表达式节点, 它比SqlNode还要更上层. 下面是rel在debug时候的value  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rel<span class="preprocessor">#<span class="number">13</span>:LogicalSort.NONE.ANY([]).[<span class="number">1</span> DESC]</span></span><br><span class="line">  (input=rel<span class="preprocessor">#<span class="number">11</span>:LogicalAggregate.NONE.ANY([]).[]</span></span><br><span class="line">  	(input=rel<span class="preprocessor">#<span class="number">9</span>:LogicalProject.NONE.ANY([]).[]</span></span><br><span class="line">  		(input=rel<span class="preprocessor">#<span class="number">4</span>:EnumerableTableScan.ENUMERABLE.ANY([]).[]</span></span><br><span class="line">  			(table=[cp, employee.json]),department_id=$<span class="number">1</span>),group=&#123;<span class="number">0</span>&#125;,cnt=COUNT()</span><br><span class="line">  	),</span><br><span class="line">  	sort0=$<span class="number">1</span>,</span><br><span class="line">  	dir0=DESC</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>下图中rel的初始值是LogicalSort, 然后通过input指针, 不断地嵌套. 和下图的input嵌套一一对应.<br><code>LogicalSort &gt; LogicalAggregate &gt; LogicalProject &gt; EnumerableTableScan</code>  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-RelNode.png" alt=""></p>
<blockquote>
<p>从上面几个对象后面@代表的数字可以看出, 这几个对象, 依次创建的时间越来越晚.  </p>
</blockquote>
<p><strong>②DrillRel drel:</strong></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-DrillRel.png" alt=""></p>
<p>CalCite的RelNode转换为Drill的DrillRel, drel的值是DrillScreenRel. 它的input也是嵌套的:<br><code>DrillScreenRel &gt; DrillSortRel &gt; DrillAggregateRel &gt; DrillScanRel</code>  </p>
<p>虽然DrillRel drel的值是DrillScreenRel, 以及接下来的DrillRel, 它们都代表的是逻辑计划的表达式树.  </p>
<p><strong>③Prel:</strong></p>
<p>物理计划的input嵌套: <code>ScreenPrel &gt;&gt; ProjectPrel &gt;&gt; SelectionVectorRemoverPrel &gt; SortPrel &gt; HashAggPrel &gt; ScanPrel</code><br>可以看到物理计划会比逻辑计划多一些节点, 并且上面的嵌套和WEBUI上的物理计划和图是能够对应上来的.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-Prel.png" alt=""></p>
<p><strong>PhysicalOperator pop:</strong></p>
<p>pop不再是input嵌套, 而是child嵌套了, 因为pop从plan过来,所以它和Prel类似  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-pop.png" alt=""></p>
<p><strong>④PhysicalPlan plan:</strong></p>
<p>最后的物理计划是一张DAG图, 即Drill Plan(注意和Drill PhysicalPlan不一样). </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-plan.png" alt=""></p>
<p>图中根节点roots和叶子节点leaves. 这里的根是Screen, 即DAG图的最上面一个屏幕输出节点, 叶子只有一个, 即DAG图的最底下扫描节点.  </p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RelNode rel = convertToRel<span class="list">(<span class="keyword">validated</span>)</span><span class="comment">;</span></span><br><span class="line">rel = preprocessNode<span class="list">(<span class="keyword">rel</span>)</span><span class="comment">;</span></span><br><span class="line">log<span class="list">(<span class="string">"Optiq Logical"</span>, rel)</span><span class="comment">;					→ ①</span></span><br><span class="line"></span><br><span class="line">DrillRel drel = convertToDrel<span class="list">(<span class="keyword">rel</span>, validatedRowType)</span><span class="comment">;</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Logical"</span>, drel)</span><span class="comment">;					→ ②</span></span><br><span class="line"></span><br><span class="line">Prel prel = convertToPrel<span class="list">(<span class="keyword">drel</span>)</span><span class="comment">;			→ ③</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Physical"</span>, prel)</span><span class="comment">;				</span></span><br><span class="line"></span><br><span class="line">PhysicalOperator pop = convertToPop<span class="list">(<span class="keyword">prel</span>)</span><span class="comment">;</span></span><br><span class="line">PhysicalPlan plan = convertToPlan<span class="list">(<span class="keyword">pop</span>)</span><span class="comment">;    	→ ④</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Plan"</span>, plan)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>其实WebUI上的可视化Plan图就是这里的graph对象.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill23.png" alt=""></p>
<h3 id="从DrillScreenRel入手">从DrillScreenRel入手</h3><p>在 new DrillScreenRel添加前后打上断点, 验证添加Screen节点的变化:   </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-noscreen.png" alt=""></p>
<p>可以看到在还没有添加Screen时, convertedRelNode和topPreservedNameProj两个对象是一样的, 因为它们的对象编号都是: DrillSortRel@7614<br>添加Screen后, 即DrillRel dre变成了DrillScreenRel@7665, 而其input域仍然是DrillSortRel@7614. 说明确实封装了上面的节点对象.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-screen.png" alt=""></p>
<p>DrillRel drel是逻辑计划, 可以通过explain plan withou implementation for <query>得到查询的逻辑计划(和上图是对应的): </query></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">+------+------+</span><br><span class="line">| <span class="atom">text</span> | <span class="atom">json</span> |</span><br><span class="line">+------+------+</span><br><span class="line">| <span class="name">DrillScreenRel</span></span><br><span class="line">  <span class="name">DrillSortRel</span>(<span class="atom">sort0</span>=[$<span class="number">1</span>], <span class="atom">dir0</span>=[<span class="name">DESC</span>])</span><br><span class="line">    <span class="name">DrillAggregateRel</span>(<span class="atom">group</span>=[&#123;<span class="number">0</span>&#125;], <span class="atom">cnt</span>=[<span class="name">COUNT</span>()])</span><br><span class="line">      <span class="name">DrillScanRel</span>(<span class="atom">table</span>=[[<span class="atom">cp</span>, <span class="atom">employee</span>.<span class="atom">json</span>]], <span class="atom">groupscan</span>=[<span class="name">EasyGroupScan</span> [<span class="atom">selectionRoot</span>=<span class="atom">classpath</span>:/<span class="atom">employee</span>.<span class="atom">json</span>, <span class="atom">numFiles</span>=<span class="number">1</span>, <span class="atom">columns</span>=[<span class="string">`department_id`</span>], <span class="atom">files</span>=[<span class="atom">classpath</span>:/<span class="atom">employee</span>.<span class="atom">json</span>]]])</span><br><span class="line"></span><br><span class="line">  <span class="string">"query"</span> : [ &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"scan"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"storageengine"</span> : <span class="string">"cp"</span>,</span><br><span class="line">    <span class="string">"selection"</span> : &#123;</span><br><span class="line">      <span class="string">"format"</span> : &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"named"</span>,</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"json"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"files"</span> : [ <span class="string">"classpath:/employee.json"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"groupingaggregate"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"keys"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`department_id`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"`department_id`"</span></span><br><span class="line">    &#125; ],</span><br><span class="line">    <span class="string">"exprs"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`cnt`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"count(1) "</span></span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"order"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"within"</span> : <span class="atom">null</span>,</span><br><span class="line">    <span class="string">"orderings"</span> : [ &#123;</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"`cnt`"</span>,</span><br><span class="line">      <span class="string">"order"</span> : <span class="string">"DESC"</span>,</span><br><span class="line">      <span class="string">"nullDirection"</span> : <span class="string">"UNSPECIFIED"</span></span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"store"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">4</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"target"</span> : <span class="atom">null</span>,</span><br><span class="line">    <span class="string">"storageEngine"</span> : <span class="string">"--SCREEN--"</span></span><br><span class="line">  &#125; ]</span><br></pre></td></tr></table></figure>
<p>上面我们debug出来RelNode rel是LogicalSort, 其input嵌套依次是: LogicalAggregate &gt; LogicalProject &gt; EnumerableTableScan<br>经过logicalPlanningVolcano()处理, 会将CalCite的LogicalSort操作符节点转换为Drill认识的DrillSortRel节点.<br>而且topPreservedNameProj=DrillSortRel@7614, 所以创建DrillScreenRel我们可以这么看:  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> new DrillScreenRel(<span class="keyword">cluster</span>, trait, DrillSortRel@7614)</span><br><span class="line"></span><br><span class="line">public DrillScreenRel(RelOptCluster <span class="keyword">cluster</span>, RelTraitSet traitSet, RelNode <span class="keyword">input</span>) &#123;</span><br><span class="line">  super(DRILL_LOGICAL, <span class="keyword">cluster</span>, traitSet, <span class="keyword">input</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于DrillScreenRel构造函数而言, 输入RelNode input=DrillSortRel对象. 其实从我们debug出来的变量也是这么一回事的.<br>即DrillScreenRel的input是DrillSortRel, DrillSortRel的input是DrillAggregateRel, DrillAggregateRel的input是DrillScanRel.<br><code>DrillScreenRel[4] &gt; DrillSortRel[1] &gt; DrillAggregateRel[2] &gt; DrillScanRel[3]</code>  序号表示创建时间顺序.  </p>
<p>这里只是创建对象, 由于DrillXXXRel都实现了DrillRel, 而DrillRel定义了implement接口方法, 我们找到了DrillImplementor.<br>比较重要的是入口方法是go, 它由ExplainHandler, 只有在逻辑计划的时候才会调用到(所以在debug时要用逻辑计划SQL语句才能进入DrillImplementor).  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-go.png" alt=""></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">LogicalExplain</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> String text;</span><br><span class="line">  <span class="keyword">public</span> String json;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LogicalExplain</span>(<span class="params">RelNode node, SqlExplainLevel level, QueryContext context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.text = RelOptUtil.toString(node, level);</span><br><span class="line">    DrillImplementor implementor = <span class="keyword">new</span> DrillImplementor(<span class="keyword">new</span> DrillParseContext(context.getPlannerSettings()), ResultMode.LOGICAL);</span><br><span class="line">    implementor.go( (DrillRel) node);</span><br><span class="line">    LogicalPlan plan = implementor.getPlan();</span><br><span class="line">    <span class="keyword">this</span>.json = plan.unparse(context.getConfig());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span>(<span class="params">DrillRel root</span>) </span>&#123;</span><br><span class="line">  LogicalOperator rootLOP = root.implement(<span class="keyword">this</span>);</span><br><span class="line">  System.<span class="keyword">out</span>.println(<span class="string">"ROOTLOP:"</span> + rootLOP);</span><br><span class="line">  rootLOP.accept(<span class="keyword">new</span> AddOpsVisitor(), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数root是逻辑计划节点=DrillScreenRel, 调用implement后返回的是逻辑操作符. 那么这个rootLOP是什么东东?  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-rootLOP.png" alt=""></p>
<p>调用root的implement, this为DrillImplementor. 看下DrillScreenRel的implement实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DrillScreenRel:</span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogicalOperator <span class="title">implement</span><span class="params">(DrillImplementor implementor)</span> </span>&#123;</span><br><span class="line">    LogicalOperator childOp = implementor.visitChild(<span class="keyword">this</span>, <span class="number">0</span>, getInput());</span><br><span class="line">    <span class="keyword">return</span> Store.builder().setInput(childOp).storageEngine(<span class="string">"--SCREEN--"</span>).build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其中getInput()就是创建DrillScreenRel时的最后一个参数input, 那么这里就是DrillSortRel.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DrillImplementor:</span><br><span class="line">  <span class="keyword">public</span> LogicalOperator visitChild(DrillRel parent, <span class="keyword">int</span> ordinal, RelNode child) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((DrillRel) child).implement(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>child就是DrillScreenRel的getInput()即DrillSortRel. 然后调用DrillSortRel的implement. 以此类推, 所以这是一个递归的过程. </p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">DrillImplementor</span><span class="string">.</span><span class="comment">go</span></span><br><span class="line">   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">root</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillScreenRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                           <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillSortRel)</span></span><br><span class="line">                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillSortRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillAggregateRel)</span></span><br><span class="line">                                                                   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillAggregateRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillScanRel)</span></span><br><span class="line">                                                                                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillScanRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">不再visitChild了</span><span class="string">,</span><span class="comment">因为Scan是叶子节点</span><span class="string">,</span><span class="comment">NO</span><span class="literal">-</span><span class="comment">MORE</span><span class="literal">-</span><span class="comment">CHILD</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">registerSource(table)</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">返回Scan</span> <span class="comment">LogicalOperator</span></span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=GroupingAggregate</span><span class="string">.</span><span class="comment">setInput(Scan)</span> </span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">返回GroupingAggregate</span> <span class="comment">LogicalOperator</span> </span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Order</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=Order</span><span class="string">.</span><span class="comment">setInput(GroupingAggregate)</span></span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">返回Order</span> <span class="comment">LogicalOperator</span> </span><br><span class="line">                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Store</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=Store</span><span class="string">.</span><span class="comment">setInput(Order)</span> <span class="title">[</span><span class="comment">①</span><span class="title">]</span></span><br><span class="line">    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">rootLOP</span><span class="string">.</span><span class="comment">accept</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">Store</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">    <span class="comment">						|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Store)</span></span><br><span class="line">                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">Store</span><span class="string">.</span><span class="comment">getInput=Order</span></span><br><span class="line">                                <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">=</span> <span class="comment">Order</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                              <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Order)</span></span><br><span class="line">                                              <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">Order</span><span class="string">.</span><span class="comment">getInput=GroupingAggregate</span> </span><br><span class="line">                                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                                             <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(GroupingAggregate)</span></span><br><span class="line">                                                             <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">getInput=Scan</span></span><br><span class="line">                                                                 <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">Scan</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Scan)</span></span><br><span class="line">                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Scan</span> <span class="comment">has</span> <span class="comment">not</span> <span class="comment">inputs</span><span class="string">.</span> <span class="comment">END</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">	|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">END</span> <span class="comment">OF</span> <span class="comment">GO</span></span><br></pre></td></tr></table></figure>
<p>DONE with planBuilder which is builder of logical plan.<br>调用完DrillImplementor.go, 就把planBuilder构造完毕, 接着调用getPlan就可以获得planBuilder的输出了.  </p>

			  
		</div>

		<!-- pagination -->
	  

		
  


	</div>
	<div class="col-md-4">
		
			
				<div id="sidebar">
	 			
	 					
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/11/30/2015-11-29-StreamCQL-application/"  > <i class="mdi-editor-insert-drive-file"></i>StreamCQL源码阅读(4) 应用程序执行</a>
      </li>
    
      <li>
        <a href="/2015/11/30/2015-11-27-StreamCQL-operator/"  > <i class="mdi-editor-insert-drive-file"></i>StreamCQL源码阅读(3) 拆分组合算子</a>
      </li>
    
      <li>
        <a href="/2015/11/30/2015-11-26-StreamCQL-schema/"  > <i class="mdi-editor-insert-drive-file"></i>StreamCQL源码阅读(2) 语法和语义解析</a>
      </li>
    
      <li>
        <a href="/2015/11/30/2015-11-24-StreamCQL-task/"  > <i class="mdi-editor-insert-drive-file"></i>StreamCQL源码阅读(1) 提交任务</a>
      </li>
    
      <li>
        <a href="/2015/11/30/2015-11-10-Cassandra-Client/"  > <i class="mdi-editor-insert-drive-file"></i>Cassandra Client查询优化</a>
      </li>
    
  </ul>
</div>


	 				
	 					
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li> <a href="http://www.github.com/zqhxuyuan" title="同性交友社区" target="_blank"> <i class="mdi-action-launch"></i> GitHub</a></li>
	
		<li> <a href="http://www.weibo.com/xuyuantree" title="" target="_blank"> <i class="mdi-action-launch"></i> Weibo</a></li>
	
	</ul>
</div>


	 				
	 			</div>
			
		
	</div>

</div>


			<footer>
				

<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2015 <a href="http://github.com/zqhxuyuan"> zqhxuyuan </a>
</p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

			</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
