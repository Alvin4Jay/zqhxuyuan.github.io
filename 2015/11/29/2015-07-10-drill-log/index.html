	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Apache Drill源码分析之日志 | 任何忧伤,都抵不过世界的美丽</title>
  <meta name="author" content="John cheng">
  
  <meta name="description" content="Drill源码阅读(1) : 环境准备和查看日志准备工作修改logback.xml的日志级别为debug
1234567891011121314&amp;lt;logger name=&quot;org.apache.drill&quot; additivity=&quot;false&quot;&amp;gt;  &amp;lt;level value=&quot;de">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Apache Drill源码分析之日志"/>
  <meta property="og:site_name" content="任何忧伤,都抵不过世界的美丽"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <!-- 百度统计 -->
  
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?392796d51567e848aebf813b65cb8656";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
  

  <!-- 谷歌统计 -->
  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">任何忧伤,都抵不过世界的美丽</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
                <li>
                    <a href="/atom.xml" title="这是一个订阅源">
                    <i class="fa fa-rss"></i>RSS
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	<div class="col-md-8">
	  <!-- index -->
	  
			<h1>Apache Drill源码分析之日志</h1>
			
			<div>
				<i class="fa fa-clock-o"></i>
				<span class="post-time">2015-11-29 14:27:47</span>
			</div>
			
	  

		<div class="content">
			<!-- index -->
		  
					<h2 id="Drill源码阅读(1)_:_环境准备和查看日志">Drill源码阅读(1) : 环境准备和查看日志</h2><h3 id="准备工作">准备工作</h3><p>修改logback.xml的日志级别为debug</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=<span class="string">"org.apache.drill"</span> additivity=<span class="string">"false"</span>&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"FILE"</span> /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;logger name=<span class="string">"query.logger"</span> additivity=<span class="string">"false"</span>&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"QUERY"</span> /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>使用单机模式,而不是集群模式. 启动drill-embedded</p>
<p>除了在上面的drill-embedded观察输出, 还要观察log目录下的sqlline.log文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">41</span>,<span class="number">636</span> [main] DEBUG o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Construction started.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] INFO  o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Construction completed (<span class="number">845</span> ms).</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] DEBUG o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Startup begun.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.c</span><span class="class">.l</span><span class="class">.LocalClusterCoordinator</span> - Local Cluster Coordinator started.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">607</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.user</span><span class="class">.UserServer</span> - Server of type UserServer started on port <span class="number">31010</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">650</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.control</span><span class="class">.ControlServer</span> - Server of type ControlServer started on port <span class="number">31011</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">688</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.data</span><span class="class">.DataServer</span> - Server of type DataServer started on port <span class="number">31012</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">924</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.common</span><span class="class">.util</span><span class="class">.PathScanner</span> - Classpath scanning took <span class="number">60ms</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">924</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.p</span><span class="class">.base</span><span class="class">.PhysicalOperatorUtil</span> - Adding Physical Operator sub types: .................</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">047</span> [main] DEBUG org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.common</span><span class="class">.JSONOptions</span> - Creating Deserializer.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">146</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.p</span><span class="class">.i</span><span class="class">.OperatorCreatorRegistry</span> - Adding Operator Creator map:..............</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">385</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.e</span><span class="class">.f</span><span class="class">.FunctionImplementationRegistry</span> - Generating function registry.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">48</span>,<span class="number">643</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.s</span><span class="class">.h</span><span class="class">.HBaseStoragePluginConfig</span> - Initializing HBase StoragePlugin configuration with zookeeper quorum <span class="string">'localhost'</span>, port <span class="string">'2181'</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">48</span>,<span class="number">977</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.c</span><span class="class">.l</span><span class="class">.LocalClusterCoordinator</span> - Endpoint registered <span class="tag">address</span>: <span class="string">"localhost"</span></span><br><span class="line">user_port: <span class="number">31010</span></span><br><span class="line">control_port: <span class="number">31011</span></span><br><span class="line">data_port: <span class="number">31012</span></span><br><span class="line">.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">51</span>,<span class="number">700</span> [main] INFO  o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Startup completed (<span class="number">9218</span> ms).</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">51</span>,<span class="number">741</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.client</span><span class="class">.DrillClient</span> - Connecting to server localhost:<span class="number">31010</span></span><br></pre></td></tr></table></figure>
<p>可以看到命令行执行drill-embedded, 会连接到本地的Drill Server上.</p>
<p>在sqlline上执行一条SQL命令, 可以看到最终调用的是FragmentExecutor线程的run方法:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: <span class="string">jdbc:</span><span class="string">drill:</span>zk=local&gt; select count(*) from cp.`employee.json`;</span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">02.300</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-<span class="string">a01023a1319a:</span>foreman] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction <span class="string">as:</span>zhengqh (<span class="string">auth:</span>SIMPLE) <span class="string">from:</span>org.apache.drill.exec.util.ImpersonationUtil.createFileSystem(ImpersonationUtil.<span class="string">java:</span><span class="number">141</span>)</span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">02.390</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-<span class="string">a01023a1319a:</span><span class="string">frag:</span><span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction <span class="string">as:</span>zhengqh (<span class="string">auth:</span>SIMPLE) <span class="string">from:</span>org.apache.drill.exec.work.fragment.FragmentExecutor.run(FragmentExecutor.<span class="string">java:</span><span class="number">255</span>)</span><br><span class="line">+---------+</span><br><span class="line">| EXPR$<span class="number">0</span>  |</span><br><span class="line">+---------+</span><br><span class="line">| <span class="number">1155</span>    |</span><br><span class="line">+---------+</span><br><span class="line"><span class="number">1</span> row selected (<span class="number">0.221</span> seconds)</span><br></pre></td></tr></table></figure>
<h3 id="日志分析">日志分析</h3><p>sqlline.log日志我们一段一段地分析</p>
<p>首先注册查询语句, 即在sqlline输入的sql语句, 会分配一个query-id. 访问<a href="http://localhost:8047/profiles" target="_blank" rel="external">http://localhost:8047/profiles</a>可以找到这个Query Job.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">257</span> [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Adding to open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@<span class="number">4</span>eb2bb3d</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">258</span> [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Query listener created.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">259</span> [UserServer-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserServer - Received query to run.  Returning query handle.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">273</span> [UserServer-<span class="number">1</span>] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation <span class="number">1048576</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">274</span> [UserServer-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserServer - Sending response with Sender <span class="number">575856913</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">275</span> [Client-<span class="number">1</span>] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Received query ID: <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">276</span> [Client-<span class="number">1</span>] DEBUG o.a.d.e.rpc.user.QueryResultHandler - Received QueryId <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a successfully. Adding results listener org.apache.drill.jdbc.impl.DrillResultSetImpl$ResultsListener@<span class="number">6f</span>3634b1.</span><br></pre></td></tr></table></figure>
<p>使用了Optiq生成Logical逻辑计划, 查看SQL语句对应的逻辑计划/物理计划是从下到上的, 比如下面的TableScan-&gt;Project-&gt;Aggregate<br>对于<figure class="highlight"><figcaption><span>COUNT(COLUMN) FOME TABLE```, 实际上逻辑计划的顺序是:  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM TABLE(TableScan&#25195;&#25551;) -&#62; SELECT COLUMN(Project&#26144;&#23556;) -&#62; COUNT(Aggregate&#32858;&#21512;&#35745;&#31639;)</span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,315 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Optiq Logical :<br>LogicalAggregate(group=[{}], EXPR$0=[COUNT()]): rowcount = 10.0, cumulative cost = {211.25 rows, 201.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 211<br>  LogicalProject($f0=[0]): rowcount = 100.0, cumulative cost = {200.0 rows, 201.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 209<br>    EnumerableTableScan(table=[[cp, employee.json]]): rowcount = 100.0, cumulative cost = {100.0 rows, 101.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 205<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attribute">Optiq的逻辑计划最终会形成Drill的逻辑计划,再到Drill的物理计划</span>: <span class="string">Drill Logial -&gt; Drill Physical的过程</span></span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,320 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 0 ms to build endpoint map<br>2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - FileWork group (classpath:/employee.json,0) max bytes 474631<br>2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 2 ms to set endpoint bytes<br>2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.d.e.s.schedule.BlockMapBuilder - Get block maps: Executed 1 out of 1 using 1 threads. Time: 2ms total, 2.240000ms avg, 2ms max.<br>2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.d.e.s.schedule.BlockMapBuilder - Get block maps: Executed 1 out of 1 using 1 threads. Earliest start: 1.000000 μs, Latest start: 1.000000 μs, Average start: 1.000000 μs .</p>
<p>2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Work: [File: classpath:/employee.json start: 0 length: 474630] Endpoint: localhost Bytes: 474630<br>2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Endpoint localhost has affinity 1.0<br>2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Took 0 ms to get operator affinity<br>2015-07-10 11:22:02,329 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - VolCalciteRel :<br>2015-07-10 11:22:02,331 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - HepCalciteRel :<br>2015-07-10 11:22:02,333 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Logical :<br>DrillScreenRel: rowcount = 1.0, cumulative cost = {927.1 rows, 1853.1 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 239<br>  DrillAggregateRel(group=[{}], EXPR$0=[COUNT()]): rowcount = 1.0, cumulative cost = {927.0 rows, 1853.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 236<br>    DrillProjectRel($f0=[0]): rowcount = 463.0, cumulative cost = {926.0 rows, 1852.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 234<br>      DrillScanRel(table=[[cp, employee.json]], groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=1, columns=[<code>*</code>], files=[classpath:/employee.json]]]): rowcount = 463.0, cumulative cost = {463.0 rows, 0.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 222</p>
<p>2015-07-10 11:22:02,368 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Physical :<br>00-00    Screen : rowType = RecordType(BIGINT EXPR$0): rowcount = 1.0, cumulative cost = {1389.1 rows, 7408.1 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 317<br>00-01      StreamAgg(group=[{}], EXPR$0=[COUNT()]) : rowType = RecordType(BIGINT EXPR$0): rowcount = 1.0, cumulative cost = {1389.0 rows, 7408.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 316<br>00-02        Project($f0=[0]) : rowType = RecordType(INTEGER $f0): rowcount = 463.0, cumulative cost = {926.0 rows, 1852.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 315<br>00-03          Scan(groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=1, columns=[<code>*</code>], files=[classpath:/employee.json]]]) : rowType = RecordType(): rowcount = 463.0, cumulative cost = {463.0 rows, 0.0 cpu, 0.0 io, 0.0 network, 0.0 memory}, id = 314<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">访问&lt;http:<span class="comment">//localhost:8047/profiles/2a60c5a4-e01a-ac02-84fd-a01023a1319a&gt;查看这个作业的物理计划  </span></span><br><span class="line">可以看到物理计划从下到上的顺序是: Scan-&gt;Project-&gt;StreamAgg. 因为物理计划实际上是从逻辑计划计算出来的.    </span><br><span class="line"></span><br><span class="line">然后会输出详细的json格式的计划.  graph有几个字段pop代表操作类型,@id是编号,child是VisualizedPlan树从上到下第几层.  </span><br><span class="line">graph域的fs-scan代表扫描文件系统,扫描所有列*; project映射字段,$f0实际上就是columns中的第一个字段;    </span><br><span class="line">streaming-aggregate的计算表达式count(<span class="number">1</span>), 最后通过screen输出    </span><br><span class="line"></span><br><span class="line">我们先看一下Web页面的可视化计划数, 先来个比较直观的映象  </span><br><span class="line">以Scan <span class="number">00</span>-<span class="number">03</span>为例,<span class="number">00</span>是major id,<span class="number">03</span>是fs-scan的@id=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">![](http:<span class="comment">//7xjs7x.com1.z0.glb.clouddn.com/drill1.png)</span></span><br><span class="line"></span><br><span class="line">下面不同的pop,对应的metadata也不一样, 比如project映射需要表达式,因为选择一个列,是可以在列上做计算的</span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,370 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Plan :<br>{<br>  “head” : {<br>    “version” : 1,<br>    “generator” : {<br>      “type” : “DefaultSqlHandler”,<br>      “info” : “”<br>    },<br>    “type” : “APACHE_DRILL_PHYSICAL”,<br>    “options” : [ ],<br>    “queue” : 0,<br>    “resultMode” : “EXEC”<br>  },<br>  “graph” : [ {<br>    “pop” : “fs-scan”,<br>    “@id” : 3,<br>    “userName” : “zhengqh”,<br>    “files” : [ “classpath:/employee.json” ],<br>    …<br>    “columns” : [ “<code>*</code>“ ],<br>    “selectionRoot” : “classpath:/employee.json”,<br>  }, {<br>    “pop” : “project”,<br>    “@id” : 2,<br>    “exprs” : [ {<br>      “ref” : “<code>$f0</code>“,<br>      “expr” : “0”<br>    } ],<br>    “child” : 3<br>  }, {<br>    “pop” : “streaming-aggregate”,<br>    “@id” : 1,<br>    “child” : 2,<br>    “keys” : [ ],<br>    “exprs” : [ {<br>      “ref” : “<code>EXPR$0</code>“,<br>      “expr” : “count(1) “<br>    } ]<br>  }, {<br>    “pop” : “screen”,<br>    “@id” : 0,<br>    “child” : 1<br>  } ]<br>}<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Drill的执行引擎会将逻辑计划组成一个Fragment树. 下面是Root Fragment.   </span><br><span class="line">对照WebUI, 这个Query在本地测试时,只生成了一个Fragment.  </span><br><span class="line">Root Fragment的major和minor id都是0.  下面的fragment_json和上面graph不同的是它是嵌套的.  </span><br><span class="line"></span><br><span class="line"><span class="blockquote">&gt; 为什么可视化的Plan对应的graph是扁平的,而Root Fragment是嵌套的?</span></span><br><span class="line"><span class="blockquote">&gt; 可以这么理解: 如果图的结构是嵌套的,那么就要在Screen这个组件里画上streaming-aggregate</span></span><br><span class="line"><span class="blockquote">&gt; 并在streaming-aggregate里再画上project,以此类推,就不叫图了,图是一个DAG有向无环图.  </span></span><br><span class="line"><span class="blockquote">&gt; 而树如果是扁平的,则只能像上面的图一样一直下去,没有分支. 使用嵌套,就有了分支的概念了.</span></span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,372 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AssignmentCreator - Took 0 ms to assign 1 work units to 1 fragments<br>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.f.SimpleParallelizer - Root fragment:<br> handle {<br>  query_id {<br>    part1: 3053657859282349058<br>    part2: -8863752500417580646<br>  }<br>  major_fragment_id: 0<br>  minor_fragment_id: 0<br>}<br>fragment_json: “{<br>  “pop” : “screen”,<br>  “@id” : 0,<br>  “child” : {<br>    “pop” : “streaming-aggregate”,<br>    “@id” : 1,<br>    “child” : {<br>      “pop” : “project”,<br>      “@id” : 2,<br>      “exprs” : [ {<br>        “ref” : “<code>$f0</code>“,<br>        “expr” : “0”<br>      } ],<br>      “child” : {<br>        “pop” : “fs-sub-scan”,<br>        “@id” : 3,<br>        “userName” : “zhengqh”,<br>        “files” : [ {<br>          “start” : 0,<br>          “length” : 474630,<br>          “path” : “classpath:/employee.json”<br>        } ],<br>        “columns” : [ “<code>*</code>“ ],<br>        “selectionRoot” : “classpath:/employee.json”<br>      },<br>      “initialAllocation” : 1000000,<br>      “maxAllocation” : 10000000000,<br>      “cost” : 463.0<br>    },<br>    “keys” : [ ],<br>    “exprs” : [ {<br>      “ref” : “<code>EXPR$0</code>“,<br>      “expr” : “count(1) “<br>    } ]<br>  }<br>}”<br>leaf_fragment: true<br>assignment {<br>  address: “localhost”<br>  user_port: 31010<br>  control_port: 31011<br>  data_port: 31012<br>}<br>foreman {<br>  address: “localhost”<br>  user_port: 31010<br>  control_port: 31011<br>  data_port: 31012<br>}<br>mem_initial: 3000000<br>mem_max: 30000000000<br>credentials {<br>  user_name: “anonymous”<br>}<br>options_json: “[ ]”<br>context {<br>  query_start_time: 1436498522273<br>  time_zone: 299<br>  default_schema_name: “”<br>}<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面和fragment_json同级的还有foreman,表示接受客户端查询作业的节点, 因为是本地模式,所以是localhost.    </span><br><span class="line">初始化内存mem<span class="emphasis">_initial和最大内存mem_</span>max在FragmentContext中.  </span><br><span class="line"></span><br><span class="line">Fragment提交到Foreman后, 查询开始运行, Foreman的状态从PENDING到RUNNING, FragmentExecutor从AWAITING_ALLOCATION到RUNNING.    </span><br><span class="line">这里有个比较重要的概念是通过ImplCreator创建的RecordBatch Tree.       </span><br><span class="line"></span><br><span class="line"><span class="blockquote">&gt; 上面我们已经有了Root Fragment形成的Tree的概念. 这里批记录还有树. </span></span><br><span class="line"><span class="blockquote">&gt; 什么是RecordBatch,顾名思义是批记录. 那为什么又有树的概念?</span></span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Adding fragment status listener for queryId 2a60c5a4-e01a-ac02-84fd-a01023a1319a.<br>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Submitting fragments to run.<br>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Getting initial memory allocation of 3000000<br>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Fragment max allocation: 30000000000<br>2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation 3000000<br>2015-07-10 11:22:02,379 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.work.batch.IncomingBuffers - Came up with a list of 0 required fragments.  Fragments {}<br>2015-07-10 11:22:02,380 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  PENDING –&gt; RUNNING<br>2015-07-10 11:22:02,381 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Fragments running.<br>2015-07-10 11:22:02,381 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000<br>2015-07-10 11:22:02,387 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000<br>2015-07-10 11:22:02,387 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000<br>2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000<br>2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.physical.impl.ImplCreator - Took 7 ms to create RecordBatch tree<br>2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.fragment.FragmentExecutor - 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0: State change requested from AWAITING_ALLOCATION –&gt; RUNNING for<br>2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed for 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0. New state: RUNNING<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Fragment的状态会被QueryManager管理, 其中operator_profile是操作算子的选项, 包括了一些字段input_profile, 操作算子id, 操作类型等等.  </span><br><span class="line">什么是<span class="keyword">profile</span>, 其实WEB页面<span class="variable">&lt;http://localhost:8047/profiles&gt;</span>就是Drill查询作业运行时的<span class="keyword">profile</span>收集页面.  </span><br><span class="line">包括了Query Profile, Fragment Profiles,Operator Profiles,Full JSON Profile.</span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,389 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile {<br>  state: RUNNING<br>  minor_fragment_id: 0<br>  operator_profile {<br>    input_profile {<br>      records: 0<br>      batches: 0<br>      schemas: 0<br>    }<br>    operator_id: 3<br>    operator_type: 29<br>    setup_nanos: 0<br>    process_nanos: 4651000<br>    peak_local_memory_allocated: 0<br>    wait_nanos: 3000<br>  }<br>  …<br>2015-07-10 11:22:02,390 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.fragment.FragmentExecutor - Starting fragment 0:0 on localhost:31010<br>2015-07-10 11:22:02,392 [BitServer-4] DEBUG o.a.d.exec.work.foreman.QueryManager - New fragment status was provided to QueryManager of profile {<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面提到的RecordBatch在下面有几个实现类: ProjectRecordBatch, StreamingAggBatch.</span><br><span class="line"></span><br><span class="line">![](<span class="string">http:</span><span class="comment">//7xjs7x.com1.z0.glb.clouddn.com/drill2.png)</span></span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,392 [BitServer-4] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender 762133699<br>2015-07-10 11:22:02,408 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.p.ProjectRecordBatch - Added eval for project expression.<br>2015-07-10 11:22:02,410 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating new aggregator.<br>2015-07-10 11:22:02,413 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Next outcome of OK_NEW_SCHEMA<br>2015-07-10 11:22:02,413 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating new aggregator.</p>
<p>+++++++++++++batch1+++++++++++++<br>2015-07-10 11:22:02,414 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: 3053657859282349058 part2: -8863752500417580646<br>2015-07-10 11:22:02,415 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query data batch #1: QueryResultBatch [header=query_id {<br>2015-07-10 11:22:02,415 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 955795882<br>2015-07-10 11:22:02,416 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Dequeued query data batch #1: QueryResultBatch [header=query_id {<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="label">上面的batchArrived表示批记录到来, 那么接下去就是处理到来的数据了:</span>  </span><br><span class="line">对于batch, 总是先<span class="escape">``</span><span class="escape">`R</span>eceived query data batch<span class="escape">``</span><span class="escape">`,</span> 然后<span class="escape">``</span><span class="escape">`S</span>ending response with Sender<span class="escape">``</span><span class="escape">`,</span></span><br><span class="line">最后<span class="escape">``</span><span class="escape">`D</span>equeued query data batch<span class="escape">``</span><span class="escape">`.</span> 很显然query data batch会在队列中进进出出.</span><br></pre></td></tr></table></figure></p>
<p>+++++++++++++batch2+++++++++++++<br>2015-07-10 11:22:02,419 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response RETURN_OUTCOME, records 1<br>2015-07-10 11:22:02,419 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response CLEANUP_AND_RETURN, records 1</p>
<p>2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: 3053657859282349058 part2: -8863752500417580646<br>2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query data batch #2: QueryResultBatch [header=query_id {<br>2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 1000578767<br>2015-07-10 11:22:02,422 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Dequeued query data batch #2: QueryResultBatch [header=query_id {<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="cpp">计算完成, 关闭上下文, FragmentExecutor的状态从RUNNING到FINISHED.  同样也会打印profile.  </span><br><span class="line">这里我们终于看到了<span class="number">1155</span>这个Query计算出来的结果了.</span></span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.store.dfs.easy.EasySubScan<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.Project<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.StreamingAggregate<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.Screen<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.apache.drill.exec.memory.Accountor - Fragment 0:0  accountor being closed<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.fragment.FragmentExecutor - 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0: State change requested from RUNNING –&gt; FINISHED for<br>2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed for 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0. New state: FINISHED<br>2015-07-10 11:22:02,424 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile {<br>  state: FINISHED<br>  minor_fragment_id: 0<br>  operator_profile {<br>    input_profile {<br>      records: 1155<br>      batches: 1<br>      schemas: 1<br>    }<br>    operator_id: 3<br>    operator_type: 29<br>    setup_nanos: 0<br>    process_nanos: 22301000<br>    peak_local_memory_allocated: 4608<br>    wait_nanos: 133000<br>  }<br>  …<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">最后<span class="variable">Forman</span>也会关闭, <span class="variable">Foreman</span>的状态从<span class="variable">RUNNING</span>到<span class="variable">COMPLETED</span>.  打印result<span class="variable">Arrived</span>的时候其实结果已经在sqlline上输出了.    </span><br><span class="line">剩下就是一些资源移除,注销之类的工作了. 其实和最开始的资源申请,注册是对应的.</span><br></pre></td></tr></table></figure></p>
<p>2015-07-10 11:22:02,427 [BitServer-4] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  RUNNING –&gt; COMPLETED<br>2015-07-10 11:22:02,427 [BitServer-4] INFO  o.a.drill.exec.work.foreman.Foreman - foreman cleaning up.<br>2015-07-10 11:22:02,429 [BitServer-4] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Removing fragment status listener for queryId 2a60c5a4-e01a-ac02-84fd-a01023a1319a.<br>2015-07-10 11:22:02,430 [BitServer-4] DEBUG o.apache.drill.exec.memory.Accountor - Fragment 0:0  accountor being closed<br>2015-07-10 11:22:02,446 [BitServer-4] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender 739019148<br>2015-07-10 11:22:02,447 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - resultArrived: queryState: COMPLETED, queryId = part1: 3053657859282349058<br>part2: -8863752500417580646</p>
<p>2015-07-10 11:22:02,448 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query completion: COMPLETED.<br>2015-07-10 11:22:02,448 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 264929084<br>2015-07-10 11:22:02,479 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Query listener closing.<br>2015-07-10 11:22:02,479 [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Removing from open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@4eb2bb3d<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="livecodeserver"><span class="comment">### Logical Plan逻辑计划</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">http</span>://drill.apache.org/docs/drill-plan-syntax/&gt;  </span><br><span class="line">&lt;<span class="keyword">https</span>://docs.google.com/document/d/<span class="number">1</span>QTL8warUYS2KjldQrGUse7zp8eA72VKtLOHwfXy6c7I/edit&gt;  </span><br><span class="line">&lt;<span class="keyword">http</span>://yangyoupeng-cn-fujitsu-com.iteye.com/blog/<span class="number">1971728</span>&gt;</span><br><span class="line"></span><br><span class="line">在Architecture中我们见到这张图了</span><br><span class="line"></span><br><span class="line">![](<span class="keyword">http</span>://drill.apache.org/docs/img/client-phys-plan.png)</span><br><span class="line"></span><br><span class="line">在DesignDoc中是一张比较粗略的图</span><br><span class="line"></span><br><span class="line">![](<span class="keyword">http</span>://drill.apache.org/docs/img/slide-<span class="number">15</span>-<span class="number">638.</span>png)</span><br><span class="line"></span><br><span class="line">总的来说过程就是: 查询语句<span class="comment">--解析器--逻辑计划--优化器--物理计划--执行引擎</span></span><br><span class="line"></span><br><span class="line">关于逻辑计划比较详细的文档也给出了(上面第二个链接,请自行fq).</span><br><span class="line"></span><br><span class="line">![](<span class="keyword">http</span>://<span class="number">7</span>xjs7x.com1.z0.glb.clouddn.com/drill3.png)</span><br><span class="line"></span><br><span class="line">以Logical Plan Operators的Scan为例</span><br><span class="line"></span><br><span class="line">&gt; The Scan operator outputs <span class="operator">a</span> stream <span class="operator">of</span> records. The <span class="string">"storageengine"</span> argument must refer <span class="keyword">by</span> name <span class="built_in">to</span> <span class="operator">a</span> storage engine defined <span class="operator">in</span> <span class="operator">the</span> engines clause <span class="operator">of</span> <span class="operator">the</span> logical plan. The <span class="string">"selection"</span> argument accepts <span class="operator">a</span> JSON object that is used <span class="keyword">by</span> <span class="operator">the</span> data source itself <span class="built_in">to</span> limit <span class="operator">the</span> amount <span class="operator">of</span> data actually retrieved. The <span class="built_in">format</span> <span class="operator">and</span> content <span class="operator">of</span> this object is specific <span class="built_in">to</span> <span class="operator">the</span> actual input source being used. Examples might <span class="built_in">include</span> <span class="operator">an</span> HBase table name, <span class="operator">a</span> MongoDB collection, <span class="operator">an</span> HDFS path <span class="operator">or</span> <span class="operator">a</span> partition <span class="operator">of</span> <span class="operator">a</span> Hive table. Data sources will use <span class="operator">the</span> <span class="operator">the</span> selection argument <span class="operator">in</span> <span class="operator">an</span> implementation-specific way.  The provided “ref” argument ensures that all records <span class="operator">within</span> <span class="operator">the</span> scanned source are held <span class="operator">in</span> <span class="operator">the</span> provided namespace. </span><br><span class="line">&#123; @id†: &lt; opref &gt;, op: “scan”, </span><br><span class="line">   storageengine: &lt; <span class="keyword">string</span> &gt;, </span><br><span class="line">   selection*: &lt; json &gt;,</span><br><span class="line">   ref: &lt; name &gt;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">Scan操作算子会输出记录流. 参数storageengine必须引用逻辑计划中定义的engine声明.  </span><br><span class="line">selection参数接收JSON对象,会被数据源使用,用于限制接收到的数据的数量.  </span><br><span class="line">这个JSON对象的格式和内容和实际的数据源有关.比如HBase的表名,MongoDB的集合,HDFS的路径,或者Hive表的一个分区.  </span><br><span class="line"></span><br><span class="line">&gt; Talk is cheap, Show me <span class="operator">the</span> Code. </span><br><span class="line"></span><br><span class="line">在```org.apache.drill.common.logical.data```有很多上文提到的操作符比如Scan,Join,Project,Union等.  </span><br><span class="line"></span><br><span class="line">![](<span class="keyword">http</span>://<span class="number">7</span>xjs7x.com1.z0.glb.clouddn.com/drill5.png)</span></span><br></pre></td></tr></table></figure></p>
<p>@JsonTypeName(“scan”)<br>public class Scan extends SourceOperator {<br>  private final String storageEngine;<br>  private final JSONOptions selection;</p>
<p>  @JsonCreator<br>  public Scan(@JsonProperty(“storageengine”) String storageEngine, @JsonProperty(“selection”) JSONOptions selection) {<br>    super();<br>    this.storageEngine = storageEngine;<br>    this.selection = selection;<br>  }</p>
<p>  @JsonProperty(“storageengine”)<br>  public String getStorageEngine() { return storageEngine; }</p>
<p>  public JSONOptions getSelection() {  return selection; }</p>
<p>  @Override<br>  public <t, x,="" e="" extends="" throwable=""> T accept(LogicalVisitor<t, x,="" e=""> logicalVisitor, X value) throws E {<br>      return logicalVisitor.visitScan(this, value);<br>  }<br>}<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```<span class="type">LogicalVisitor</span>```是逻辑(操作符)的访问器. <span class="type">Visitor</span> class designed to traversal <span class="keyword">of</span> a operator tree.  遍历一颗操作符树</span><br><span class="line"><span class="type">Basis</span> <span class="keyword">for</span> a number <span class="keyword">of</span> operator manipulations including fragmentation <span class="keyword">and</span> materialization. 对算子的维护包括分片,序列化</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Scan</span>操作比较简单, 它继承的是<span class="type">SourceOperator</span>:<span class="type">An</span> operator that produces data <span class="keyword">without</span> <span class="type">any</span> parents.  (zero input operator)</span><br><span class="line"></span><br><span class="line">&gt;<span class="type">Operator</span>分成若干类，每一个operator都标示了它的类型，目前operator类包括： </span><br><span class="line"><span class="number">0</span>：可以产生不依赖其他operator的数据，类似于源数据. 比如<span class="type">Scan</span>,</span><br><span class="line"><span class="number">1</span>：该operator可以处理一个单独input source, 比如<span class="type">Project</span>,<span class="type">Order</span>,<span class="type">Limit</span>等</span><br><span class="line">M：可以处理多个input source数据 </span><br><span class="line">K：该operator不会产生输出。 </span><br><span class="line"></span><br><span class="line">我们知道<span class="type">Project</span>包括字段和表达式, 比如count(*), 其中*是<span class="keyword">ref</span>引用,count是<span class="type">expr</span>表达式</span><br></pre></td></tr></table></figure></t,></t,></p>
<p>@JsonTypeName(“project”)<br>public class Project extends SingleInputOperator {<br>  private final NamedExpression[] selections;</p>
<p>@JsonPropertyOrder({“ref”, “expr”})<br>public class NamedExpression {<br>  private final LogicalExpression expr;<br>  private final FieldReference ref;<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.common</span><span class="class">.logical</span>这个包下有个比较重要的类LogicalPlan,先来看看Plan的属性有哪些</span><br></pre></td></tr></table></figure></p>
<p>public class PlanProperties {<br>  public static enum PlanType {APACHE_DRILL_LOGICAL, APACHE_DRILL_PHYSICAL}</p>
<p>  public PlanType type;<br>  public int version;<br>  public Generator generator;<br>  public ResultMode resultMode;<br>  public JSONOptions options;<br>  public int queue;</p>
<p>  public static class Generator {<br>    public String type;<br>    public String info;</p>
<pre><code>public static <span class="class"><span class="keyword">enum</span> <span class="title">ResultMode</span> {</span>
  <span class="constant">EXEC</span>, <span class="constant">LOGICAL</span>, <span class="constant">PHYSICAL</span>;
}

<span class="keyword">private</span> <span class="constant">Generator</span>(<span class="variable">@JsonProperty</span>(<span class="string">"type"</span>) <span class="constant">String</span> <span class="keyword">type</span>, <span class="variable">@JsonProperty</span>(<span class="string">"info"</span>) <span class="constant">String</span> info) {
  this.<span class="keyword">type</span> = <span class="keyword">type</span>;
  this.info = info;
}
</code></pre><p>  }<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应了前面的Drill Plan中head部分的输出(虽然前面我们看到的Drill Plan应该是物理计划,而不是逻辑计划,但是head部分是一样的)</span><br></pre></td></tr></table></figure></p>
<p>{<br>  “head” : {<br>    “version” : 1,<br>    “generator” : {<br>      “type” : “DefaultSqlHandler”,<br>      “info” : “”<br>    },<br>    “type” : “APACHE_DRILL_PHYSICAL”,<br>    “options” : [ ],<br>    “queue” : 0,<br>    “resultMode” : “EXEC”<br>  },<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">逻辑计划LogicalPlan包含了三个部分: head,storage,query.  </span><br><span class="line"></span><br><span class="line">&lt;http://www.confusedcoders.com/bigdata/apache-drill/understanding-apache-drill-logical-plan&gt;</span><br><span class="line"></span><br><span class="line">&gt; The query node is the actual query that we want to<span class="instruction"> execute </span>on Drill. The query itself is a collection of operations on the data.</span><br></pre></td></tr></table></figure></p>
<p>@JsonPropertyOrder({ “head”, “storage”, “query” })<br>public class LogicalPlan {<br>  static final Logger logger = LoggerFactory.getLogger(LogicalPlan.class);</p>
<p>  private final PlanProperties properties;<br>  private final Map<string, storagepluginconfig=""> storageEngineMap;<br>  private final Graph<logicaloperator, sinkoperator,="" sourceoperator=""> graph;</logicaloperator,></string,></p>
<p>  @JsonCreator<br>  public LogicalPlan(@JsonProperty(“head”) PlanProperties head,<br>      @JsonProperty(“storage”) Map<string, storagepluginconfig=""> storageEngineMap,<br>      @JsonProperty(“query”) List<logicaloperator> operators) {<br>    this.storageEngineMap = storageEngineMap != null ? storageEngineMap : new HashMap<string, storagepluginconfig="">();<br>    this.properties = head;<br>    this.graph = Graph.newGraph(operators, SinkOperator.class, SourceOperator.class);<br>  }<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">query是逻辑操作符集合, 它们和Sink,Source操作符一起构成了一张逻辑计划数据流的执行图graph.  </span><br><span class="line">LogicalPlan的构建器的<span class="function"><span class="title">build</span><span class="params">()</span></span>会创建LogicalPlan对象. 这个Builder对象提供了逻辑计划的编程接口.</span><br></pre></td></tr></table></figure></string,></logicaloperator></string,></p>
<p>public class LogicalPlanBuilder {<br>  private PlanProperties planProperties;<br>  private ImmutableMap.Builder<string, storagepluginconfig=""> storageEngines = ImmutableMap.builder();<br>  private ImmutableList.Builder<logicaloperator> operators = ImmutableList.builder();</logicaloperator></string,></p>
<p>  public LogicalPlanBuilder addLogicalOperator(LogicalOperator operator) {<br>    this.operators.add(operator);<br>    return this;<br>  }<br>  public LogicalPlan build() {<br>    return new LogicalPlan(this.planProperties, this.storageEngines.build(), this.operators.build());<br>  }<br>}<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在build之前,要构建一个完整的图,要调用相应的addXXX()方法,因为方法返回<span class="keyword">this</span>,所以调用者可以链式调用.  </span><br><span class="line">build就是构建者模式,一旦调用了build方法,返回的对象就是不可修改的.因此要在build前填充所有的数据.  </span><br><span class="line"></span><br><span class="line"><span class="preprocessor">### PhysicalPlan物理计划</span></span><br><span class="line"></span><br><span class="line">怎么知道前面日志中打印的Drill Plan是物理计划,而不是逻辑计划, 首先可以从调用的类DefaultSqlHandler,搜索Drill Plan</span><br></pre></td></tr></table></figure></p>
<p>  public PhysicalPlan getPlan(SqlNode sqlNode) {<br>    final ConvertedRelNode convertedRelNode = validateAndConvert(sqlNode);<br>    final RelDataType validatedRowType = convertedRelNode.getValidatedRowType();<br>    final RelNode queryRelNode = convertedRelNode.getConvertedNode();</p>
<pre><code>log<span class="list">(<span class="string">"Optiq Logical"</span>, queryRelNode, logger)</span><span class="comment">;</span>
DrillRel drel = convertToDrel<span class="list">(<span class="keyword">queryRelNode</span>, validatedRowType)</span><span class="comment">;</span>

log<span class="list">(<span class="string">"Drill Logical"</span>, drel, logger)</span><span class="comment">;</span>
Prel prel = convertToPrel<span class="list">(<span class="keyword">drel</span>)</span><span class="comment">;</span>
log<span class="list">(<span class="string">"Drill Physical"</span>, prel, logger)</span><span class="comment">;</span>
PhysicalOperator pop = convertToPop<span class="list">(<span class="keyword">prel</span>)</span><span class="comment">;</span>
PhysicalPlan plan = convertToPlan<span class="list">(<span class="keyword">pop</span>)</span><span class="comment">;</span>
log<span class="list">(<span class="string">"Drill Plan"</span>, plan, logger)</span><span class="comment">;</span>
return plan<span class="comment">;</span>
</code></pre><p>  }<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1</span>.可以看到在上面的getPlan方法中, 依次生成的计划是: Optiq逻辑计划--&gt;Drill逻辑计划--&gt;Drill物理计划   </span><br><span class="line"><span class="number">2</span>.物理计划和逻辑计划一样也有很多operator, 都在```org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.physical</span>```包下  </span><br><span class="line"><span class="number">3</span>.Optiq现在变成Apache的Calcite, 入门教程: &lt;http:<span class="comment">//blog.csdn.net/yunlong34574/article/details/46375733&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">getPlan调用树是被Foreman线程运行,由Foreman创建的DrillSqlWorker调用执行的.  </span><br><span class="line"></span><br><span class="line">![](http:<span class="comment">//7xjs7x.com1.z0.glb.clouddn.com/drill4.png)</span></span><br><span class="line"></span><br><span class="line">真正运行物理计划,还是在Foreman的runPhysicalPlan中</span><br></pre></td></tr></table></figure></p>
<p>  private void runSQL(final String sql) throws ExecutionSetupException {<br>    final DrillSqlWorker sqlWorker = new DrillSqlWorker(queryContext);<br>    final Pointer<string> textPlan = new Pointer&lt;&gt;();<br>    final PhysicalPlan plan = sqlWorker.getPlan(sql, textPlan);<br>    queryManager.setPlanText(textPlan.value);<br>    runPhysicalPlan(plan);<br>  }<br>```</string></p>

			  
		</div>

		<!-- pagination -->
	  

		
  


	</div>
	<div class="col-md-4">
		
			
				<div id="sidebar">
	 			
	 					
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/11/29/2015-07-10-drill-log/"  > <i class="mdi-editor-insert-drive-file"></i>Apache Drill源码分析之日志</a>
      </li>
    
      <li>
        <a href="/2015/11/29/2015-07-26-drill-fragment-execute/"  > <i class="mdi-editor-insert-drive-file"></i>Apache Drill源码分析之execute</a>
      </li>
    
      <li>
        <a href="/2015/11/29/2015-07-15-drill-fragments/"  > <i class="mdi-editor-insert-drive-file"></i>Apache Drill源码分析之fragment</a>
      </li>
    
      <li>
        <a href="/2015/11/29/2015-07-14-drill-logical/"  > <i class="mdi-editor-insert-drive-file"></i>Apache Drill源码分析之逻辑计划</a>
      </li>
    
      <li>
        <a href="/2015/11/29/2015-07-13-drill-phyplan/"  > <i class="mdi-editor-insert-drive-file"></i>Apache Drill源码分析之物理计划</a>
      </li>
    
  </ul>
</div>


	 				
	 					
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li> <a href="http://www.github.com/zqhuxyuan" title="" target="_blank"> <i class="mdi-action-launch"></i> GitHub</a></li>
	
		<li> <a href="http://www.weibo.com/xuyuantree" title="twitter的本地化版本" target="_blank"> <i class="mdi-action-launch"></i> 微博</a></li>
	
	</ul>
</div>


	 				
	 			</div>
			
		
	</div>

</div>


			<footer>
				

<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2015 <a href="http://yoursite.com"> John cheng </a>
</p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

			</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
