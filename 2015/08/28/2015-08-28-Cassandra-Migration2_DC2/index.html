<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra数据迁移2 多数据中心数据迁移 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace有重复(DC1,DC2).">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra数据迁移2 多数据中心数据迁移">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace有重复(DC1,DC2).">
<meta property="og:updated_time" content="2015-12-19T08:30:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra数据迁移2 多数据中心数据迁移">
<meta name="twitter:description" content="迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace有重复(DC1,DC2).">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/cassandra/" style="font-size: 20px;">cassandra</a> <a href="/tags/drill/" style="font-size: 18.33px;">drill</a> <a href="/tags/druid/" style="font-size: 13.33px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/spark/" style="font-size: 13.33px;">spark</a> <a href="/tags/storm/" style="font-size: 16.67px;">storm</a> <a href="/tags/work/" style="font-size: 11.67px;">work</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-08-28-Cassandra-Migration2_DC2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/" class="article-date">
  	<time datetime="2015-08-27T16:00:00.000Z" itemprop="datePublished">2015-08-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra数据迁移2 多数据中心数据迁移
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>迁移keyspace到同一个集群的多个数据中心, DC和原有keyspace有重复(DC1,DC2).  </p>
<a id="more"></a>
<h2 id="多数据中心数据迁移">多数据中心数据迁移</h2><p><a href="http://www.planetcassandra.org/blog/cassandra-migration-to-ec2/" target="_blank" rel="external">http://www.planetcassandra.org/blog/cassandra-migration-to-ec2/</a><br><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_add_dc_to_cluster_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_add_dc_to_cluster_t.html</a>  </p>
<p>现在的集群配置endpoint_snitch:GossipingPropertyFileSnitch, 使用cassandra-rackdc.properties</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1.新集群默认的数据中心设置为DC2. 并且使用和原集群一样的clusterName. 这样fp数据会写到一个集群的两个DC</span><br><span class="line">default=DC2:r1</span><br><span class="line"></span><br><span class="line">2.由于forseti和forseti_fp都使用相同的副本策略,新集群配置为DC2后,forseti数据也会写到新集群: </span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'3'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'3'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"></span><br><span class="line">更新forseti使用DC1, forseti_fp使用DC2, 达到分离数据库的目的:  </span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> KEYSPACE forseti <span class="keyword">with</span> placement_strategy = <span class="string">'NetworkTopologyStrategy'</span> <span class="keyword">and</span> strategy_options = &#123;<span class="string">'DC1'</span> : <span class="number">3</span>&#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> KEYSPACE forseti_fp <span class="keyword">with</span> placement_strategy = <span class="string">'NetworkTopologyStrategy'</span> <span class="keyword">and</span> strategy_options = &#123;<span class="string">'DC2'</span> : <span class="number">3</span>&#125;;</span></span><br><span class="line"></span><br><span class="line">或者用<span class="operator"><span class="keyword">alter</span>:</span><br><span class="line"><span class="keyword">ALTER</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> : <span class="number">3</span> &#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC2'</span> : <span class="number">3</span> &#125;;</span></span><br></pre></td></tr></table></figure>
<p><strong>线下测试方案1: DC1, DC2</strong>  </p>
<ul>
<li>模拟原数据中心: 52,53上创建forseti集群, 并建立库表和数据</li>
<li>模拟新数据中心: 配置56,57为DC2</li>
<li>修改forseti只有DC1</li>
<li>启动新数据中心DC2</li>
<li>修改forseti_fp只有DC2</li>
<li>查询forseti和forseti_fp数据时都会出现问题</li>
</ul>
<p><strong>线下测试方案2: DC1, DC3</strong>  </p>
<ul>
<li>模拟新数据中心: 配置56,57为DC3</li>
<li>启动新数据中心. 查询没问题, 因为没有更改forseti和forseti_fp, 引入DC3,暂时还不起作用</li>
<li>修改forseti_fp副本策略: 给forseti_fp添加新数据中心DC3</li>
<li>模拟写入新数据</li>
<li>查询forseti,forseti_fp都没有问题</li>
</ul>
<p>下面是详细的测试步骤:  </p>
<h3 id="线下环境测试方案1:_DC1,_DC2">线下环境测试方案1: DC1, DC2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DC1: <span class="number">52</span>, <span class="number">53</span>  | forseti</span><br><span class="line">DC2: <span class="number">56</span>, <span class="number">57</span>  | forseti_fp</span><br></pre></td></tr></table></figure>
<h4 id="模拟原数据中心:_52,53上创建forseti集群">模拟原数据中心: 52,53上创建forseti集群</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>sudo -u admin vi /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/conf/cassandra.yaml</span><br><span class="line"><span class="symbol">endpoint_snitch:</span> <span class="constant">GossipingPropertyFileSnitch</span></span><br><span class="line">- <span class="symbol">seeds:</span> <span class="string">"192.168.6.52"</span></span><br><span class="line"><span class="symbol">cluster_name:</span> <span class="string">'forseti'</span></span><br><span class="line"></span><br><span class="line">由于<span class="number">52</span>,<span class="number">53</span>之前启动过, 所以清理下文件夹: </span><br><span class="line">sudo rm -rf /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">commitlog</span> &amp;&amp; <span class="title">sudo</span> <span class="title">rm</span> -<span class="title">rf</span> /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span> &amp;&amp; <span class="title">sudo</span> <span class="title">rm</span> /<span class="title">var</span>/<span class="title">log</span>/<span class="title">cassandra</span>/*</span></span><br><span class="line">如果是全新的节点, 则要创建/var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>和/<span class="title">var</span>/<span class="title">log</span>/<span class="title">cassandra</span>目录,并赋予<span class="title">admin</span>权限.</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>sudo -u admin /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/cassandra</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool status</span><br><span class="line"><span class="constant">Datacenter</span>: <span class="constant">DC1</span></span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span> (effective)  <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">83.93</span> <span class="constant">KB</span>   <span class="number">256</span>     <span class="number">100.0</span>%            bb63b562-d19e-<span class="number">4</span>a38-<span class="number">8857</span>-aca7172e7c4c  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  <span class="number">70.23</span> <span class="constant">KB</span>   <span class="number">256</span>     <span class="number">100.0</span>%            <span class="number">4359446</span>f-<span class="number">7</span>c87-<span class="number">4e9</span>b-b2c3-<span class="number">624</span>af8924bb1  <span class="constant">RAC1</span></span><br></pre></td></tr></table></figure>
<h4 id="模拟原集群的数据中心的库表和数据-">模拟原集群的数据中心的库表和数据.</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cqlsh 192.168.6.52 -f ~/Documents/forseti.cql</span><br><span class="line">cqlsh 192.168.6.52 -f ~/Documents/forseti_fp.cql</span><br><span class="line"></span><br><span class="line">其中模拟了forseti和forseti_fp数据库. 由于在测试环境每个DC只有两个节点,所以设置副本为2.</span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'2'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'2'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"></span><br><span class="line">模拟表和数据: 由于生产环境数据不容易拉下来,这里用github上的一个示例数据,在两个库都建立这样的表. </span><br><span class="line">cqlsh 192.168.6.52 -f ~/github/cassandra-bulkload-example/forseti_schema.cql</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> historical_prices (</span><br><span class="line">    ticker <span class="keyword">ascii</span>,</span><br><span class="line">    <span class="built_in">date</span> <span class="keyword">timestamp</span>,</span><br><span class="line">    <span class="keyword">open</span> <span class="built_in">decimal</span>,</span><br><span class="line">    <span class="keyword">high</span> <span class="built_in">decimal</span>,</span><br><span class="line">    <span class="keyword">low</span> <span class="built_in">decimal</span>,</span><br><span class="line">    <span class="keyword">close</span> <span class="built_in">decimal</span>,</span><br><span class="line">    volume <span class="built_in">bigint</span>,</span><br><span class="line">    adj_close <span class="built_in">decimal</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (ticker, <span class="built_in">date</span>)</span><br><span class="line">) <span class="keyword">WITH</span> <span class="keyword">CLUSTERING</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="built_in">date</span> <span class="keyword">DESC</span>);</span></span><br><span class="line"></span><br><span class="line">导入数据到两个库中:</span><br><span class="line">cd github/cassandra-bulkload-example</span><br><span class="line">cp -r data/quote data/forseti</span><br><span class="line">cp -r data/quote data/forseti_fp</span><br><span class="line">sstableloader -d 192.168.6.52 data/forseti/historical_prices</span><br><span class="line">sstableloader -d 192.168.6.52 data/forseti_fp/historical_prices</span><br><span class="line"></span><br><span class="line">填充了数据后的集群状态:</span><br><span class="line">$ /usr/<span class="operator"><span class="keyword">install</span>/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/<span class="keyword">bin</span>/nodetool <span class="keyword">status</span></span><br><span class="line"><span class="comment">--  Address       Load       Tokens  Owns   Host ID                               Rack</span></span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">2.21</span> MB    <span class="number">256</span>     <span class="number">50.8</span>%  bb63b562-d19e-<span class="number">4</span>a38-<span class="number">8857</span>-aca7172e7c4c  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.22</span> MB    <span class="number">256</span>     <span class="number">49.2</span>%  <span class="number">4359446</span><span class="keyword">f</span>-<span class="number">7</span>c87-<span class="number">4e9</span>b-b2c3-<span class="number">624</span>af8924bb1  RAC1</span></span><br></pre></td></tr></table></figure>
<h4 id="使用cqlsh连接52(原数据中心)">使用cqlsh连接52(原数据中心)</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">✗ cqlsh 192.168.6.52</span><br><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti_fp.historical_prices limit 1;</span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices limit 1;</span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line"></span><br><span class="line">cqlsh:forseti&gt; select * from forseti_fp.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800' limit 1;</span><br><span class="line"> ticker </span>|<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span></span><br></pre></td></tr></table></figure>
<p>现在我们已经模拟了原数据中心的库和表,以及Topology.  下一步要做的是分离forseti_fp数据库到新的数据中心中: DC2: 56,57.  </p>
<h4 id="模拟新数据中心:_配置56,57为DC2">模拟新数据中心: 配置56,57为DC2</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">commitlog</span> &amp;&amp; <span class="title">sudo</span> <span class="title">rm</span> -<span class="title">rf</span> /<span class="title">var</span>/<span class="title">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span> &amp;&amp; <span class="title">sudo</span> <span class="title">rm</span> /<span class="title">var</span>/<span class="title">log</span>/<span class="title">cassandra</span>/*</span></span><br><span class="line">sudo chown -<span class="constant">R</span> <span class="symbol">admin:</span>admin /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span></span><br><span class="line">sudo chown -<span class="constant">R</span> <span class="symbol">admin:</span>admin /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span> /<span class="title">var</span>/<span class="title">log</span>/<span class="title">cassandra</span>/</span></span><br><span class="line"></span><br><span class="line">sudo -u admin vi /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/conf/cassandra.yaml</span><br><span class="line"><span class="symbol">endpoint_snitch:</span> <span class="constant">GossipingPropertyFileSnitch</span></span><br><span class="line">- <span class="symbol">seeds:</span> <span class="string">"192.168.6.52,192.168.6.56"</span></span><br><span class="line"><span class="symbol">cluster_name:</span> <span class="string">'forseti'</span></span><br><span class="line"></span><br><span class="line">这里的seeds为两个,分别是两个数据中心的种子节点. 如果只有<span class="number">56</span>节点, 则启动<span class="number">56</span>后,status查看只能看到本<span class="constant">DC</span>的节点,不会看到其他<span class="constant">DC</span>的节点.  </span><br><span class="line"></span><br><span class="line">修改为新的数据中心: <span class="constant">DC2</span> </span><br><span class="line"><span class="variable">$ </span>sudo -u admin vi /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/conf/cassandra-rackdc.properties</span><br><span class="line">dc=<span class="constant">DC2</span></span><br><span class="line">rack=<span class="constant">RAC1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里新数据中心的seeds添加了原数据中心的seeds节点. 但原数据中心的所有节点中并没有添加新数据中心的seeds.<br>这是为了不重启原数据中心的各个节点,因为原数据中心是线上环境,修改配置文件后需要重启.  </p>
</blockquote>
<p>暂时不启动新数据中心的两个节点, 因为一旦启动后, 原先的forseti,forseti_fp都配置了DC2为另外的数据中心. 会造成数据会写到了两个数据中心.<br>先关闭forseti只保留原数据中心, 而forseti_fp的暂时不用修改, 要保证fp的数据同时写到两个数据中心不中断.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC1'</span> : <span class="number">2</span> &#125;;</span></span><br></pre></td></tr></table></figure>
<h4 id="启动新数据中心的两个节点">启动新数据中心的两个节点</h4><p>并在原数据中心和新数据中心节点查看状态: 可以看到满足了我们最初的拓扑图.   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u admin /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/cassandra</span><br><span class="line"></span><br><span class="line">$ /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool status</span><br><span class="line">Datacenter: DC2</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>  <span class="number">259.52</span> KB  <span class="number">256</span>     <span class="number">26.0</span>%  <span class="number">1</span>c1e0213-<span class="number">16</span>d7-<span class="number">40</span>b5-a560-<span class="number">3</span>d56d0329744  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>  <span class="number">301.96</span> KB  <span class="number">256</span>     <span class="number">25.5</span>%  <span class="number">687f</span>3f54-a087-<span class="number">4f</span>a4-<span class="number">97</span>ef-be338d0c8152  RAC1</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">2.25</span> MB    <span class="number">256</span>     <span class="number">24.5</span>%  bb63b562-d19e-<span class="number">4</span>a38-<span class="number">8857</span>-aca7172e7c4c  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.24</span> MB    <span class="number">256</span>     <span class="number">23.9</span>%  <span class="number">4359446f</span>-<span class="number">7</span>c87-<span class="number">4e9</span>b-b2c3-<span class="number">624</span>af8924bb1  RAC1</span><br></pre></td></tr></table></figure>
<p>从上面的Load可以看出来, 数据还是在DC1中. DC2还没有数据. 但是表结构对应的文件夹会自动在新数据中心建立起来,只是没有数据文件而已:  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">原数据中心的数据文件:  </span><br><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> conf]<span class="variable">$ </span> ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti</span>/<span class="title">historical_prices</span>/</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">1072677</span> <span class="number">9</span>月  <span class="number">11</span> <span class="number">16</span>:<span class="number">32</span> forseti-historical_prices-jb-<span class="number">1</span>-<span class="constant">Data</span>.db</span><br><span class="line"></span><br><span class="line">新数据中心还没有数据文件:  </span><br><span class="line">[qihuang.zheng<span class="variable">@dp0656</span> install]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti</span>/<span class="title">historical_prices</span>/</span></span><br><span class="line">总用量 <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>但是我们使用cqlsh 192.168.6.56连接新数据中心的节点, 看不到forseti_fp的数据了, 却仍然可以看到forseti的数据:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cqlsh&gt; select * from forseti.historical_prices limit <span class="number">1</span>;</span><br><span class="line"> ticker | date                     | adj_close | close     | high  | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015</span>-<span class="number">06</span>-<span class="number">24</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>+<span class="number">0800</span> | <span class="number">41.200001</span> | <span class="number">41.200001</span> | <span class="number">41.77</span> | <span class="number">41.200001</span> | <span class="number">41.540001</span> | <span class="number">17689400</span></span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices limit <span class="number">2</span>;</span><br><span class="line">(<span class="number">0</span> rows)</span><br></pre></td></tr></table></figure>
<p>按照我们的理解, 我们把forseti设置为DC1, forseti_fp为DC1,DC2. 使用cqlsh连接56(所在的DC是DC2),<br>应该查询不到forseti,可以查询到forseti_fp才对, 但是结果却是相反的! </p>
<blockquote>
<p>实际上这跟forseti修改为DC1没有关系. 过一段时间后就可以查询了. <strong>那么问题是这段时间Cassandra都在干什么?</strong><br>因为新数据中心配置了原数据中心的seeds,所以cqlsh虽然连接的是新数据中心, 但是在新数据中心查询不到数据的情况下, 会去原数据中心查询.<br>而原数据中心对于forseti,forseti_fp的数据都是存在的.<br>也就是说无论查询集群中的哪个节点, 或者说集群中两个数据中心的哪个节点, Cassandra返回给我们的数据都是一样的.   </p>
</blockquote>
<h4 id="修改forseti_fp的副本策略">修改forseti_fp的副本策略</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'DC2'</span> : <span class="number">2</span> &#125;;</span></span><br></pre></td></tr></table></figure>
<p>现在我们已经把forseti设置为DC1, forseti_fp设置为DC2了. 但是数据文件还是没有发生变化的.  </p>
<p>连接原数据中心, 查询forseti,forseti_fp:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">✗ cqlsh <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span></span><br><span class="line">cqlsh&gt; select * from forseti.historical_prices limit <span class="number">1</span>;</span><br><span class="line"> ticker | date                     | adj_close | close     | high  | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015</span>-<span class="number">06</span>-<span class="number">24</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>+<span class="number">0800</span> | <span class="number">41.200001</span> | <span class="number">41.200001</span> | <span class="number">41.77</span> | <span class="number">41.200001</span> | <span class="number">41.540001</span> | <span class="number">17689400</span></span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices limit <span class="number">1</span>;</span><br><span class="line">Unable to complete request: one or more nodes were unavailable.</span><br></pre></td></tr></table></figure>
<p>开启cql跟踪: tracing on; </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line">(1 rows)</span><br><span class="line"></span><br><span class="line">Tracing session: afa2c320-586c-11e5-835a-0d61415b64a2</span><br><span class="line"> activity                                                                                                             </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                                                   execute_cql3_query </span>|<span class="string"> 18:05:53,109 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">              0</span><br><span class="line"> Parsing select * from forseti.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800' LIMIT 10000; </span>|<span class="string"> 18:05:53,109 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            476</span><br><span class="line">                                                                                                  Preparing statement </span>|<span class="string"> 18:05:53,110 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">           1546</span><br><span class="line">                                                                Executing single-partition query on historical_prices </span>|<span class="string"> 18:05:53,121 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          11969</span><br><span class="line">                                                                                         Acquiring sstable references </span>|<span class="string"> 18:05:53,122 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          12963</span><br><span class="line">                                                                                          Merging memtable tombstones </span>|<span class="string"> 18:05:53,122 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          13238</span><br><span class="line">                                                                                          Key cache hit for sstable 1 </span>|<span class="string"> 18:05:53,123 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          14084</span><br><span class="line">                                                                    Seeking to partition indexed section in data file </span>|<span class="string"> 18:05:53,123 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          14118</span><br><span class="line">                                            Skipped 0/1 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 18:05:53,123 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          14747</span><br><span class="line">                                                                           Merging data from memtables and 1 sstables </span>|<span class="string"> 18:05:53,124 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          15035</span><br><span class="line">                                                                                    Read 1 live and 0 tombstone cells </span>|<span class="string"> 18:05:53,129 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          20083</span><br><span class="line">                                                                                                     Request complete </span>|<span class="string"> 18:05:53,376 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">         267308</span><br><span class="line"></span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line">Unable to complete request: one or more nodes were unavailable.</span><br><span class="line">cqlsh&gt; select * from forseti_fp.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> activity                                                                                                                </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                                                      execute_cql3_query </span>|<span class="string"> 18:06:47,288 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">              0</span><br><span class="line"> Parsing select * from forseti_fp.historical_prices where ticker='ORCL' and date='2015-06-24 00:00:00+0800' LIMIT 10000; </span>|<span class="string"> 18:06:47,289 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">           1170</span><br><span class="line">                                                                                     Message received from /192.168.6.52 </span>|<span class="string"> 18:06:47,291 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">             68</span><br><span class="line">                                                                   Executing single-partition query on historical_prices </span>|<span class="string"> 18:06:47,293 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           1469</span><br><span class="line">                                                                                            Acquiring sstable references </span>|<span class="string"> 18:06:47,293 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           1534</span><br><span class="line">                                                                                             Merging memtable tombstones </span>|<span class="string"> 18:06:47,293 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           1646</span><br><span class="line">                                               Skipped 0/0 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 18:06:47,293 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           1731</span><br><span class="line">                                                                                     Enqueuing response to /192.168.6.52 </span>|<span class="string"> 18:06:47,293 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           2101</span><br><span class="line">                                                                                        Sending message to /192.168.6.52 </span>|<span class="string"> 18:06:47,294 </span>|<span class="string"> 192.168.6.57 </span>|<span class="string">           2536</span><br><span class="line">                                                                                                     Preparing statement </span>|<span class="string"> 18:06:47,296 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">           7840</span><br><span class="line">                                                                                        Sending message to /192.168.6.57 </span>|<span class="string"> 18:06:47,342 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          53514</span><br><span class="line">                                                                                     Message received from /192.168.6.57 </span>|<span class="string"> 18:06:47,357 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          69156</span><br><span class="line">                                                                                  Processing response from /192.168.6.57 </span>|<span class="string"> 18:06:47,357 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          69253</span><br><span class="line">                                                                                                        Request complete </span>|<span class="string"> 18:06:47,363 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          75114</span></span><br></pre></td></tr></table></figure>
<p>forseti_fp为什么找不到数据, 因为Executing single-partition query on historical_prices是在57节点,<br>而56,57属于新数据中心,这两个节点上没有数据文件,导致查询不到数据. 那么为什么它不会链接到52上呢, 就像查询forseti一样.  </p>
<p>连接新数据中心:  </p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">✗ cqlsh <span class="number">192.168</span>.<span class="number">6.56</span></span><br><span class="line">cqlsh&gt; <span class="keyword">select</span> * <span class="keyword">from</span> forseti.historical_prices <span class="keyword">where</span> ticker=<span class="string">'ORCL'</span> <span class="keyword">and</span> date=<span class="string">'2015-06-24 00:00:00+0800'</span>;</span><br><span class="line">Request did <span class="keyword">not</span> complete within rpc_timeout.</span><br><span class="line"></span><br><span class="line">cqlsh&gt; <span class="keyword">select</span> * <span class="keyword">from</span> forseti.historical_prices <span class="keyword">where</span> ticker=<span class="string">'ORCL'</span> <span class="keyword">and</span> date=<span class="string">'2015-06-24 00:00:00+0800'</span>;</span><br><span class="line">Unable <span class="keyword">to</span> complete request: one <span class="keyword">or</span> more nodes were unavailable.</span><br><span class="line"></span><br><span class="line">cqlsh&gt; <span class="keyword">select</span> * <span class="keyword">from</span> forseti.historical_prices <span class="keyword">where</span> ticker=<span class="string">'ORCL'</span> <span class="keyword">and</span> date=<span class="string">'2015-06-24 00:00:00+0800'</span>;</span><br><span class="line"> ticker | date                     | adj_close | close     | high  | low       | open      | volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL | <span class="number">2015</span>-<span class="number">06</span>-<span class="number">24</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>+<span class="number">0800</span> | <span class="number">41.200001</span> | <span class="number">41.200001</span> | <span class="number">41.77</span> | <span class="number">41.200001</span> | <span class="number">41.540001</span> | <span class="number">17689400</span></span><br><span class="line">(<span class="number">1</span> rows)</span><br><span class="line"></span><br><span class="line">cqlsh&gt; <span class="keyword">select</span> * <span class="keyword">from</span> forseti_fp.historical_prices <span class="keyword">where</span> ticker=<span class="string">'ORCL'</span> <span class="keyword">and</span> date=<span class="string">'2015-06-24 00:00:00+0800'</span>;</span><br><span class="line">(<span class="number">0</span> rows)</span><br></pre></td></tr></table></figure>
<h4 id="JMX_Port_7199">JMX Port 7199</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">先启动种子节点<span class="number">52</span>, 查看状态. 可以看到<span class="number">53</span>是<span class="constant">DN</span>, 还有一个地方<span class="constant">Rack</span>是r1, 而不是<span class="constant">RAC1</span>. 说明读取的是cassandra-topology.properties,而不是cassandra-rackdc.properties.  </span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool status</span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span>   <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">1.41</span> <span class="constant">MB</span>    <span class="number">256</span>     <span class="number">51.1</span>%  <span class="number">500e25</span>aa-d7ab-<span class="number">43</span>ae-b084-<span class="number">4</span>c1cd7480694  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">DN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  ?          <span class="number">256</span>     <span class="number">48.9</span>%  <span class="number">9</span>af2b767-b1ee-<span class="number">42</span>d5-b5c0-e558ea2ddfc8  r1</span><br><span class="line"></span><br><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool status</span><br><span class="line"><span class="constant">Datacenter</span>: <span class="constant">DC1</span></span><br><span class="line">===============</span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span>   <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span>   <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">1.36</span> <span class="constant">MB</span>    <span class="number">256</span>     <span class="number">51.1</span>%  <span class="number">500e25</span>aa-d7ab-<span class="number">43</span>ae-b084-<span class="number">4</span>c1cd7480694  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  <span class="number">146.94</span> <span class="constant">KB</span>  <span class="number">256</span>     <span class="number">48.9</span>%  <span class="number">9</span>af2b767-b1ee-<span class="number">42</span>d5-b5c0-e558ea2ddfc8  <span class="constant">RAC1</span></span><br><span class="line">可以看到因为副本数=<span class="number">1</span>, 而集群节点数为<span class="number">2</span>, 这样写入时, 只会写入一个节点, 因此上面两个节点的负载是不一样的, 也可以查看两个节点的数据文件大小:</span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti</span>/<span class="title">historical_prices</span>/ -<span class="title">h</span></span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">615</span>K <span class="number">9</span>月  <span class="number">12</span> <span class="number">10</span>:<span class="number">35</span> forseti-historical_prices-jb-<span class="number">1</span>-<span class="constant">Data</span>.db</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti_fp</span>/<span class="title">historical_prices</span>/ -<span class="title">h</span></span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">615</span>K <span class="number">9</span>月  <span class="number">12</span> <span class="number">10</span>:<span class="number">35</span> forseti_fp-historical_prices-jb-<span class="number">1</span>-<span class="constant">Data</span>.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> ~]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti</span>/<span class="title">historical_prices</span>/ -<span class="title">h</span></span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">433</span>K <span class="number">9</span>月  <span class="number">12</span> <span class="number">10</span>:<span class="number">35</span> forseti-historical_prices-jb-<span class="number">1</span>-<span class="constant">Data</span>.db</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> ~]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">forseti_fp</span>/<span class="title">historical_prices</span>/ -<span class="title">h</span></span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">433</span>K <span class="number">9</span>月  <span class="number">12</span> <span class="number">10</span>:<span class="number">35</span> forseti_fp-historical_prices-jb-<span class="number">1</span>-<span class="constant">Data</span>.db</span><br><span class="line"></span><br><span class="line">不过有个奇怪的问题, 过段时间后, 分别在<span class="number">52</span>,<span class="number">53</span>上查询, 对方的节点都是<span class="constant">DN</span>.  </span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool status</span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span>   <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">1.36</span> <span class="constant">MB</span>    <span class="number">256</span>     <span class="number">51.1</span>%  <span class="number">500e25</span>aa-d7ab-<span class="number">43</span>ae-b084-<span class="number">4</span>c1cd7480694  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">DN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  <span class="number">1</span> <span class="constant">MB</span>       <span class="number">256</span>     <span class="number">48.9</span>%  <span class="number">9</span>af2b767-b1ee-<span class="number">42</span>d5-b5c0-e558ea2ddfc8  <span class="constant">RAC1</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool status</span><br><span class="line"><span class="constant">DN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">1.36</span> <span class="constant">MB</span>    <span class="number">256</span>     <span class="number">51.1</span>%  <span class="number">500e25</span>aa-d7ab-<span class="number">43</span>ae-b084-<span class="number">4</span>c1cd7480694  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  <span class="number">1</span> <span class="constant">MB</span>       <span class="number">256</span>     <span class="number">48.9</span>%  <span class="number">9</span>af2b767-b1ee-<span class="number">42</span>d5-b5c0-e558ea2ddfc8  <span class="constant">RAC1</span></span><br><span class="line"></span><br><span class="line">后台日志: <span class="regexp">/var/log</span><span class="regexp">/cassandra/system</span>.<span class="symbol">log:</span>  </span><br><span class="line"><span class="constant">INFO</span> [<span class="constant">HANDSHAKE</span>-<span class="regexp">/192.168.6.53] 2015-09-12 11:04:42,794 OutboundTcpConnection.java (line 398) Cannot handshake version with /</span><span class="number">192.168</span>.<span class="number">6.53</span></span><br><span class="line"><span class="constant">INFO</span> [<span class="constant">HANDSHAKE</span>-<span class="regexp">/192.168.6.53] 2015-09-12 11:04:42,795 OutboundTcpConnection.java (line 389) Handshaking version with /</span><span class="number">192.168</span>.<span class="number">6.53</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool -h <span class="number">192.168</span>.<span class="number">6.53</span> status</span><br><span class="line"><span class="constant">Failed</span> to connect to <span class="string">'192.168.6.53:7199'</span>: 拒绝连接</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool -h <span class="number">192.168</span>.<span class="number">6.52</span> status</span><br><span class="line"><span class="constant">Failed</span> to connect to <span class="string">'192.168.6.52:7199'</span>: 拒绝连接</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>netstat -anpt|grep <span class="number">7199</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7199</span>              <span class="number">0.0</span>.<span class="number">0.0</span>:*                   <span class="constant">LISTEN</span>      -</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool -h localhost status</span><br><span class="line">--  <span class="constant">Address</span>       <span class="constant">Load</span>       <span class="constant">Tokens</span>  <span class="constant">Owns</span>   <span class="constant">Host</span> <span class="constant">ID</span>                               <span class="constant">Rack</span></span><br><span class="line"><span class="constant">UN</span>  <span class="number">192.168</span>.<span class="number">6.52</span>  <span class="number">1.36</span> <span class="constant">MB</span>    <span class="number">256</span>     <span class="number">51.1</span>%  <span class="number">500e25</span>aa-d7ab-<span class="number">43</span>ae-b084-<span class="number">4</span>c1cd7480694  <span class="constant">RAC1</span></span><br><span class="line"><span class="constant">DN</span>  <span class="number">192.168</span>.<span class="number">6.53</span>  <span class="number">1</span> <span class="constant">MB</span>       <span class="number">256</span>     <span class="number">48.9</span>%  <span class="number">9</span>af2b767-b1ee-<span class="number">42</span>d5-b5c0-e558ea2ddfc8  <span class="constant">RAC1</span></span><br><span class="line"></span><br><span class="line">正常的<span class="number">7199</span>连接端口示例(线上环境)</span><br><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>netstat -anpt|grep <span class="number">7199</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">7199</span>                <span class="number">0.0</span>.<span class="number">0.0</span>:*                   <span class="constant">LISTEN</span>      -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">7199</span>         <span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">55267</span>        <span class="constant">ESTABLISHED</span> -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">7199</span>         <span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">55298</span>        <span class="constant">ESTABLISHED</span> -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">54966</span>      ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7199</span>       <span class="constant">TIME_WAIT</span>   -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">55292</span> ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">7199</span>  <span class="constant">TIME_WAIT</span>   -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">55291</span> ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">47.202</span>:<span class="number">7199</span>  <span class="constant">TIME_WAIT</span>   -</span><br><span class="line"></span><br><span class="line">所以问题是: <span class="number">7199</span>使用<span class="number">127.0</span>.<span class="number">0.1</span>,导致其他机器无法连接. 线上的配置, 在cassandra-env.sh中多了配置.  </span><br><span class="line">./cassandra-env.<span class="symbol">sh:</span><span class="constant">JVM_OPTS</span>=<span class="string">"$JVM_OPTS -Djava.rmi.server.hostname=192.168.47.202"</span></span><br><span class="line"></span><br><span class="line">所以我们也要给线下的所有节点, 都添加上指向<span class="constant">IP</span>地址的<span class="constant">JMX</span>, 如果没有配置, 默认用的就是<span class="number">127.0</span>.<span class="number">0.1</span>.  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>sudo -u admin vi /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/conf/cassandra-env.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># jmx: metrics and administration interface</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># add this if you're having trouble connecting:</span></span><br><span class="line"><span class="constant">JVM_OPTS</span>=<span class="string">"$JVM_OPTS -Djava.rmi.server.hostname=&lt;public name&gt;"</span></span><br><span class="line"></span><br><span class="line">改成: </span><br><span class="line"><span class="constant">JVM_OPTS</span>=<span class="string">"$JVM_OPTS -Djava.rmi.server.hostname=192.168.6.52"</span></span><br><span class="line"></span><br><span class="line">但是重启之后, 貌似还是没起作用. 最后是换成<span class="number">2.0</span>.<span class="number">15</span>才可以:</span><br><span class="line"><span class="variable">$ </span>netstat -anpt|grep <span class="number">7199</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">7199</span>                <span class="number">0.0</span>.<span class="number">0.0</span>:*                   <span class="constant">LISTEN</span>      -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">6.52</span>:<span class="number">43522</span>   ::<span class="symbol">ffff:</span><span class="number">192.168</span>.<span class="number">6.52</span>:<span class="number">7199</span>    <span class="constant">TIME_WAIT</span>   -</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">54926</span>      ::<span class="symbol">ffff:</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7199</span>       <span class="constant">TIME_WAIT</span>   -</span><br></pre></td></tr></table></figure>
<h4 id="tracing_on">tracing on</h4><p>使用下面的第二种方案DC1, DC3, 查看节点状态发现53Load很高, 而52根本没有Load.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">Datacenter: DC1</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>  <span class="number">147.06</span> KB  <span class="number">256</span>     <span class="number">26.0</span>%  <span class="number">19799</span>dc0-a25b-<span class="number">46f</span>8-<span class="number">930f</span>-c2a5ea6687df  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>  <span class="number">2.21</span> MB    <span class="number">256</span>     <span class="number">25.8</span>%  fbccd93f-<span class="number">3</span>d0d-<span class="number">4e1</span>e-<span class="number">9696</span>-d3d1f2c6d380  RAC1</span><br><span class="line">Datacenter: DC3</span><br><span class="line">===============</span><br><span class="line">--  Address       Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>  <span class="number">206.38</span> KB  <span class="number">256</span>     <span class="number">22.5</span>%  a51114e7-c17f-<span class="number">48</span>c9-a72e-<span class="number">679f</span>3f3ad291  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>  <span class="number">282.82</span> KB  <span class="number">256</span>     <span class="number">25.6</span>%  <span class="number">319e9</span>e84-d38b-<span class="number">4</span>cd5-<span class="number">898f</span>-<span class="number">8e2</span>b3661f05f  RAC1</span><br><span class="line"></span><br><span class="line">虽然导入数据的目标节点是<span class="number">52</span>, 但是貌似数据都保存在了<span class="number">53</span>节点(<span class="number">2.21</span>MB), 也就是所有数据都写到了<span class="number">53</span>节点去了.</span><br><span class="line">[qihuang.zheng@dp0652 ~]$ ll /home/admin/cassandra/data/forseti_fp/historical_prices/ -h</span><br><span class="line">总用量 <span class="number">0</span></span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ll /home/admin/cassandra/data/forseti/historical_prices/ -h</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">1.1</span>M <span class="number">9</span>月  <span class="number">12</span> <span class="number">15</span>:<span class="number">02</span> forseti-historical_prices-jb-<span class="number">1</span>-Data.db</span><br></pre></td></tr></table></figure>
<p>连接实际保存数据的节点53, 53节点是客户端, 又是实际存储数据的节点, 所以直接请求并返回给客户端.   </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  cqlsh 192.168.6.53</span><br><span class="line">cqlsh&gt; tracing on;</span><br><span class="line">Now tracing requests.</span><br><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800';</span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line">(1 rows)</span><br><span class="line"></span><br><span class="line">Tracing session: 62e531e0-5933-11e5-aa9e-e9aa4e8ac5e8</span><br><span class="line"> activity                                                                                                                 </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                                                       execute_cql3_query </span>|<span class="string"> 17:48:14,208 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">              0</span><br><span class="line"> Parsing select * from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800' LIMIT 10000; </span>|<span class="string"> 17:48:14,208 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            123</span><br><span class="line">                                                                                                      Preparing statement </span>|<span class="string"> 17:48:14,208 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            347</span><br><span class="line">                                                                    Executing single-partition query on historical_prices </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3250</span><br><span class="line">                                                                                             Acquiring sstable references </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3309</span><br><span class="line">                                                                                              Merging memtable tombstones </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3376</span><br><span class="line">                                                                                              Key cache hit for sstable 1 </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3540</span><br><span class="line">                                                                        Seeking to partition indexed section in data file </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3559</span><br><span class="line">                                                Skipped 0/1 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3641</span><br><span class="line">                                                                               Merging data from memtables and 1 sstables </span>|<span class="string"> 17:48:14,211 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           3663</span><br><span class="line">                                                                                        Read 1 live and 0 tombstone cells </span>|<span class="string"> 17:48:14,212 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           4473</span><br><span class="line">                                                                                                         Request complete </span>|<span class="string"> 17:48:14,212 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           4906</span></span><br></pre></td></tr></table></figure>
<p>连接并没有保存实际数据的节点52, 但是由于在一个集群内, 客户端会请求实际存有数据的节点53, 并通过52节点返回给客户端.    </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  cqlsh 192.168.6.52</span><br><span class="line">cqlsh&gt; tracing on;</span><br><span class="line">Now tracing requests.</span><br><span class="line">cqlsh&gt; select <span class="keyword">*</span> from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800' limit 1;</span><br><span class="line"> ticker |<span class="string"> date                     </span>|<span class="string"> adj_close </span>|<span class="string"> close     </span>|<span class="string"> high  </span>|<span class="string"> low       </span>|<span class="string"> open      </span>|<span class="string"> volume</span><br><span class="line">--------+--------------------------+-----------+-----------+-------+-----------+-----------+----------</span><br><span class="line">   ORCL </span>|<span class="string"> 2015-06-24 00:00:00+0800 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.77 </span>|<span class="string"> 41.200001 </span>|<span class="string"> 41.540001 </span>|<span class="string"> 17689400</span><br><span class="line">(1 rows)</span><br><span class="line"></span><br><span class="line">Tracing session: 27154e20-5933-11e5-bd56-0d61415b64a2</span><br><span class="line"> activity                                                                                                             </span>|<span class="string"> timestamp    </span>|<span class="string"> source       </span>|<span class="string"> source_elapsed</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------+--------------+--------------+----------------</span><br><span class="line">                                                                                                   execute_cql3_query </span>|<span class="string"> 17:46:33,860 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">              0</span><br><span class="line">                                                                                  Message received from /192.168.6.52 </span>|<span class="string"> 17:46:33,843 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">             62</span><br><span class="line">                                                                Executing single-partition query on historical_prices </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            221</span><br><span class="line">                                                                                         Acquiring sstable references </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            242</span><br><span class="line">                                                                                          Merging memtable tombstones </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            313</span><br><span class="line">                                                                                          Key cache hit for sstable 1 </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            639</span><br><span class="line">                                                                    Seeking to partition indexed section in data file </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            660</span><br><span class="line">                                            Skipped 0/1 non-slice-intersecting sstables, included 0 due to tombstones </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            753</span><br><span class="line">                                                                           Merging data from memtables and 1 sstables </span>|<span class="string"> 17:46:33,844 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">            776</span><br><span class="line">                                                                                    Read 1 live and 0 tombstone cells </span>|<span class="string"> 17:46:33,845 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1630</span><br><span class="line">                                                                                  Enqueuing response to /192.168.6.52 </span>|<span class="string"> 17:46:33,845 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           1791</span><br><span class="line">                                                                                     Sending message to /192.168.6.52 </span>|<span class="string"> 17:46:33,846 </span>|<span class="string"> 192.168.6.53 </span>|<span class="string">           2139</span><br><span class="line"> Parsing select * from forseti_fp.historical_prices where  ticker='ORCL' and date='2015-06-24 00:00:00+0800' limit 1; </span>|<span class="string"> 17:46:33,860 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            114</span><br><span class="line">                                                                                                  Preparing statement </span>|<span class="string"> 17:46:33,860 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">            396</span><br><span class="line">                                                                                     Sending message to /192.168.6.53 </span>|<span class="string"> 17:46:33,868 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">           8187</span><br><span class="line">                                                                                  Message received from /192.168.6.53 </span>|<span class="string"> 17:46:33,871 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          11304</span><br><span class="line">                                                                               Processing response from /192.168.6.53 </span>|<span class="string"> 17:46:33,871 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          11483</span><br><span class="line">                                                                                                     Request complete </span>|<span class="string"> 17:46:33,872 </span>|<span class="string"> 192.168.6.52 </span>|<span class="string">          12230</span></span><br></pre></td></tr></table></figure>
<p>上面的两个执行计划可以看出Executing single-partition query on historical_prices都是在53节点, 因为53节点保存了数据. </p>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/">Cassandra数据迁移2 多数据中心数据迁移</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年08月28日 - 00时00分</p>
  <p><span>最后更新:</span>2015年12月19日 - 16时30分</p>
  <p>
    <span>原始链接:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/" title="Cassandra数据迁移2 多数据中心数据迁移">http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration2_DC2/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration4_Product/">
        Cassandra数据迁移4 多数据中心数据迁移后进行集群隔离
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/">
        Apache Cassandra架构理解
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#多数据中心数据迁移"><span class="toc-number">1.</span> <span class="toc-text">多数据中心数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线下环境测试方案1:_DC1,_DC2"><span class="toc-number">1.1.</span> <span class="toc-text">线下环境测试方案1: DC1, DC2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#模拟原数据中心:_52,53上创建forseti集群"><span class="toc-number">1.1.1.</span> <span class="toc-text">模拟原数据中心: 52,53上创建forseti集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模拟原集群的数据中心的库表和数据-"><span class="toc-number">1.1.2.</span> <span class="toc-text">模拟原集群的数据中心的库表和数据.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用cqlsh连接52(原数据中心)"><span class="toc-number">1.1.3.</span> <span class="toc-text">使用cqlsh连接52(原数据中心)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模拟新数据中心:_配置56,57为DC2"><span class="toc-number">1.1.4.</span> <span class="toc-text">模拟新数据中心: 配置56,57为DC2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动新数据中心的两个节点"><span class="toc-number">1.1.5.</span> <span class="toc-text">启动新数据中心的两个节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改forseti_fp的副本策略"><span class="toc-number">1.1.6.</span> <span class="toc-text">修改forseti_fp的副本策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMX_Port_7199"><span class="toc-number">1.1.7.</span> <span class="toc-text">JMX Port 7199</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tracing_on"><span class="toc-number">1.1.8.</span> <span class="toc-text">tracing on</span></a></li></ol></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
</script>


<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/08/28/2015-08-28-Cassandra-Migration4_Product/" title="上一篇: Cassandra数据迁移4 多数据中心数据迁移后进行集群隔离">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/" title="下一篇: Apache Cassandra架构理解">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2015 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>