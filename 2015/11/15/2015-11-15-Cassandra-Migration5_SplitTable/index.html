<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra数据迁移 分离表 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="根据查询维度分离业务表. 将原来的一张表拆分成多张表.">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra数据迁移 分离表">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="根据查询维度分离业务表. 将原来的一张表拆分成多张表.">
<meta property="og:image" content="http://img.blog.csdn.net/20151027162604343">
<meta property="og:image" content="http://img.blog.csdn.net/20151027165637255">
<meta property="og:updated_time" content="2015-12-19T13:14:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra数据迁移 分离表">
<meta name="twitter:description" content="根据查询维度分离业务表. 将原来的一张表拆分成多张表.">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/cassandra/" style="font-size: 20px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 18.33px;">drill</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/hbase/" style="font-size: 16.67px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/kafka/" style="font-size: 11.67px;">kafka</a> <a href="/tags/scala/" style="font-size: 13.33px;">scala</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/storm/" style="font-size: 16.67px;">storm</a> <a href="/tags/timeseries/" style="font-size: 13.33px;">timeseries</a> <a href="/tags/work/" style="font-size: 13.33px;">work</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-11-15-Cassandra-Migration5_SplitTable" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/" class="article-date">
  	<time datetime="2015-11-14T16:00:00.000Z" itemprop="datePublished">2015-11-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra数据迁移 分离表
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>根据查询维度分离业务表. 将原来的一张表拆分成多张表.  </p>
<a id="more"></a>
<ul>
<li>Tasks TODO:  <ul>
<li>将velocity拆成三张表</li>
<li>设置velocity的TTL为半年</li>
</ul>
<ul>
<li>将velocity和指标表独立开来, 分集群,或分数据中心</li>
<li>异地双活  </li>
</ul>
</li>
</ul>
<h2 id="为什么要分离velocity表和指标表?">为什么要分离velocity表和指标表?</h2><p>原先的forseti keyspace把velocity表和指标表都放在一起. velocity的数据对API比较重要.<br>而指标表在计算时对整个Cassandra集群影响比较大, 而且指标数据不需要及时查看. 考虑分离这两部分数据.<br>原有集群配置: forseti_cluster中DC2是备用数据中心. DC1存放forseti, DC3存放forseti_fp.<br>通过设置不同的DC, 这样数据仍然在一个集群中, 分为不同的数据中心.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'3'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC3'</span>: <span class="string">'3'</span></span><br><span class="line">&#125;;</span></span><br></pre></td></tr></table></figure>
<h2 id="拆分velocity表">拆分velocity表</h2><h3 id="背景:_原有表结构">背景: 原有表结构</h3><p>1.查询应用, 显示最近的1000条:   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">and</span> partner_code=? <span class="keyword">and</span> app_name=? <span class="keyword">and</span> <span class="keyword">type</span>=? </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> partner_code <span class="keyword">desc</span>,app_name <span class="keyword">desc</span>,<span class="keyword">type</span> <span class="keyword">desc</span>,<span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span></span></span><br></pre></td></tr></table></figure>
<p>2.查询全局, 显示所有合作方, 最近的1000条数据: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2.1 <span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">order</span> <span class="keyword">by</span> partner_code <span class="keyword">desc</span>,app_name <span class="keyword">desc</span>,<span class="keyword">type</span> <span class="keyword">desc</span>,<span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span></span><br><span class="line"><span class="number">2.2</span> <span class="keyword">select</span> * <span class="keyword">from</span> velocity <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span></span></span><br></pre></td></tr></table></figure>
<p>按照业务逻辑, 正确的应该是2.2(全局时间倒排时,不考虑合作方), 但是2.2在C*中语法错误: 在使用clustering key排序时, 必须指定所有的clustering key.<br>2.1虽然语法正确, 但是不符合业务逻辑. </p>
<h3 id="将velocity按照scope拆分成三张表">将velocity按照scope拆分成三张表</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">velocity_app:     PRIMARY KEY ((<span class="operator">attribute</span>, partner_code, app_name, <span class="operator">type</span>), <span class="string">"timestamp"</span>)</span><br><span class="line">velocity_partner: PRIMARY KEY ((<span class="operator">attribute</span>, partner_code), <span class="string">"timestamp"</span>)</span><br><span class="line">velocity_global:  PRIMARY KEY ((<span class="operator">attribute</span>), <span class="string">"timestamp"</span>)</span><br></pre></td></tr></table></figure>
<p>查询不同的scope分别查询不同的表, 按照时间倒排查询:   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.应用内: <span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity_app <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">and</span> partner_code=? <span class="keyword">and</span> app_name=? <span class="keyword">and</span> <span class="keyword">type</span>=? <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span>;</span></span><br><span class="line">2.合作方: <span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity_partner <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">and</span> partner_code=? <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span>;</span></span><br><span class="line">3.全局的: <span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity_global <span class="keyword">where</span> <span class="keyword">attribute</span>=? <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span>;</span></span><br></pre></td></tr></table></figure>
<h3 id="拆分的初步方案">拆分的初步方案</h3><p>由于<code>velocity的表结构发生变化</code>, 所以考虑把velocity表迁移出去. 其他表仍保留在原有库中.  </p>
<blockquote>
<p>既要分离表, 也要对velocity表进行拆分, 哪个先做?<br>将velocity拆表之后, velocity的数据还是要进行同步, 所以先分离表!</p>
</blockquote>
<p>改造前:<br>forseti[DC1]: velocity + 指标表 </p>
<p>改造后:<br>forseti[DC1]: 指标表,  velocity可以保留,在代码中使用开关切换.<br>forseti_velocity[DC4]: velocity_app, velocity_partner, velocity_global</p>
<p>影响: <code>velocity表的读写</code>:<br>读取velocity表的keyspace更改为<code>forseti_velocity</code>, 读取指标表的keyspace不变.    </p>
<p>操作步骤: </p>
<p>1.可以先建表:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti_velocity <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'2'</span>,</span><br><span class="line">  <span class="string">'DC_VELO'</span>: <span class="string">'3'</span></span><br><span class="line">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">use</span> forseti_velocity;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> velocity_app ...</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> velocity_partner ...</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> velocity_global ...</span></span><br></pre></td></tr></table></figure>
<ol>
<li>下线原DC1的6-10节点一共5个节点:  /usr/install/cassandra/bin/nodetool decommission -h 192.168.xxx<br>下线6-10节点时,会将这些节点的数据自动同步到1-5节点. 使用status查看所有节点正常说明同步完毕<br>注意: 由于节点数变少, 会对集群的读写有影响; 而且下线过程会比较慢.  </li>
<li><p>将下线节点cassandra-rackdc.properties的DC更改为forseti_velocity使用的DC4(DC_VELO), 并启动所有节点</p>
</li>
<li><p><strong>Kafka的Consumer同时写入数据到forseti的velocity和forseti_velocity的三张表.</strong><br>SQL语句都一样,因为表结构只有主键变化. forseti_velocity三张表的TTL为半年. </p>
</li>
<li><strong>同步Consumer写入forseti_velocity之前的数据: 使用ES同步到Cassandra中, 读取T3之前的数据写入到forseti_velocity的三张表.</strong></li>
<li>T4同步完毕后, velocity的读写都走新的三张表.  </li>
</ol>
<blockquote>
<p>为什么要下线5个节点: 因为在迁移的过程中要保证forseti.velocity仍然可以使用.<br>而在forseti_velocity的三张表同步完毕后, 也要立即被使用.  </p>
</blockquote>
<h2 id="数据迁移方案">数据迁移方案</h2><p>[-] 方案1: 使用sstableloader: <a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/tools/toolsBulkloader_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/tools/toolsBulkloader_t.html</a></p>
<p>sstableloader只适用于目标节点的表结构和指定的备份文件相同. 比如下面的命令表示将本机github/cassandra-bulkload-example/data/forseti/historical_prices<br>加载到192.168.6.52的forseti.historical_prices表. 前提是在192.168.6.52已经建立好forseti keyspace和historical_prices表.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd github/cassandra-bulkload-example</span><br><span class="line">sstableloader -d <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> data/forseti/historical_prices</span><br></pre></td></tr></table></figure>
<p>将velocity的数据拷贝到一个临时目录, 然后复制出三份:<br>/usr/install/cassandra/bin/sstableloader -d 192.168.6.52 ~/forseti/velocity_global</p>
<p>这种方式并<code>不会把数据load到velocity_global, 它写入的还是velocity表(相当于重复更新velocity表!)</code><br>即使把数据文件的forseti-velocity<em>更改为forseti-velocity_global</em>, 也会报错. </p>
<p>[-] 方案2: <a href="http://stackoverflow.com/questions/24298982/copy-one-table-to-another-in-cassandra" target="_blank" rel="external">http://stackoverflow.com/questions/24298982/copy-one-table-to-another-in-cassandra</a><br>将velocity拷贝成csv文件, 再拷贝到新表中. 但是velocity的数据量在一个节点都有400G.</p>
<p>方案3: 使用API查询velocity数据, 再写入到三张表中. 由于数据量很大, 显然不能直接查询全量数据, 可以采用分页.<br><a href="http://www.datastax.com/dev/blog/client-side-improvements-in-cassandra-2-0" target="_blank" rel="external">http://www.datastax.com/dev/blog/client-side-improvements-in-cassandra-2-0</a></p>
<p>1)使用PrepareStatement查询:  </p>
<blockquote>
<p>Prepared Statements are usually useful for queries that frequently executed in an application with different values<br>as they reduce the network traffic and the overall processing time on both clients and servers<br>by making it possible to send only the values along with the identifier of the Prepared Statement to the server.</p>
<p>If you are executing this same code each time you make a query, you are creating an extra roundtrip by calling ‘session.prepare’<br>each time to create your PreparedStatement. session.prepare sends a request to cassandra to prepare your statement.<br>You only need to do this once and you can reuse the PreparedStatement each time you make a query.</p>
</blockquote>
<p>2)分页查询, 设置FetchSize:<br>CassandraClient在init时设置了QueryOption的默认fetchSize为1000. 那么上面的PrepareStatement是否会继承这个属性?<br>PrepareStatement没有setFetchSize这个方法, 只有SimpleStatement才有setFetchSize.  </p>
<blockquote>
<p>注意查询原表数据时,不能使用select * from velocity order by partner_code asc,app_name asc,type asc,timestamp asc<br>Exception in thread “main” com.datastax.driver.core.exceptions.InvalidQueryException: ORDER BY is only supported when the partition key is restricted by an EQ or an IN.<br>order by的使用必须在指定了partition key才可以使用.  </p>
</blockquote>
<p>3)Spark-Cassandra-Connector<br>Spark和Cassandra都部署在一个节点时, 因为数据本地性, 处理速度最快. 如果节点是分开部署的, 则Spark执行的Task的Locality Level是Any,导致速度很慢.<br>由于不能动线上的Cassandra, 所以可以对Cassandra做快照, 并且把快照传输到Spark节点上, 在Spark的每台机器都安装Cassandra, 这样就做到了数据本地性.    </p>
<p>由于Spark-1.4.1使用Cassandra-2.1.5, 所以可以考虑在Spark直接部署Cassandra-2.1.5以上的版本. 线上的Cassandra版本是2.0.15.  </p>
<p>方案4: 使用其他数据源(比如ES)同步数据到三张表中. 如果上面的3)Spark方案可行的话, 就不需要读取ES了.  </p>
<h2 id="Spark方案迁移Velocity表">Spark方案迁移Velocity表</h2><h3 id="背景">背景</h3><p>1.Cassandra的Java Driver API读取原集群再写入到新集群的三张表, 速度不可忍受<br>2.从ES读取Activity数据,需要读取MySQL的规则配置, 转换成Velocity数据, 比较繁琐<br>3.采用Spark-Cassandra-Connector,但是线上Cassandra节点内存所剩不多, 不是走Local数据本地的计算, 速度也无法忍受  </p>
<p><img src="http://img.blog.csdn.net/20151027162604343" alt="spark-cass-local">  </p>
<p>不能把Spark安装到Cassandra上, 那为啥不可以把Cassandra安装到Spark上!!! 这样就解决了数据本地性的问题.    </p>
<h3 id="数据迁移">数据迁移</h3><table>
<thead>
<tr>
<th>Tips</th>
<th>Cluster</th>
<th>Keyspace</th>
<th>Tables</th>
</tr>
</thead>
<tbody>
<tr>
<td>原Cassandra集群</td>
<td>forseti_cluster</td>
<td>forseti</td>
<td>velocity</td>
</tr>
<tr>
<td>新Cassandra集群</td>
<td>forseti_cluster</td>
<td>forseti_velocity</td>
<td>velocity_app,velocity_partner,velocity_global</td>
</tr>
<tr>
<td>Spark和Cassandra集群</td>
<td>forseti_backup</td>
<td>forseti</td>
<td>velocity</td>
</tr>
</tbody>
</table>
<h3 id="准备工作">准备工作</h3><p>A.下线线上Cassandra集群的3-5个节点, 保守估计需要下线4个节点, 但是由于下线过程很慢, 可以下线2个节点, 并增加3台新的机器. (周五)<br>B.在Spark集群搭建Cassandra集群, 为了保证Spark计算的数据本地性. 但是先不启动 (周三)  </p>
<h3 id="问题">问题</h3><p><strong>1. 先上线Consumer双写, 还是先做快照?</strong><br>1) 先做快照, 做快照的时刻到Consumer上线会有一段时间差的,所以不建议! 而<strong>Consumer上线的前提是新集群有足够的机器</strong>.<br>2) Consumer先双写, 然后做快照. 这样快照时刻的数据会和Consumer写入的数据有重叠: snapshot只对原集群的velocity备份数据.    </p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">         &lt;-<span class="comment">----------------------------------------------|</span></span><br><span class="line"><span class="title">velocity</span> &lt;-<span class="comment">----------------------|-----------------------|</span></span><br><span class="line">                              consumer                snapshot</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为插入相同的记录, 在Cassandra中相当于更新, 不过由于Consumer使用的TTL和snapshot数据同步时计算的ttl可能有点差别, 会导致TTL被更新.<br>snapshot计算TTL的方式是:  90*86400 - (currentTime-timestamp)/1000<br>如果不重复插入, 可以在同步代码的时候, 将consumer和snapshot这段时间的数据不写入即可.  </p>
</blockquote>
<p><strong>2.数据同步使用Spark,会遇到任务失败等情况</strong><br>最好先用一个临时表测试, 没有问题了, 再插入到新集群中. 因为新集群Consumer数据已经写入, 不能truncate table!  </p>
<h3 id="操作步骤">操作步骤</h3><p>1.consumer代码双写上线.  (新机器到了之后,才可以上线,预计周五)<br>2.对线上Cassandra做snapshot快照, 通过scp传输到Spark和Cassandra集群, 然后启动Cassandra集群. (周末)<br>  将snapshot拷贝到cassandra配置的数据文件目录, 启动时会加载为velocity表.<br>3.在Spark集群上读取本集群的Cassandra的velocity表, 写入到forseti_velocity集群的三张表 (周末)<br>4.数据迁移完毕, API读取新集群, Consumer只写入新集群 (下周)</p>
<p><img src="http://img.blog.csdn.net/20151027165637255" alt="cass-data-migrate"></p>
<h2 id="实际迁移">实际迁移</h2><p>A.sstableloader在导入大批量数据时,内存要大,至少50G, 所以不能在线上集群直接sstableloader到备份集群,只能scp拷贝文件到备份集群.<br>B.spark的migration方法是读取备份集群的velocity,并写到当前备份集群. migration2方法可以指定写入的集群,未测试….<br>C.可以先写到备份集群,并仍然在备份集群使用sstableloader导入到线上集群(-d可以指定线上集群的节点, 备份集群是Spark集群,内存比较大).    </p>
<p>1.对线上Cassandra集群<code>forseti_cluster</code>的每个节点做快照, 硬链接,很快<br>2.scp拷贝快照到Spark+Cassandra备份集群<code>forseti_backup</code>, 一个节点300G,需要5个小时<br>3.sstableloader到forseti_backup, 副本数为1, 每个节点只需承担20G,需要2个小时<br>4.spark读取forseti_backup的velocity,写到forseti_backup的app,partner,global, 写一张表,预计3个小时<br>5.将三张表通过sstableloader到线上forseti_cluster集群  </p>
<h3 id="在Spark集群上批量安装Cassandra集群">在Spark集群上批量安装Cassandra集群</h3><p>1.Spark集群的节点列表, 需要找出内存较大,容量较大的几个节点作为<code>种子节点</code>,比如241,242.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.47</span><span class="number">.212</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.47</span><span class="number">.215</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>2.在202上循环ip_spark.txt的每个IP地址, 把<code>cassandra安装包</code>和<code>安装脚本</code>都分发到每个节点:    </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.15</span> qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.212</span>:~/ &amp;&amp;</span><br><span class="line">scp install_cassandra.sh qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.212</span>:~/</span><br></pre></td></tr></table></figure>
<p>3.在对应的节点上批量执行脚本  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo -<span class="keyword">u</span> admin kill -9 `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` &amp;&amp;</span><br><span class="line">sudo <span class="keyword">rm</span> -rf /usr/install/apache-cassandra-2.0.15 &amp;&amp; sudo <span class="keyword">rm</span> /usr/install/cassandra &amp;&amp; </span><br><span class="line">sudo <span class="keyword">sh</span> install_cassandra.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>后续可以考虑直接在202上执行远程节点的安装命令. 这样就不需要登陆到远程服务器安装了.  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment">#host=`ifconfig | grep "192.168.47" | awk '/inet addr/&#123;sub("addr:",""); print $2&#125;'`</span></span><br><span class="line">host=`hostname`</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/rpc_address: 192.168.47.202/rpc_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/listen_address: 192.168.47.202/listen_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/192.168.47.202/<span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra-env.sh</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/192.168.47.203,192.168.47.204,192.168.47.202/192.168.47.241,192.168.47.242/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/cluster_name: forseti_cluster/cluster_name: forseti_backup/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line"></span><br><span class="line">sudo mv ~/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install</span><br><span class="line">sudo chown admin:admin -R /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span></span><br><span class="line">sudo -u admin ln <span class="operator">-s</span> /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install/cassandra</span><br><span class="line">sudo mkdir /home/admin/cassandra</span><br><span class="line">sudo chown admin:admin -R /home/admin/cassandra</span><br><span class="line">sudo mkdir /var/<span class="built_in">log</span>/cassandra</span><br><span class="line">sudo chown admin:admin -R /var/<span class="built_in">log</span>/cassandra</span><br><span class="line"><span class="comment">#################################################</span></span><br></pre></td></tr></table></figure>
<p>4.建表并关闭Compaction:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cqlsh <span class="number">192.168</span><span class="number">.47</span><span class="number">.241</span> -f forseti_velocity.cql</span><br><span class="line">cqlsh <span class="number">192.168</span><span class="number">.47</span><span class="number">.241</span> -e <span class="string">"desc keyspaces;"</span></span><br><span class="line">nodetool -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.212</span> disableautocompaction -- forseti</span><br><span class="line">nodetool -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.215</span> disableautocompaction -- forseti</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="备份与导入">备份与导入</h3><p>1.做快照(做快照并不会增加硬盘大小, 因为Cassandra的快照使用硬链接): </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">snapshot</span> -cf velocity forseti</span><br><span class="line">Requested creating <span class="keyword">snapshot</span> <span class="keyword">for</span>: forseti <span class="keyword">and</span> <span class="keyword">table</span>: velocity</span><br><span class="line"><span class="keyword">Snapshot</span> <span class="keyword">directory</span>: <span class="number">1445938244634</span></span></span><br></pre></td></tr></table></figure>
<p>2.把snapshots整个文件夹拷贝到52(测试环境)上.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@mysql006070 snapshots]$ scp -r <span class="number">1445938244634</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:~/</span><br></pre></td></tr></table></figure>
<p>3.在52上将快照文件夹改成keyspace/table的形式, 并使用sstableloader导入  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ mkdir forseti &amp;&amp; mv <span class="number">1445938244634</span> velocity &amp;&amp; mv velocity forseti/</span><br><span class="line">[qihuang.zheng@dp0652 ~]$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> forseti/velocity</span><br><span class="line">Established connection to initial hosts</span><br><span class="line">Opening sstables and calculating sections to stream</span><br><span class="line">Streaming relevant part of forseti/velocity/forseti-velocity-jb-<span class="number">308</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">412</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">136</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">413</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">411</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">409</span>-Data.db forseti/velocity/forseti-velocity-jb-<span class="number">410</span>-Data.db to [/<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>, /<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>]</span><br><span class="line">Streaming session ID: <span class="number">424</span>a20b0-<span class="number">7</span>c8f-<span class="number">11e5</span>-b82a-f9a3de842dc7</span><br><span class="line">progress: [/<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span> <span class="number">7</span>/<span class="number">7</span> (<span class="number">100</span>%)] [/<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span> <span class="number">7</span>/<span class="number">7</span> (<span class="number">100</span>%)] [total: <span class="number">100</span>% - <span class="number">4</span>MB/s (avg: <span class="number">8</span>MB/s)]</span><br></pre></td></tr></table></figure>
<p>如果出现OOM, 则增大sstableloader脚本的内存到50G:  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin sed -i -e <span class="string">'s/-Xmx256M/-Xmx50G/g'</span> <span class="regexp">/usr/i</span>nstall<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader</span></span><br></pre></td></tr></table></figure>
<p>4.导入时间预估. 线上一个节点300多G, 每秒16M, 需要300<em>1024/(15</em>3600)=6个小时.<br>10个节点60小时=2天半. 不过可以开多个sstableloader进程并行导入.   </p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">[total: <span class="number">2</span>% - <span class="number">24</span>MB/s <span class="list">(<span class="keyword">avg:</span> <span class="number">16</span>MB/s)</span>]</span></span><br></pre></td></tr></table></figure>
<p>5.备份数为3, 线上一个节点315G的数据, 导入到13个节点后. 每个节点平均存储315*3/13=72G.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047208 velocity]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.223</span>  <span class="number">115.02</span> GB  <span class="number">256</span>     <span class="number">7.6</span>%   <span class="number">1</span>b8952a2-<span class="number">257</span>a-<span class="number">4f</span>c4-<span class="number">9630</span>-<span class="number">6f</span>f302dba012  RAC1</span><br><span class="line">...</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.241</span>  <span class="number">112.59</span> GB  <span class="number">256</span>     <span class="number">7.4</span>%   dbf1ba40-<span class="number">3470</span>-<span class="number">4</span>b2e-<span class="number">8</span>bc1-df4e7684ac51  RAC1</span><br><span class="line">...</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.208</span>  <span class="number">118.9</span> GB   <span class="number">256</span>     <span class="number">7.6</span>%   <span class="number">75</span>d14a2b-<span class="number">8652</span>-<span class="number">4</span>c99-a235-c9ef9c96f44d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@spark047241 forseti]$ sudo du /home/admin/cassandra/data/forseti<span class="comment">/* -sh *</span><br><span class="line">69G velocity</span><br><span class="line">50G velocity_app</span></span><br></pre></td></tr></table></figure>
<p>6.由于只分析一次,所以可以设置副本数=1, 这样每个节点只需要存储315/13=24G! 数据量大大减少!<br>线上10个节点,每个节点平均350G, 总数据量=3500G, 除以副本数据3后, 再除以13台=3500/3/13=89G.    </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CREATE KEYSPACE forseti WITH replication = &#123;</span><br><span class="line">  'class': 'NetworkTopologyStrategy',</span><br><span class="line">  'DC1': '1'</span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line">CREATE KEYSPACE forseti_velocity WITH replication = &#123;</span><br><span class="line">  'class': 'NetworkTopologyStrategy',</span><br><span class="line">  'DC1': '1'</span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@spark047219 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.223</span>  18.38 GB   256     7.5%   a4b91faf-3e1f-46df-a1cc-39bb267bc683  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.219</span>  31.33 GB   256     7.2%   953dda8c-<span class="number">3908-401</span>f-9adb-aa59c4cb92d1  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.218</span>  21.84 GB   256     7.7%   42b8bfae-a6ee-439b-b<span class="number">101-4a0963</span>c9aaa0  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.217</span>  20.57 GB   256     7.3%   b6ca1df0-eb0f-4d82-a57a-<span class="number">9290d635</span>add2  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.216</span>  26.85 GB   256     8.4%   5cf89951-a48e-<span class="number">4c86-9156</span>-d<span class="number">5656003b7</span>c9  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.245</span>  18.68 GB   256     7.1%   73b63cfb-915a-4bf7-8c1b-591ddddbf4ae  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.215</span>  20.82 GB   256     7.5%   b9767b6c-dbc9-4ed5-b72c-7218ebda63f1  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.244</span>  24 GB      256     8.2%   f3df981a-1d8c-4bb3-b317-f1cfb67af549  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.212</span>  30.54 GB   256     8.2%   <span class="number">9a76336</span>f-add3-4349-bab<span class="number">9-0e946</span>d739cb1  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.241</span>  26.86 GB   256     7.7%   cf<span class="number">509762-87</span>47-41c9-a7c3-be4009ce9f6d  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.243</span>  22.27 GB   256     7.2%   <span class="number">49b01677-84</span>a2-4ede-97d0-e<span class="number">6b9f7151</span>ed2  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.242</span>  26.64 GB   256     7.9%   2bdcbef1-c<span class="number">562-412</span>c-b<span class="number">946-2a01</span>2060e52a  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.208</span>  22.74 GB   256     8.0%   <span class="number">7354d0a1</span>-<span class="number">7c05-428</span>e-b9df-c92c6f3ba65c  RAC1</span><br></pre></td></tr></table></figure>
<p>更进一步减少数据的方式是: 因为副本数为3, 允许当掉2个节点. 所有获取全集数据的节点只需要: ClusterSize-(Replicator-1).<br>假设集群大小=9, 则只需要9-(3-1)=7个节点的数据就可以表示全集数据. 但是计算方式不能再除以3了,因为现在不是全部副本了.   </p>
<h3 id="采用Spark同步数据">采用Spark同步数据</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nohup /usr/install/spark-<span class="number">1.4</span>.<span class="number">1</span>-bin-hadoop2.<span class="number">4</span>/bin/spark-submit \</span><br><span class="line">  --master spark:<span class="comment">//192.168.47.209:7077 \</span></span><br><span class="line">  --executor-memory <span class="number">8</span>g --total-executor-cores <span class="number">40</span> --driver-memory <span class="number">8</span>g \</span><br><span class="line">  --jars spark-cassandra-connector-assembly-<span class="number">1.4</span>.<span class="number">0</span>-SNAPSHOT<span class="class">.jar</span> \</span><br><span class="line">  --conf spark<span class="class">.cassandra</span><span class="class">.connection</span><span class="class">.host</span>=<span class="number">192.168</span>.<span class="number">47.241</span> \</span><br><span class="line">  --conf spark<span class="class">.cass</span><span class="class">.connect</span><span class="class">.dest</span>=<span class="number">192.168</span>.<span class="number">47.241</span> \</span><br><span class="line">  --conf spark<span class="class">.cassandra</span><span class="class">.input</span><span class="class">.fetch</span><span class="class">.size_in_rows</span>=<span class="number">1500</span> \</span><br><span class="line">  --class cn<span class="class">.fraudmetrix</span><span class="class">.cassandra</span><span class="class">.VelocityMigration</span> \</span><br><span class="line">  --properties-file spark-defaults_backup<span class="class">.conf</span> \</span><br><span class="line">  spark-app-<span class="number">1.0</span>-SNAPSHOT<span class="class">.jar</span> test <span class="number">0</span> &amp;</span><br></pre></td></tr></table></figure>
<p>配置文件spark-defaults_backup.conf:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spark<span class="class">.serializer</span>              org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.serializer</span><span class="class">.KryoSerializer</span></span><br><span class="line">spark<span class="class">.shuffle</span><span class="class">.manager</span>         SORT</span><br><span class="line">spark<span class="class">.storage</span><span class="class">.memoryFraction</span>  <span class="number">0.1</span></span><br><span class="line">spark<span class="class">.akka</span><span class="class">.frameSize</span>          <span class="number">64</span></span><br><span class="line">spark<span class="class">.sql</span><span class="class">.shuffle</span><span class="class">.partitions</span>  <span class="number">100</span></span><br><span class="line">spark<span class="class">.cleaner</span><span class="class">.ttl</span>             <span class="number">86400</span></span><br><span class="line"><span class="id">#spark</span><span class="class">.executor</span><span class="class">.memory</span>        <span class="number">6</span>g</span><br><span class="line"><span class="id">#spark</span><span class="class">.driver</span><span class="class">.memory</span>          <span class="number">4</span>g</span><br><span class="line"><span class="id">#spark</span><span class="class">.scheduler</span><span class="class">.mode</span>         FAIR</span><br><span class="line"><span class="id">#spark</span><span class="class">.cores</span><span class="class">.max</span>              <span class="number">40</span></span><br><span class="line"><span class="id">#spark</span><span class="class">.locality</span><span class="class">.wait</span>          <span class="number">500</span></span><br><span class="line"></span><br><span class="line">spark<span class="class">.cassandra</span><span class="class">.connection</span><span class="class">.host</span>         <span class="number">192.168</span>.<span class="number">47.241</span>,<span class="number">192.168</span>.<span class="number">47.242</span></span><br><span class="line">spark<span class="class">.cassandra</span><span class="class">.query</span><span class="class">.retry</span><span class="class">.count</span>       <span class="number">30</span></span><br><span class="line">spark<span class="class">.cassandra</span><span class="class">.read</span><span class="class">.timeout_ms</span>         <span class="number">60000000</span></span><br><span class="line"><span class="id">#spark</span><span class="class">.cassandra</span><span class="class">.connection</span><span class="class">.local_dc</span>    DC2</span><br><span class="line"><span class="id">#spark</span><span class="class">.cassandra</span><span class="class">.input</span><span class="class">.split</span><span class="class">.size</span>       <span class="number">10000</span></span><br><span class="line"><span class="id">#spark</span><span class="class">.cassandra</span><span class="class">.page</span><span class="class">.row</span><span class="class">.size</span>          <span class="number">1500</span></span><br><span class="line"><span class="id">#spark</span><span class="class">.cassandra</span><span class="class">.output</span><span class="class">.batch</span><span class="class">.size</span><span class="class">.rows</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>300G原始数据, 使用migration方法迁移数据, 没有分区和使用40个分区的执行时间对比:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Total Time Across All Tasks: <span class="number">30.1</span> h</span><br><span class="line">Input Size / Records: <span class="number">559.6</span> GB / <span class="number">1389486774</span></span><br><span class="line">Output: <span class="number">558.4</span> GB / <span class="number">1386555184</span></span><br><span class="line"></span><br><span class="line">Total Time Across All Tasks: <span class="number">19.1</span> h</span><br><span class="line">Input Size / Records: <span class="number">467.8</span> GB / <span class="number">1167707565</span></span><br><span class="line">Output: <span class="number">464.3</span> GB / <span class="number">1165332003</span>   只完成了三个任务, 后面的任务的output都好久没有变化</span><br><span class="line"></span><br><span class="line">repartition会进行shuffle:  </span><br><span class="line">Total Time Across All Tasks: <span class="number">26.8</span> h</span><br><span class="line">Input Size / Records: <span class="number">637.7</span> GB / <span class="number">1577680969</span></span><br><span class="line">Shuffle Write: <span class="number">165.8</span> GB / <span class="number">1045715712</span></span><br></pre></td></tr></table></figure>
<p>将原始数据分组处理, 每个文件夹1G, 则负担到13个节点, 每个节点大概100M. velocity_app任务还在跑, 容量会增加,<br>但是奇怪的是比velocity还要多, 过了会儿, 缺少了. 这是因为后台在发生Compaction操作.   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@spark047219 forseti]$ sudo du -sh *</span><br><span class="line"><span class="number">46</span>M velocity</span><br><span class="line"><span class="number">105</span>M  velocity_app</span><br><span class="line"><span class="number">84</span>K velocity_app2</span><br><span class="line"><span class="number">72</span>K velocity_app3</span><br><span class="line"><span class="number">56</span>K velocity_global</span><br><span class="line"><span class="number">20</span>K velocity_partner</span><br><span class="line">[qihuang.zheng@spark047219 forseti]$ sudo du -sh *</span><br><span class="line"><span class="number">46</span>M velocity</span><br><span class="line"><span class="number">55</span>M velocity_app</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<blockquote>
<p>但是实际上用Spark直接读取Cassandra, 会有很多问题的. 见Migration6_VelocitySpark.md </p>
</blockquote>
</blockquote>
</blockquote>
<h3 id="Token">Token</h3><p>既然sstableloader搞起来这么费劲, 何不换种思路, 用token range, 还可以并行执行的.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select distinct attribute from velocity where token(attribute) &gt; token() limit 100</span><br><span class="line">account_login<span class="number">2e53421411</span> <span class="number">91175318 170</span>.<span class="number">195.207.6 5</span>.<span class="number">67.132 138.129</span>.<span class="number">7 123.170.142</span> <span class="number">139.226.231.157</span> <span class="number">47.210.229.230</span> <span class="number">14.155.155 201</span><span class="number">5-08-18 16</span>:<span class="number">24:01 88.51</span>.<span class="number">57.18 139.150</span>.<span class="number">253 57.189.116</span>.<span class="number">89 2015-09</span>-<span class="number">09 15:05:51</span> z<span class="number">607@163</span>.com <span class="number">18560680785</span> ZaiShi<span class="number">329 216.61</span>.<span class="number">177 19.229.62</span>.200 device_id<span class="number">5074 83.143</span>.<span class="number">142.232 61.216</span>.<span class="number">236 109.226.113</span>.<span class="number">46 48073136</span> <span class="number">2015-09-29</span> <span class="number">14:25:18 112</span>.<span class="number">197.62 158.61</span>.78 z<span class="number">2707@163</span>.com <span class="number">243.175.80.6</span> <span class="number">233.167.195.41</span> <span class="number">14.46.157 210</span><span class="number">1811985102863</span><span class="number">07 249.93.11</span>.<span class="number">222 91.38.31</span>.91 z<span class="number">4277@163</span>.com <span class="number">83.198.126.79</span> <span class="number">2015-08-25</span> <span class="number">15:54:39 26</span>.<span class="number">133.115.1</span> rjEfvIJnCu <span class="number">255.201.104</span> device_id<span class="number">7332 139.248</span>.<span class="number">66 1833089204</span>3 zhangsaner<span class="number">0 57.88.60</span>.<span class="number">106 143.205.32</span> <span class="number">148.216.44 246</span>.<span class="number">155.162.83 161</span><span class="number">15351091 146</span><span class="number">39588836 100</span>.<span class="number">163.150 143733</span><span class="number">30236 1212148</span><span class="number">9292 3.61</span>.<span class="number">128.99 79.210</span>.<span class="number">184.27 108.89</span>.<span class="number">144 12.115.188</span>.<span class="number">70 174385476</span><span class="number">46 12812120180</span> <span class="number">17889867223</span> <span class="number">12794833053</span> <span class="number">2015-09-06</span> <span class="number">10:54:38 169</span>.<span class="number">133.243 2015</span>-<span class="number">09-06 10:55</span>:<span class="number">50 228.216.164</span>.<span class="number">163 235.80.100</span>.137 account_login<span class="number">253253 204.155</span>.<span class="number">11.158 251.176</span>.<span class="number">162 2015-08</span>-<span class="number">18 17:36:38</span> <span class="number">2015-10-22</span> <span class="number">17:59:14 54</span>.<span class="number">222.15 45.148</span>.<span class="number">225.134 11.91</span>.<span class="number">37 39.186.100</span>.<span class="number">201 52.168.164</span> <span class="number">19.247.19.178</span> <span class="number">93.197.201 42</span>.<span class="number">245.115.138 13</span>.<span class="number">217.137.48 39</span>.<span class="number">74.2.197 201</span>.<span class="number">67.0.154 118</span><span class="number">72478274 199</span><span class="number">97837445 219</span>.<span class="number">43.195 148866</span>51443 device_id<span class="number">8094 144.114</span>.<span class="number">160.164 80.223</span>.<span class="number">238.218 196293</span><span class="number">65 139.212.6</span> <span class="number">218.81.205 113</span>.<span class="number">142.90.148 60</span>.<span class="number">226.96 130.124</span>.<span class="number">20 29.116.70</span>.238 z<span class="number">2230@163</span>.com <span class="number">240.107.171.191</span> 77.53.46 qpQY8vvHEg </span><br><span class="line"></span><br><span class="line">---------------qpQY8vvHEg</span><br><span class="line">select distinct attribute from velocity where token(attribute) &gt; token('qpQY8vvHEg') limit 100</span><br><span class="line"><span class="number">95659798 60</span>.<span class="number">179.22.160</span> z<span class="number">9623@163</span>.com <span class="number">16820132688</span> <span class="number">74.56.66 27</span>.<span class="number">108.167.229 239</span>.<span class="number">207.25 1.88</span>.<span class="number">201.233</span> ZaiShi<span class="number">376 156065</span><span class="number">32389 71628</span><span class="number">174 159.202.92</span> <span class="number">202.142.55 141</span><span class="number">05115 224.40</span>.<span class="number">205 148884549</span><span class="number">80 25.65.116</span> <span class="number">13113273275</span> <span class="number">14.67.42.52</span> <span class="number">251.28.210 5</span>.<span class="number">207.114 33.217</span>.<span class="number">186 187.59.92</span>.12 mGwVAAY6Ip <span class="number">145.143.125</span> account_login<span class="number">2e5342f39</span><span class="number">07 1240197978</span><span class="number">8 56.67.238</span> <span class="number">140.119.108 199</span>.<span class="number">77.185 219.150</span>.<span class="number">153.223 218.180</span>.<span class="number">68.11 178.126</span>.<span class="number">201.8 70.143</span>.<span class="number">157.48 88.153</span>.<span class="number">226 230.128.230</span>.<span class="number">211 200.87.223</span>.<span class="number">76 183163135</span><span class="number">96 2015-10</span>-<span class="number">15 19:21:18</span> <span class="number">169.86.189.113</span> z<span class="number">6817@163</span>.com <span class="number">170.231.186 63</span><span class="number">569083 239</span>.<span class="number">30.27.71 147</span><span class="number">09666666 62</span>.<span class="number">192.93 158.222</span>.<span class="number">193 167535287</span><span class="number">47 109.167.108</span> <span class="number">17078365147</span> <span class="number">112.9.154.85</span> <span class="number">5.103.202.1</span> <span class="number">44.17.22.104</span> <span class="number">2015-08-25</span> <span class="number">16:06:03 185</span>.<span class="number">198.206 148.8</span>.<span class="number">194 27.144.66</span> <span class="number">246.91.208.62</span> <span class="number">59.128.88.155</span> <span class="number">177.107.252 151</span>.<span class="number">12.247.86 254</span>.<span class="number">220.87.220 230</span>.<span class="number">29.30.185 06</span><span class="number">059385 179</span>.<span class="number">19.249.61 136</span>.<span class="number">175.202 200.36</span>.<span class="number">19 110.252.185</span> <span class="number">250.77.27 27</span>.<span class="number">132.33 119.39</span>.<span class="number">162.189 130.139</span>.<span class="number">166 240.233.178</span>.<span class="number">60 69.36.252</span> <span class="number">2015-08-25</span> <span class="number">17:27:29 201</span><span class="number">5-09-29 15</span>:<span class="number">01:43 230.208</span>.<span class="number">62 141.37.232</span> <span class="number">13388613043</span> <span class="number">2015-09-17</span> <span class="number">16:26:52 179</span>.<span class="number">218.5.140 71</span>.<span class="number">96.162 60.199</span>.<span class="number">155 0.124.66</span>.<span class="number">204 216.128.251</span>.<span class="number">2 40.62.153</span>.<span class="number">114 75.23.121</span> <span class="number">145.142.41.180</span> <span class="number">18596036379</span> <span class="number">195.52.94</span> device_id<span class="number">6453 2.80</span>.<span class="number">200.247 117.124</span>.<span class="number">160.147 108680</span><span class="number">20866 102632</span><span class="number">97967 210181</span><span class="number">198510287085</span> <span class="number">138.27.254</span> z<span class="number">6623@163</span>.com <span class="number">24.214.24 212</span>.<span class="number">45.235.46</span> </span><br><span class="line"></span><br><span class="line">---------------<span class="number">212.45.235.46</span></span><br><span class="line">select distinct attribute from velocity where token(attribute) &gt; token('<span class="number">212.45.235.46</span>') limit 100</span><br><span class="line"><span class="number">6696.0 210</span>.<span class="number">37.9.226 173</span><span class="number">63901756 43</span>.<span class="number">251.66.38 140</span>.<span class="number">151.170.220 251</span>.<span class="number">3.185.44 171</span>.<span class="number">106.109 1316153</span><span class="number">8477 173887</span><span class="number">84662 186.176</span>.<span class="number">110 2015-09</span>-<span class="number">15 15:57:34</span> <span class="number">225.95.155.41</span> account_login<span class="number">2e5342f83</span> <span class="number">84.253.169.201</span> <span class="number">112.165.74.136</span> <span class="number">2015-08-19</span> <span class="number">15:30:46 2</span>.174.89 account_login<span class="number">2e5342f77</span><span class="number">02 93.71.108</span>.<span class="number">169 41.148.251</span> <span class="number">224.14.123 164</span>.<span class="number">108.31.31 79</span><span class="number">096632 10</span>.<span class="number">22.244 208.18</span>.<span class="number">92.62 128.180</span>.<span class="number">24 2015-08</span>-<span class="number">18 10:46:04</span> <span class="number">250.11.241 184</span><span class="number">53987637 252</span>.<span class="number">224.160 95.119</span>.<span class="number">210.88 243.189</span>.<span class="number">95.182 1432218</span><span class="number">2971 1054174</span><span class="number">7840 251.198</span>.<span class="number">71.121 225.138</span>.<span class="number">147 232.25.123</span> device_id<span class="number">9832 125.136</span>.<span class="number">52 151.131.161</span> y17SRfTsFj <span class="number">2015-09-30</span> <span class="number">10:03:48 110</span><span class="number">73144269 207</span>.<span class="number">145.227 48.114</span>.<span class="number">197 40.128.175</span> <span class="number">14251759622</span> <span class="number">14.39.3 51</span>.<span class="number">15.89.149 31</span>.<span class="number">125.182.209 125</span>.<span class="number">64.52 158506</span><span class="number">97469 210181</span><span class="number">198510286154</span> device_id<span class="number">7491 180.16</span>.<span class="number">187.132 210181</span><span class="number">198510286810</span> z<span class="number">5949@163</span>.com <span class="number">2015-08-24</span> <span class="number">14:31:46 156</span>.<span class="number">214.4.252 241</span>.<span class="number">215.175 59.148</span>.<span class="number">52.30 2015</span>-<span class="number">08-17 22:41</span>:<span class="number">46 5.195.26</span>.<span class="number">12 1344844104</span><span class="number">0 159.28.13</span> <span class="number">20.152.148 38</span>.<span class="number">171.173 2015</span>-<span class="number">08-17 23:43</span>:<span class="number">20 95.176.159</span>.219 account_login<span class="number">2e53422867</span> <span class="number">207.213.72 219</span>.<span class="number">201.45.231 155</span>.<span class="number">200.159.127 45</span><span class="number">339730 201</span><span class="number">5-09-22 18</span>:<span class="number">01:22 119783</span><span class="number">78291 206.115</span>.<span class="number">201.230</span> device_id<span class="number">5628 8.255</span>.<span class="number">201 254.249.32</span>.<span class="number">76 210181198</span><span class="number">510282281</span> <span class="number">244.169.179 130</span>.<span class="number">176.254.54 86</span>.<span class="number">62.142 245.100</span>.<span class="number">242.220 26.149</span>.<span class="number">133 2015-10</span>-<span class="number">15 18:35:54</span> <span class="number">28.80.106 189</span><span class="number">33495104 32</span>.<span class="number">136.126.244 35</span>.<span class="number">19.217.49 110</span><span class="number">11238836 165</span><span class="number">48254671 56</span>.<span class="number">57.210.138 44</span>.<span class="number">160.1 141.178</span>.<span class="number">114 247.23.49</span> <span class="number">103.232.178.241</span> <span class="number">66953473 147</span><span class="number">09605511</span> </span><br><span class="line"></span><br><span class="line">---------------<span class="number">14709605511</span></span><br><span class="line">select distinct attribute from velocity where token(attribute) &gt; token('<span class="number">14709605511</span>') limit 100</span><br><span class="line"><span class="number">190.162.80.4</span> <span class="number">2015-10-09</span> <span class="number">14:24:23 182</span>.<span class="number">169.238.145 255</span>.<span class="number">165.106.58 201</span><span class="number">5-08-22 14</span>:<span class="number">25:55 22.90</span>.<span class="number">189.233 2015</span>-<span class="number">08-25 15:59</span>:<span class="number">27 227.31.218</span>.<span class="number">142 1641355136</span><span class="number">5 2015-10</span>-<span class="number">10 15:20:43</span> <span class="number">2015-08-17</span> <span class="number">22:38:54 14</span>.<span class="number">138.158.234 62</span>.<span class="number">170.157.239 175</span><span class="number">80709466 201</span><span class="number">5-10-10 16</span>:<span class="number">16:22 145.189</span>.<span class="number">215.62 105.21</span>.<span class="number">247.59 92.67</span>.<span class="number">57.40 169.212</span>.<span class="number">49 125.108.255</span> <span class="number">226.53.82.29</span> <span class="number">152.140.212 83</span>.<span class="number">103.17 90.55</span>.<span class="number">52 169455272</span><span class="number">26 245.173.198</span> <span class="number">88.186.233 165</span>.<span class="number">135.158 1710170</span><span class="number">0038 103.228</span>.<span class="number">249.247 210181</span><span class="number">198510288714</span> <span class="number">245.80.122 162</span>.<span class="number">33.78.41 3</span>.<span class="number">129.65 187943</span><span class="number">55106 41.40</span>.<span class="number">25 1501156289</span><span class="number">8 141.198.195</span> <span class="number">41.97.13.163</span> <span class="number">48.219.175.86</span> <span class="number">37.229.239 52</span>.<span class="number">239.182 171.215</span>.<span class="number">73 192353378</span><span class="number">71 92.19.160</span>.<span class="number">152 91.128.158</span> <span class="number">255.74.112.177</span> <span class="number">49.144.78 82</span>.<span class="number">60.164.29 84</span><span class="number">930521 182</span><span class="number">33032733 237</span>.<span class="number">104.45 68.68</span>.<span class="number">144 13.142.162</span> <span class="number">13198850408</span> <span class="number">2015-10-12</span> <span class="number">10:02:25 135</span>.<span class="number">108.79.188 108</span>.<span class="number">10.144 148.8</span>.<span class="number">20 127.199.231</span>.<span class="number">31 2015-08</span>-<span class="number">18 16:14:19</span> <span class="number">130.192.52 201</span><span class="number">5-09-29 14</span>:<span class="number">23:47 251.197</span>.<span class="number">8.151 2015</span>-<span class="number">10-06 00:00</span>:<span class="number">00 165.182.169</span>.<span class="number">112 196.204.132</span>.<span class="number">21 110.241.205</span> <span class="number">08098564 59</span>.<span class="number">79.64.176</span> z<span class="number">882@163</span>.com <span class="number">220.8.9.101</span> account_login<span class="number">253422197 182</span>.42.244 account_login<span class="number">2e53425305</span> <span class="number">73837071 2</span>.<span class="number">60.122 08853</span><span class="number">454 71.77</span>.<span class="number">99.195 1115143</span>4896 account_login<span class="number">2e53428639</span> <span class="number">102.204.23 31</span><span class="number">654758 77</span>.<span class="number">182.197.5 77</span>.<span class="number">17.207.42 202</span>.<span class="number">32.17.181 220</span>.<span class="number">60.198 35.209</span>.<span class="number">233.135 92.36</span>.<span class="number">156.98 72.54</span>.<span class="number">68 67.181.68</span>.<span class="number">181 224.232.193</span> <span class="number">118.110.69.45</span> device_id<span class="number">2541 2015</span>-<span class="number">08-18 16:15</span>:<span class="number">33 132131705</span><span class="number">33 175.243.0</span> <span class="number">15.245.139.136</span> <span class="number">61.71.248.44</span> <span class="number">175.81.226.31</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/">Cassandra数据迁移 分离表</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年11月15日 - 00时00分</p>
  <p><span>最后更新:</span>2015年12月19日 - 21时14分</p>
  <p>
    <span>原始链接:</span><a href="/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/" title="Cassandra数据迁移 分离表">http://github.com/zqhxuyuan/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/11/15/2015-11-15-Cassandra-Migration5_SplitTable/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/11/16/2015-11-16-Cassandra-Migration6_VelocitySpark/">
        Cassandra数据迁移 分离表
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/11/11/2015-11-11-Cassandra-Stream/">
        Cassandra源码分析之Stream
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要分离velocity表和指标表?"><span class="toc-number">1.</span> <span class="toc-text">为什么要分离velocity表和指标表?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拆分velocity表"><span class="toc-number">2.</span> <span class="toc-text">拆分velocity表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景:_原有表结构"><span class="toc-number">2.1.</span> <span class="toc-text">背景: 原有表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将velocity按照scope拆分成三张表"><span class="toc-number">2.2.</span> <span class="toc-text">将velocity按照scope拆分成三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拆分的初步方案"><span class="toc-number">2.3.</span> <span class="toc-text">拆分的初步方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据迁移方案"><span class="toc-number">3.</span> <span class="toc-text">数据迁移方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spark方案迁移Velocity表"><span class="toc-number">4.</span> <span class="toc-text">Spark方案迁移Velocity表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-number">4.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据迁移"><span class="toc-number">4.2.</span> <span class="toc-text">数据迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">4.3.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题"><span class="toc-number">4.4.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作步骤"><span class="toc-number">4.5.</span> <span class="toc-text">操作步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实际迁移"><span class="toc-number">5.</span> <span class="toc-text">实际迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在Spark集群上批量安装Cassandra集群"><span class="toc-number">5.1.</span> <span class="toc-text">在Spark集群上批量安装Cassandra集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#备份与导入"><span class="toc-number">5.2.</span> <span class="toc-text">备份与导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#采用Spark同步数据"><span class="toc-number">5.3.</span> <span class="toc-text">采用Spark同步数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Token"><span class="toc-number">5.4.</span> <span class="toc-text">Token</span></a></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
</script>


<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/11/16/2015-11-16-Cassandra-Migration6_VelocitySpark/" title="上一篇: Cassandra数据迁移 分离表">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/11/11/2015-11-11-Cassandra-Stream/" title="下一篇: Cassandra源码分析之Stream">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2016 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>