<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Druid入门 | 任何忧伤,都抵不过世界的美丽</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="http://druid.io/docs/latest/tutorials/tutorial-a-first-look-at-druid.html  
数据源是Wikipedia的编辑日志. 当这种事件发生时,会push到IRC通道. 我们的示例会实时读取IRC通道的数据写入到Druid的实时节点中.  

Each event has a timestamp indicating the tim">
<meta property="og:type" content="article">
<meta property="og:title" content="Druid入门">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/12/02/2015-12-02-Hello-Druid/index.html">
<meta property="og:site_name" content="任何忧伤,都抵不过世界的美丽">
<meta property="og:description" content="http://druid.io/docs/latest/tutorials/tutorial-a-first-look-at-druid.html  
数据源是Wikipedia的编辑日志. 当这种事件发生时,会push到IRC通道. 我们的示例会实时读取IRC通道的数据写入到Druid的实时节点中.  

Each event has a timestamp indicating the tim">
<meta property="og:updated_time" content="2015-12-02T11:37:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Druid入门">
<meta name="twitter:description" content="http://druid.io/docs/latest/tutorials/tutorial-a-first-look-at-druid.html  
数据源是Wikipedia的编辑日志. 当这种事件发生时,会push到IRC通道. 我们的示例会实时读取IRC通道的数据写入到Druid的实时节点中.  

Each event has a timestamp indicating the tim">
  
    <link rel="alternative" href="/atom.xml" title="任何忧伤,都抵不过世界的美丽" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/avatar.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">zqhxuyuan</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/cassandra/" style="font-size: 13.33px;">cassandra</a> <a href="/tags/drill/" style="font-size: 20px;">drill</a> <a href="/tags/druid/" style="font-size: 10px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 13.33px;">elasticsearch</a> <a href="/tags/spark/" style="font-size: 16.67px;">spark</a> <a href="/tags/storm/" style="font-size: 16.67px;">storm</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">BIG</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">zqhxuyuan</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="/img/avatar.png" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">zqhxuyuan</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-12-02-Hello-Druid" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/02/2015-12-02-Hello-Druid/" class="article-date">
  	<time datetime="2015-12-01T16:00:00.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Druid入门
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/druid/">druid</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><a href="http://druid.io/docs/latest/tutorials/tutorial-a-first-look-at-druid.html" target="_blank" rel="external">http://druid.io/docs/latest/tutorials/tutorial-a-first-look-at-druid.html</a>  </p>
<p>数据源是Wikipedia的编辑日志. 当这种事件发生时,会push到IRC通道. 我们的示例会实时读取IRC通道的数据写入到Druid的实时节点中.  </p>
<blockquote>
<p>Each event has a timestamp indicating the time of the edit (in UTC time),<br>a list of dimensions indicating various metadata about the event (such as information about the user editing the page and where the user is a bot),<br>and a list of metrics associated with the event (such as the number of characters added and deleted).</p>
</blockquote>
<p>事件的定义: 时间戳, 事件的元数据:<code>维度</code>, 事件关联的<code>指标</code>.<br>Dimensions (things to filter on)    参与事件过滤<br>Metrics (things to aggregate over)  要聚合的字段  </p>
<h2 id="Hello_Druid">Hello Druid</h2><p>1.启动ZooKeeper:  <code>zkServer.sh start</code>  </p>
<p>2.启动示例服务器: </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  druid-<span class="number">0.8</span>.<span class="number">2</span>  ./run_example_server<span class="class">.sh</span></span><br><span class="line">This will run <span class="tag">a</span> stand-alone version of Druid</span><br><span class="line">+ java -Xmx512m -Duser.timezone=UTC -Dfile.encoding=UTF-<span class="number">8</span> -Ddruid<span class="class">.realtime</span><span class="class">.specFile</span>=/Users/zhengqh/Soft/druid-<span class="number">0.8</span>.<span class="number">2</span>/examples/wikipedia/wikipedia_realtime<span class="class">.spec</span> </span><br><span class="line">-Ddruid<span class="class">.extensions</span><span class="class">.localRepository</span>=./extensions-repo <span class="string">'-Ddruid.extensions.remoteRepositories=[]'</span> -Ddruid<span class="class">.publish</span><span class="class">.type</span>=noop </span><br><span class="line">-classpath <span class="string">'/Users/zhengqh/Soft/druid-0.8.2/../config/realtime:/Users/zhengqh/Soft/druid-0.8.2/examples/wikipedia:/Users/zhengqh/Soft/druid-0.8.2/config/_common:/Users/zhengqh/Soft/druid-0.8.2/config/realtime:/Users/zhengqh/Soft/druid-0.8.2/lib/*'</span> </span><br><span class="line">io<span class="class">.druid</span><span class="class">.cli</span><span class="class">.Main</span> example realtime      ⬅️ 启动一个实时节点</span><br></pre></td></tr></table></figure>
<p>3.启动示例客户端:  </p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  druid-<span class="number">0.8</span><span class="number">.2</span>  ./run_example_client.sh</span><br><span class="line">This will <span class="command">run</span> a query <span class="keyword">against</span> a stand-alone <span class="property">version</span> <span class="keyword">of</span> Druid.</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"queryType"</span>:<span class="string">"timeBoundary"</span>,</span><br><span class="line">   <span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span></span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>
<p>timeBoundary表示所有事件的时间边界, 下面是两次查询的结果:  </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ &#123;</span><br><span class="line">  "<span class="attribute">timestamp</span>" : <span class="value"><span class="string">"2015-12-02T01:40:47.555Z"</span></span>,</span><br><span class="line">  "<span class="attribute">result</span>" : <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">minTime</span>" : <span class="value"><span class="string">"2015-12-02T01:40:47.555Z"</span></span>,</span><br><span class="line">    "<span class="attribute">maxTime</span>" : <span class="value"><span class="string">"2015-12-02T01:42:21.869Z"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125; ]</span><br><span class="line"></span><br><span class="line">[ &#123;</span><br><span class="line">  "<span class="attribute">timestamp</span>" : <span class="value"><span class="string">"2015-12-02T01:40:47.555Z"</span></span>,</span><br><span class="line">  "<span class="attribute">result</span>" : <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">minTime</span>" : <span class="value"><span class="string">"2015-12-02T01:40:47.555Z"</span></span>,</span><br><span class="line">    "<span class="attribute">maxTime</span>" : <span class="value"><span class="string">"2015-12-02T01:42:52.597Z"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125; ]</span><br></pre></td></tr></table></figure>
<p>可以看到每次查询只会有一个timeBucket,因为默认是所有的记录都放在一个timeBucket里.   </p>
<p>4.queryType设置为timeseries, granularity时间粒度为minute,表示每分钟的数据为一个timeBucket:  </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">➜  druid-<span class="number">0</span>.<span class="number">8.2</span>  cat timeseries.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"queryType"</span>: <span class="string">"timeseries"</span>,</span><br><span class="line">    <span class="string">"dataSource"</span>: <span class="string">"wikipedia"</span>,</span><br><span class="line">    <span class="string">"intervals"</span>: [ <span class="string">"2010-01-01/2020-01-01"</span> ],</span><br><span class="line">    <span class="string">"granularity"</span>: <span class="string">"minute"</span>,</span><br><span class="line">    <span class="string">"aggregations"</span>: [</span><br><span class="line">        &#123;<span class="string">"type"</span>: <span class="string">"longSum"</span>, <span class="string">"fieldName"</span>: <span class="string">"count"</span>, <span class="string">"name"</span>: <span class="string">"edit_count"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"type"</span>: <span class="string">"doubleSum"</span>, <span class="string">"fieldName"</span>: <span class="string">"added"</span>, <span class="string">"name"</span>: <span class="string">"chars_added"</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">➜  druid-<span class="number">0</span>.<span class="number">8.2</span>  curl -X POST <span class="string">'http://localhost:8084/druid/v2/?pretty'</span> -H <span class="string">'content-type: application/json'</span>  -d  @timeseries.json</span><br><span class="line">[ &#123;</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="string">"2015-12-02T01:40:00.000Z"</span>,</span><br><span class="line">  <span class="string">"result"</span> : &#123;</span><br><span class="line">    <span class="string">"chars_added"</span> : <span class="number">18400.0</span>,</span><br><span class="line">    <span class="string">"edit_count"</span> : <span class="number">43</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="string">"2015-12-02T01:41:00.000Z"</span>,</span><br><span class="line">  <span class="string">"result"</span> : &#123;</span><br><span class="line">    <span class="string">"chars_added"</span> : <span class="number">45920.0</span>,</span><br><span class="line">    <span class="string">"edit_count"</span> : <span class="number">153</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="string">"2015-12-02T01:42:00.000Z"</span>,</span><br><span class="line">  <span class="string">"result"</span> : &#123;</span><br><span class="line">    <span class="string">"chars_added"</span> : <span class="number">104842.0</span>,</span><br><span class="line">    <span class="string">"edit_count"</span> : <span class="number">150</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;...</span><br></pre></td></tr></table></figure>
<p>5.topN查询: <code>select page,sum(count) as edit_count from x where country=&#39;US&#39; group by page order by edit_count desc</code> </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  druid-<span class="number">0</span>.<span class="number">8.2</span>  cat topn.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"queryType"</span>: <span class="string">"topN"</span>,</span><br><span class="line">  <span class="string">"dataSource"</span>: <span class="string">"wikipedia"</span>,</span><br><span class="line">  <span class="string">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="string">"dimension"</span>: <span class="string">"page"</span>,</span><br><span class="line">  <span class="string">"metric"</span>: <span class="string">"edit_count"</span>,</span><br><span class="line">  <span class="string">"threshold"</span> : <span class="number">10</span>,</span><br><span class="line">  <span class="string">"aggregations"</span>: [</span><br><span class="line">    &#123;<span class="string">"type"</span>: <span class="string">"longSum"</span>, <span class="string">"fieldName"</span>: <span class="string">"count"</span>, <span class="string">"name"</span>: <span class="string">"edit_count"</span>&#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"filter"</span>: &#123; <span class="string">"type"</span>: <span class="string">"selector"</span>, <span class="string">"dimension"</span>: <span class="string">"country"</span>, <span class="string">"value"</span>: <span class="string">"United States"</span> &#125;,</span><br><span class="line">  <span class="string">"intervals"</span>: [<span class="string">"2012-10-01T00:00/2020-01-01T00"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">➜  druid-<span class="number">0</span>.<span class="number">8.2</span>  curl -X POST <span class="string">'http://localhost:8084/druid/v2/?pretty'</span> -H <span class="string">'content-type: application/json'</span>  -d @topn.json</span><br><span class="line">[ &#123;</span><br><span class="line">  <span class="string">"timestamp"</span> : <span class="string">"2015-12-02T01:40:47.555Z"</span>,</span><br><span class="line">  <span class="string">"result"</span> : [ &#123;</span><br><span class="line">    <span class="string">"page"</span> : <span class="string">"Hillel_at_the_University_of_Illinois_at_Urbana-Champaign"</span>,</span><br><span class="line">    <span class="string">"edit_count"</span> : <span class="number">4</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"page"</span> : <span class="string">"All_Together_Now"</span>,</span><br><span class="line">    <span class="string">"edit_count"</span> : <span class="number">2</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">  .....]  //TOTAL <span class="number">10</span> RECORDS</span><br><span class="line">&#125; ]%</span><br></pre></td></tr></table></figure>
<p>5.RealTime实时节点的服务器日志:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">③ timeBoundary</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">42</span>:<span class="number">22</span>,<span class="number">513</span> INFO [timeBoundary_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:42:22.512Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/partial/time"</span>,<span class="string">"value"</span>:<span class="number">63</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"id"</span>:<span class="string">"b9474f46-fa0f-44a9-b4e2-5a1aba27c85c"</span>,<span class="string">"type"</span>:<span class="string">"timeBoundary"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">42</span>:<span class="number">22</span>,<span class="number">514</span> INFO [timeBoundary_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:42:22.513Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/wait/time"</span>,<span class="string">"value"</span>:<span class="number">18</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"id"</span>:<span class="string">"b9474f46-fa0f-44a9-b4e2-5a1aba27c85c"</span>,<span class="string">"type"</span>:<span class="string">"timeBoundary"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">42</span>:<span class="number">22</span>,<span class="number">622</span> INFO [qtp940621403-<span class="number">23</span>] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:42:22.620Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/time"</span>,<span class="string">"value"</span>:<span class="number">352</span>,<span class="string">"context"</span>:<span class="string">"&#123;\"queryId\":\"b9474f46-fa0f-44a9-b4e2-5a1aba27c85c\",\"timeout\":300000&#125;"</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"duration"</span>:<span class="string">"PT94670899200S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"false"</span>,<span class="string">"id"</span>:<span class="string">"b9474f46-fa0f-44a9-b4e2-5a1aba27c85c"</span>,<span class="string">"interval"</span>:[<span class="string">"0000-01-01T00:00:00.000Z/3000-01-01T00:00:00.000Z"</span>],<span class="string">"remoteAddress"</span>:<span class="string">"127.0.0.1"</span>,<span class="string">"type"</span>:<span class="string">"timeBoundary"</span>&#125;]</span><br><span class="line"></span><br><span class="line">④ timeseries</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">45</span>:<span class="number">40</span>,<span class="number">470</span> INFO [timeseries_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:45:40.470Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/partial/time"</span>,<span class="string">"value"</span>:<span class="number">51</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"duration"</span>:<span class="string">"PT315532800S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"false"</span>,<span class="string">"id"</span>:<span class="string">"ce112856-ce91-4ff4-ae47-06894843e2a6"</span>,<span class="string">"interval"</span>:[<span class="string">"2010-01-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"numComplexMetrics"</span>:<span class="string">"0"</span>,<span class="string">"numMetrics"</span>:<span class="string">"2"</span>,<span class="string">"type"</span>:<span class="string">"timeseries"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">45</span>:<span class="number">40</span>,<span class="number">471</span> INFO [timeseries_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:45:40.470Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/wait/time"</span>,<span class="string">"value"</span>:<span class="number">1</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"duration"</span>:<span class="string">"PT315532800S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"false"</span>,<span class="string">"id"</span>:<span class="string">"ce112856-ce91-4ff4-ae47-06894843e2a6"</span>,<span class="string">"interval"</span>:[<span class="string">"2010-01-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"numComplexMetrics"</span>:<span class="string">"0"</span>,<span class="string">"numMetrics"</span>:<span class="string">"2"</span>,<span class="string">"type"</span>:<span class="string">"timeseries"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">45</span>:<span class="number">40</span>,<span class="number">476</span> INFO [qtp940621403-<span class="number">22</span>] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:45:40.475Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/time"</span>,<span class="string">"value"</span>:<span class="number">151</span>,<span class="string">"context"</span>:<span class="string">"&#123;\"queryId\":\"ce112856-ce91-4ff4-ae47-06894843e2a6\",\"timeout\":300000&#125;"</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"duration"</span>:<span class="string">"PT315532800S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"false"</span>,<span class="string">"id"</span>:<span class="string">"ce112856-ce91-4ff4-ae47-06894843e2a6"</span>,<span class="string">"interval"</span>:[<span class="string">"2010-01-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"remoteAddress"</span>:<span class="string">"127.0.0.1"</span>,<span class="string">"type"</span>:<span class="string">"timeseries"</span>&#125;]</span><br><span class="line"></span><br><span class="line">内存数据持久化成Segment数据文件  </span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">551</span> INFO [chief-wikipedia[<span class="number">0</span>]] io.druid.segment.realtime.plumber.RealtimePlumber - Submitting persist runnable <span class="keyword">for</span> dataSource[wikipedia]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">581</span> INFO [wikipedia-incremental-persist] io.druid.segment.realtime.plumber.RealtimePlumber - DataSource[wikipedia], Interval[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z], Metadata [null] persisting Hydrant[FireHydrant&#123;index=io.druid.segment.incremental.OnheapIncrementalIndex@<span class="number">749297</span>a4, queryable=io.druid.segment.ReferenceCountingSegment@<span class="number">4421</span>cbc6, count=<span class="number">0</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">621</span> INFO [wikipedia-incremental-persist] io.druid.guice.PropertiesModule - Loading properties from common.runtime.properties</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">623</span> INFO [wikipedia-incremental-persist] io.druid.guice.PropertiesModule - Loading properties from runtime.properties</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">666</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - Starting persist <span class="keyword">for</span> interval[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52.507</span>Z], rows[<span class="number">1</span>,<span class="number">374</span>]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">52</span>,<span class="number">877</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - outDir[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>/v8-tmp] completed index.drd in <span class="number">21</span> millis.</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">53</span>,<span class="number">157</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - outDir[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>/v8-tmp] completed dim conversions in <span class="number">277</span> millis.</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">53</span>,<span class="number">833</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - outDir[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>/v8-tmp] completed walk through of <span class="number">1</span>,<span class="number">374</span> rows in <span class="number">675</span> millis.</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">54</span>,<span class="number">099</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - Starting dimension[user] with cardinality[<span class="number">468</span>]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">54</span>,<span class="number">146</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - Completed dimension[user] in <span class="number">47</span> millis.</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">54</span>,<span class="number">147</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexMerger - outDir[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>/v8-tmp] completed inverted.drd in <span class="number">313</span> millis.</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">49</span>:<span class="number">54</span>,<span class="number">188</span> INFO [wikipedia-incremental-persist] io.druid.segment.IndexIO$DefaultIndexIOHandler - Converting v8[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>/v8-tmp] to v9[/tmp/realtime/basePersist/wikipedia/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z_2015-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">⑤ topN</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">55</span>:<span class="number">04</span>,<span class="number">188</span> INFO [topN_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] io.druid.offheap.OffheapBufferPool - Allocating <span class="keyword">new</span> intermediate processing buffer[<span class="number">0</span>] of size[<span class="number">100</span>,<span class="number">000</span>,<span class="number">000</span>]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">55</span>:<span class="number">04</span>,<span class="number">319</span> INFO [topN_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:55:04.319Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/partial/time"</span>,<span class="string">"value"</span>:<span class="number">191</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"dimension"</span>:<span class="string">"page"</span>,<span class="string">"duration"</span>:<span class="string">"PT228787200S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"true"</span>,<span class="string">"id"</span>:<span class="string">"837752d5-7fa8-447f-bf21-b843827577db"</span>,<span class="string">"interval"</span>:[<span class="string">"2012-10-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"numComplexMetrics"</span>:<span class="string">"0"</span>,<span class="string">"numMetrics"</span>:<span class="string">"1"</span>,<span class="string">"threshold"</span>:<span class="string">"10"</span>,<span class="string">"type"</span>:<span class="string">"topN"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">55</span>:<span class="number">04</span>,<span class="number">320</span> INFO [topN_wikipedia_[<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">00</span>:<span class="number">00.000</span>Z/<span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T02:<span class="number">00</span>:<span class="number">00.000</span>Z]] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:55:04.319Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/wait/time"</span>,<span class="string">"value"</span>:<span class="number">1</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"dimension"</span>:<span class="string">"page"</span>,<span class="string">"duration"</span>:<span class="string">"PT228787200S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"true"</span>,<span class="string">"id"</span>:<span class="string">"837752d5-7fa8-447f-bf21-b843827577db"</span>,<span class="string">"interval"</span>:[<span class="string">"2012-10-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"numComplexMetrics"</span>:<span class="string">"0"</span>,<span class="string">"numMetrics"</span>:<span class="string">"1"</span>,<span class="string">"threshold"</span>:<span class="string">"10"</span>,<span class="string">"type"</span>:<span class="string">"topN"</span>&#125;]</span><br><span class="line"><span class="number">2015</span>-<span class="number">12</span>-<span class="number">02</span>T01:<span class="number">55</span>:<span class="number">04</span>,<span class="number">337</span> INFO [qtp940621403-<span class="number">26</span>] com.metamx.emitter.core.LoggingEmitter - Event [&#123;<span class="string">"feed"</span>:<span class="string">"metrics"</span>,<span class="string">"timestamp"</span>:<span class="string">"2015-12-02T01:55:04.336Z"</span>,<span class="string">"service"</span>:<span class="string">"realtime"</span>,<span class="string">"host"</span>:<span class="string">"localhost:8084"</span>,<span class="string">"metric"</span>:<span class="string">"query/time"</span>,<span class="string">"value"</span>:<span class="number">289</span>,<span class="string">"context"</span>:<span class="string">"&#123;\"queryId\":\"837752d5-7fa8-447f-bf21-b843827577db\",\"timeout\":300000&#125;"</span>,<span class="string">"dataSource"</span>:<span class="string">"wikipedia"</span>,<span class="string">"duration"</span>:<span class="string">"PT228787200S"</span>,<span class="string">"hasFilters"</span>:<span class="string">"true"</span>,<span class="string">"id"</span>:<span class="string">"837752d5-7fa8-447f-bf21-b843827577db"</span>,<span class="string">"interval"</span>:[<span class="string">"2012-10-01T00:00:00.000Z/2020-01-01T00:00:00.000Z"</span>],<span class="string">"remoteAddress"</span>:<span class="string">"127.0.0.1"</span>,<span class="string">"type"</span>:<span class="string">"topN"</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>6.总结:  </p>
<p>The most basic Druid setup: a single realtime node. We streamed in some data and queried it.<br>Realtime nodes collect very recent data and periodically hand that data off to the rest of the Druid cluster.<br>最基本的Druid设置, 单一的RealTime节点. 实时导入数据并查询这些数据. 实时节点会收集最近的数据,每隔一段时间将数据转换/保存到Druid集群中.  </p>
<p>Druid collects each individual event and packages them together in a container known as a segment.<br>Segments contain data over some span of time. 每条事件被收集并打包成Druid的segment容器,这个容器内的数据包含了一段时间的所有数据.  </p>
<hr>
<h2 id="Druid_Cluster(单机伪分布式)">Druid Cluster(单机伪分布式)</h2><p>Druid.io实时OLAP数据分析存储系统介绍: <a href="http://lxw1234.com/archives/2015/11/563.htm" target="_blank" rel="external">http://lxw1234.com/archives/2015/11/563.htm</a></p>
<p>0.依赖组件和配置文件  </p>
<p><code>config/_common/common.runtime.properties</code>文件定义了Druid外部依赖的三个组件:<br>ZooKeeper, MySQL, DeepStorage(HDFS). 在单机下, 可以设置为本地的ZK, derby, local本地文件系统.  </p>
<table>
<thead>
<tr>
<th>ConfigFile</th>
<th>Node</th>
<th>Port</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config/coordinator/runtime.properties</code></td>
<td>协调节点</td>
<td>8081</td>
</tr>
<tr>
<td><code>config/historical/runtime.properties</code></td>
<td>历史节点</td>
<td>8083</td>
</tr>
<tr>
<td><code>config/broker/runtime.properties</code></td>
<td>Broker</td>
<td>8082</td>
</tr>
<tr>
<td><code>config/realtime/runtime.properties</code></td>
<td>实时节点</td>
<td>8084  </td>
</tr>
</tbody>
</table>
<p>历史节点和实时节点类似于Worker|DataNode,在集群环境可以有多个.<br>在集群环境下, 在每个节点都要修改配置文件的druid.host为本机的IP地址.  </p>
<p>1.启动协调节点    </p>
<p>Coordinator nodes are in charge of load assignment and distribution. 协调节点负责加载任何和分发任务.<br>Coordinator nodes monitor the status of the cluster and command historical nodes to assign and drop segments. </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="constant">Xmx256m</span> -<span class="constant">Duser</span>.timezone=<span class="constant">UTC</span> -<span class="constant">Dfile</span>.encoding=<span class="constant">UTF</span>-<span class="number">8</span> -classpath config/<span class="symbol">_common:</span>config/<span class="symbol">coordinator:</span><span class="class"><span class="keyword">lib</span>/* <span class="title">io</span>.<span class="title">druid</span>.<span class="title">cli</span>.<span class="title">Main</span> <span class="title">server</span> <span class="title">coordinator</span></span></span><br></pre></td></tr></table></figure>
<p>2.启动历史节点  </p>
<p>Historical nodes are the workhorses of a cluster and are in charge of 历史节点会加载历史segments<br>loading historical segments and making them available for queries. 让这些segments能够被查询使用<br>Realtime nodes hand off segments to historical nodes 实时节点的数据会转换到历史节点上   </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="constant">Xmx256m</span> -<span class="constant">Duser</span>.timezone=<span class="constant">UTC</span> -<span class="constant">Dfile</span>.encoding=<span class="constant">UTF</span>-<span class="number">8</span> -classpath config/<span class="symbol">_common:</span>config/<span class="symbol">historical:</span><span class="class"><span class="keyword">lib</span>/* <span class="title">io</span>.<span class="title">druid</span>.<span class="title">cli</span>.<span class="title">Main</span> <span class="title">server</span> <span class="title">historical</span></span></span><br></pre></td></tr></table></figure>
<p>3.启动Broker  </p>
<p>Broker nodes are responsible for figuring out which historical and/or realtime nodes correspond to which queries. 更像Cassandra中的Coordinator<br>They also merge partial results from these nodes in a scatter/gather fashion. 确定查询要分发到那个历史节点和实时节点,并聚合这些节点的数据返回给客户端.  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="constant">Xmx256m</span> -<span class="constant">Duser</span>.timezone=<span class="constant">UTC</span> -<span class="constant">Dfile</span>.encoding=<span class="constant">UTF</span>-<span class="number">8</span> -classpath config/<span class="symbol">_common:</span>config/<span class="symbol">broker:</span><span class="class"><span class="keyword">lib</span>/* <span class="title">io</span>.<span class="title">druid</span>.<span class="title">cli</span>.<span class="title">Main</span> <span class="title">server</span> <span class="title">broker</span></span></span><br></pre></td></tr></table></figure>
<p>4.启动实时节点  </p>
<p>因为是测试环境,将间隔时间设少点, 下面表示窗口的大小为5分钟, 每隔一分钟统计过去五分钟的数据. 每隔3分钟持久化中间数据.  </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"segmentGranularity"</span>: <span class="string">"FIVE_MINUTE"</span>,</span><br><span class="line"><span class="string">"intermediatePersistPeriod"</span>: <span class="string">"PT3m"</span>,</span><br><span class="line"><span class="string">"windowPeriod"</span>: <span class="string">"PT1m"</span>,</span><br></pre></td></tr></table></figure>
<p>启动RealTime节点, 使用上面修改过的spec. 可以看到只有实时节点添加了specFile,因为实时节点负责读取数据源.    </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="constant">Xmx512m</span> -<span class="constant">Duser</span>.timezone=<span class="constant">UTC</span> -<span class="constant">Dfile</span>.encoding=<span class="constant">UTF</span>-<span class="number">8</span> -<span class="constant">Ddruid</span>.realtime.specFile=examples/wikipedia/wikipedia_realtime.spec -classpath config/<span class="symbol">_common:</span>config/<span class="symbol">realtime:</span><span class="class"><span class="keyword">lib</span>/* <span class="title">io</span>.<span class="title">druid</span>.<span class="title">cli</span>.<span class="title">Main</span> <span class="title">server</span> <span class="title">realtime</span></span></span><br></pre></td></tr></table></figure>
<p>5.All Things Up</p>
<p>Once the real-time node starts up, it should begin ingesting data and handing that data off to the rest of the Druid cluster.<br>You can use a web UI located at coordinator_ip:port to view the status of data being loaded.<br>Once data is handed off from the real-time nodes to historical nodes, the historical nodes should begin serving segments.<br>一旦启动了实时节点,数据就会流入并转换到Druid的集群中. 当数据从实时节点转换到历史节点,历史节点就可以用其上的segments服务于查询了.<br>当然数据在实时节点的时候是存在于实时节点的内存上, 当然查询也是没有问题的. 数据转换到历史节点是因为这些数据不再是实时数据了而是历史数据.      </p>
<p>6.客户端查询</p>
<p>向Broker(8082)发起查询请求, Broker会同时向实时节点和历史节点发起请求.  </p>
<p>curl -X POST ‘<a href="http://localhost:8082/druid/v2/?pretty" target="_blank" rel="external">http://localhost:8082/druid/v2/?pretty</a>‘ -H ‘content-type: application/json’ -d@examples/wikipedia/query.body</p>
<p>如果一开始就向历史节点(8083)发起查询请求,当实时节点还没运行足够长时间,不会转换数据到历史节点. 所以下面的查询刚开始没有数据<br>因为窗口大小为5分钟,所以实时节点至少五分钟后才会转换数据到历史节点(虽然持久化间隔为3分钟,但第一次还是需要5分钟的窗口填满)  </p>
<p>curl -X POST ‘<a href="http://localhost:8083/druid/v2/?pretty" target="_blank" rel="external">http://localhost:8083/druid/v2/?pretty</a>‘ -H ‘content-type: application/json’ -d@examples/wikipedia/query.body</p>
<p>实时节点(8084)的内存中保存有最近(索引过后)的数据,并且这部分数据还没转存到历史节点. 当历史节点回馈说它已经完全加载了segment:这里面包括了两个步骤<br>A.实时节点数据转存到历史节点, B.历史节点加载Segment到内存中. 同时实时节点就会丢弃这个segment. 因为只需要有一份数据存在即可.  </p>
<p>curl -X POST ‘<a href="http://localhost:8084/druid/v2/?pretty" target="_blank" rel="external">http://localhost:8084/druid/v2/?pretty</a>‘ -H ‘content-type: application/json’ -d@examples/wikipedia/query.body</p>
<p>如果你仅仅是需要查询数据, 只需要向Broker发起请求即可, 因为Broker会向实时节点和历史节点发起请求并将它们的结果合并起来返回给客户端.  </p>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/12/02/2015-12-02-Hello-Druid/">Druid入门</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 zqhxuyuan 的个人博客">zqhxuyuan</a></p>
  <p><span>发布时间:</span>2015年12月02日 - 00时00分</p>
  <p><span>最后更新:</span>2015年12月02日 - 19时37分</p>
  <p>
    <span>原始链接:</span><a href="/2015/12/02/2015-12-02-Hello-Druid/" title="Druid入门">http://github.com/zqhxuyuan/2015/12/02/2015-12-02-Hello-Druid/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/12/02/2015-12-02-Hello-Druid/　　作者: zqhxuyuan" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/11/29/2015-11-29-StreamCQL-application/">
        StreamCQL源码阅读(4) 应用程序执行
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello_Druid"><span class="toc-number">1.</span> <span class="toc-text">Hello Druid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Druid_Cluster(单机伪分布式)"><span class="toc-number">2.</span> <span class="toc-text">Druid Cluster(单机伪分布式)</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
</script>


<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    <div  class="post-nav-button">
    <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
    <a href="/2015/11/29/2015-11-29-StreamCQL-application/" title="下一篇: StreamCQL源码阅读(4) 应用程序执行">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  
    



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2015 zqhxuyuan
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>