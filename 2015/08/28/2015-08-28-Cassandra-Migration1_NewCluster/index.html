<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra数据迁移1 新集群sstableloader | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="采用sstableloader迁移keyspace到新的集群">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra数据迁移1 新集群sstableloader">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="采用sstableloader迁移keyspace到新的集群">
<meta property="og:updated_time" content="2015-12-19T08:31:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra数据迁移1 新集群sstableloader">
<meta name="twitter:description" content="采用sstableloader迁移keyspace到新的集群">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/cassandra/" style="font-size: 20px;">cassandra</a> <a href="/tags/drill/" style="font-size: 18.33px;">drill</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/hbase/" style="font-size: 16.67px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/storm/" style="font-size: 16.67px;">storm</a> <a href="/tags/timeseries/" style="font-size: 13.33px;">timeseries</a> <a href="/tags/work/" style="font-size: 11.67px;">work</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-08-28-Cassandra-Migration1_NewCluster" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/" class="article-date">
  	<time datetime="2015-08-27T16:00:00.000Z" itemprop="datePublished">2015-08-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra数据迁移1 新集群sstableloader
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>采用sstableloader迁移keyspace到新的集群</p>
<a id="more"></a>
<h2 id="完全迁移到新的集群">完全迁移到新的集群</h2><p>由于fp数据库和API数据库共用了一个集群, 需要将他们拆分开来. 首先想到的是使用不同的cluster_name来拆分集群.<br>由于使用新的集群, fp的cluster_name: forsetifp_cluster和API的不能一样. 启动新集群后,在新集群上建库和表.</p>
<p>Cassandra的sstableloader命令支持<code>不同集群相同表</code>的数据迁移.  </p>
<blockquote>
<p>Bulk load the sstables found in the directory <dir_path> to the configured cluster.<br>The parent directories of <dir_path> are used as the target keyspace/table name.<br>So for instance, to load an sstable named Standard1-g-1-Data.db into Keyspace1/Standard1,<br>you will need to have the files Standard1-g-1-Data.db and Standard1-g-1-Index.db<br>into a directory /path/to/Keyspace1/Standard1/. </dir_path></dir_path></p>
</blockquote>
<h3 id="使用sstableloader在线上环境直接迁移数据">使用sstableloader在线上环境直接迁移数据</h3><p>先迁移一张小表试试: <code>-d</code>指定目标集群的一个节点, <code>-t</code>表示限制流量, 最后跟上本地的sstable文件,路径名称必须是以<code>keyspace/table</code>结尾.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -t <span class="number">100</span> /home/admin/cassandra/data/forseti_fp/analysis</span><br><span class="line">Established connection to initial hosts</span><br><span class="line">Opening sstables and calculating sections to stream</span><br><span class="line">Streaming relevant part of /home/admin/cassandra/data/forseti_fp/analysis/forseti_fp-analysis-jb-<span class="number">681</span>-Data.db ... /home/admin/cassandra/data/forseti_fp/analysis/forseti_fp-analysis-jb-<span class="number">679</span>-Data.db to [/<span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>, /<span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br><span class="line">progress: [/<span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> <span class="number">1</span>/<span class="number">13</span> (<span class="number">11</span>%)] [/<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> <span class="number">1</span>/<span class="number">13</span> (<span class="number">16</span>%)] [/<span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> <span class="number">1</span>/<span class="number">13</span> (<span class="number">12</span>%)] [total: <span class="number">13</span>% - <span class="number">13</span>MB/s (avg: <span class="number">11</span>MB/s)]</span><br><span class="line"></span><br><span class="line">cqlsh:forseti_fp&gt; select * from analysis  limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>上面的命令只是在一台节点上导入数据, 可以使用pssh在多个节点上同时导入数据到新集群:   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pssh.sh sstableloader -d <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -t <span class="number">100</span> /home/admin/cassandra/data/forseti_fp/device</span><br></pre></td></tr></table></figure>
<p><strong>A.流式传输日志</strong>  </p>
<p>sstablaloader的日志: <code>Streaming session ID: 526d2ac0-5532-11e5-a9de-1f1f9de152fa</code><br>在目标节点比如192.168.47.227,228,229可以使用<code>/usr/install/cassandra/bin/nodetool netstats</code>查看  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Bulk Load <span class="number">526</span>d2ac0-<span class="number">5532</span>-<span class="number">11e5</span>-a9de-<span class="number">1f</span>1f9de152fa</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>   这个地址表示,我们从<span class="number">203</span>上接收sstable文件,因为我们是在<span class="number">203</span>上执行sstableloader的</span><br><span class="line">        Receiving <span class="number">69</span> files, <span class="number">6115178100</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/forseti_fp/device/forseti_fp-device-tmp-jb-<span class="number">281</span>-Data.db <span class="number">96819976</span>/<span class="number">96819976</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">            /home/admin/cassandra/data/forseti_fp/device/forseti_fp-device-tmp-jb-<span class="number">305</span>-Data.db <span class="number">31697456</span>/<span class="number">77911162</span> bytes(<span class="number">40</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">            /home/admin/cassandra/data/forseti_fp/device/forseti_fp-device-tmp-jb-<span class="number">277</span>-Data.db <span class="number">43450644</span>/<span class="number">43450644</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br></pre></td></tr></table></figure>
<p>注意在数据量比较大的情况下, 在完成sstableloader后,还会发生compact操作,导致任务一直停留在100%.<br>用<code>nodetool compactionstats</code>查看正在压缩的任务. compact操作发生在频繁写之后,数据需要进一步整理.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ /usr/install/cassandra/bin/nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">29</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction      forseti_fp          device     <span class="number">10620227497</span>     <span class="number">10702378205</span>     bytes    <span class="number">99.23</span>%</span><br><span class="line">    Secondary index build      forseti_fp          device       <span class="number">802354029</span>      <span class="number">1632639051</span>     bytes    <span class="number">49.14</span>%</span><br><span class="line">               Compaction      forseti_fpdevice.idx_device_id       <span class="number">832357202</span>      <span class="number">3409232297</span>     bytes    <span class="number">24.41</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h00m19s</span><br></pre></td></tr></table></figure>
<p>待Compact完成后,再次查看时,就没有pending tasks了:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@cass</span>047203 ~]$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/nodetool compactionstats</span><br><span class="line">pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">Active compaction remaining <span class="string">time :</span>        n/a</span><br></pre></td></tr></table></figure>
<p>可以使用<code>nodetool stop compaction</code>停止sstable文件的compact操作.<br><code>STOP COMPACTION</code>只是停止数据文件的压缩, <code>STOP INDEX_BUILD</code>可以停止索引文件的压缩.<br>下面forseti_fpdevice.idx_device_id并没有停止,是因为它仍然被看做是数据文件.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ /usr/install/cassandra/bin/nodetool stop COMPACTION</span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ /usr/install/cassandra/bin/nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">42</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">    Secondary index build      forseti_fp          device       <span class="number">160531470</span>      <span class="number">2489616783</span>     bytes     <span class="number">6.45</span>%</span><br><span class="line">Active compaction remaining time :        n/a</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ /usr/install/cassandra/bin/nodetool stop INDEX_BUILD</span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ /usr/install/cassandra/bin/nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">42</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction      forseti_fpdevice.idx_device_id       <span class="number">631023211</span>      <span class="number">3151732378</span>     bytes    <span class="number">20.02</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h00m18s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>索引文件和二级索引是两个不同的概念. 索引是对PARTITION KEY的索引, 为了加快根据主键查询的速度.<br>而二级索引则是为非主键建立索引, 在C*中,如果根据字段查询不是主键,则必须手工建立这个字段的二级索引.  </p>
</blockquote>
<p><strong>B.重复数据迁移不影响数据</strong>  </p>
<p>下面是第一次迁移后,第二次迁移后的数据文件,可以看到虽然数据文件名称发生了变化,<br>但是因为是重复迁移,最后的文件数和文件大小都是一样的,也就是说重复迁移没有影响.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> install]$ ll /home/admin/cassandra/data/forseti_fp/analysis | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167784007</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">14</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167792674</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">15</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167776882</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">16</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167776931</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">17</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167789532</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">18</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167789386</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">19</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167791770</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">20</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">119734715</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">21</span>-Data.db</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> install]$ ll /home/admin/cassandra/data/forseti_fp/analysis  | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167784007</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">35</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167792674</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">36</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167776882</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">37</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167776931</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">38</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167789532</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">39</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167789386</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">09</span> forseti_fp-analysis-jb-<span class="number">40</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">167791770</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">10</span> forseti_fp-analysis-jb-<span class="number">41</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">119734715</span> <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">10</span> forseti_fp-analysis-jb-<span class="number">42</span>-Data.db</span><br></pre></td></tr></table></figure>
<p>第二次迁移时会产生新的数据文件(如果迁移没有完成,则会有临时文件). 在迁移完成一段时间后,<br>因为是重复数据, 第一次迁移生成的数据文件会被删除, 替代的是第二次迁移生成的数据文件.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> install]$ ll /home/admin/cassandra/data/forseti_fp/analysis -h | grep Data</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">161</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">14</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">161</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">09</span>:<span class="number">42</span> forseti_fp-analysis-jb-<span class="number">15</span>-Data.db</span><br><span class="line">...</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">32</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">01</span> forseti_fp-analysis-jb-<span class="number">33</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">119</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">01</span> forseti_fp-analysis-jb-<span class="number">34</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">161</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">02</span> forseti_fp-analysis-tmp-jb-<span class="number">35</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">161</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">03</span> forseti_fp-analysis-tmp-jb-<span class="number">36</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">161</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">04</span> forseti_fp-analysis-tmp-jb-<span class="number">37</span>-Data.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">45</span>M <span class="number">9</span>月   <span class="number">2</span> <span class="number">10</span>:<span class="number">05</span> forseti_fp-analysis-tmp-jb-<span class="number">38</span>-Data.db</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果正在迁移,会发现生成的是tmp临时文件,而且编号也是不断增加的.  </p>
</blockquote>
<p><strong>C.BUT SOMETHING WRONG!</strong>  </p>
<p>索引文件不存在:<a href="http://stackoverflow.com/questions/21684071/how-to-dump-indexed-db-files-with-sstableloader-in-cassandra" target="_blank" rel="external">http://stackoverflow.com/questions/21684071/how-to-dump-indexed-db-files-with-sstableloader-in-cassandra</a><br>数据文件不存在: <a href="https://issues.apache.org/jira/browse/CASSANDRA-7145" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-7145</a>  </p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Skipping <span class="type">file</span> forseti_fp-device.idx_device_id-jb-<span class="number">7781</span>-Data.db: column family forseti_fp.device.idx_device_id doesn't exist</span><br><span class="line"></span><br><span class="line">Streaming <span class="keyword">error</span> occurred</span><br><span class="line">java.lang.RuntimeException: java.io.FileNotFoundException: /home/admin/cassandra/data/forseti_fp/device/forseti_fp-device-jb-<span class="number">11605</span>-Data.db (No such <span class="type">file</span> <span class="keyword">or</span> directory)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.java:<span class="number">59</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.io.sstable.SSTableReader.openDataReader(SSTableReader.java:<span class="number">1409</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.compress.CompressedStreamWriter.<span class="command">write</span>(CompressedStreamWriter.java:<span class="number">55</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.messages.OutgoingFileMessage$<span class="number">1.</span>serialize(OutgoingFileMessage.java:<span class="number">59</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.messages.OutgoingFileMessage$<span class="number">1.</span>serialize(OutgoingFileMessage.java:<span class="number">42</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:<span class="number">45</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:<span class="number">339</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.<span class="command">run</span>(ConnectionHandler.java:<span class="number">311</span>)</span><br><span class="line">  <span class="keyword">at</span> java.lang.Thread.<span class="command">run</span>(Thread.java:<span class="number">744</span>)</span><br><span class="line">java.lang.RuntimeException: Outgoing stream handler has been closed</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.ConnectionHandler.sendMessage(ConnectionHandler.java:<span class="number">126</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.StreamSession.maybeCompleted(StreamSession.java:<span class="number">667</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.StreamSession.taskCompleted(StreamSession.java:<span class="number">619</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.StreamTransferTask.complete(StreamTransferTask.java:<span class="number">84</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.StreamSession.received(StreamSession.java:<span class="number">542</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.StreamSession.messageReceived(StreamSession.java:<span class="number">424</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.<span class="command">run</span>(ConnectionHandler.java:<span class="number">245</span>)</span><br><span class="line">  <span class="keyword">at</span> java.lang.Thread.<span class="command">run</span>(Thread.java:<span class="number">744</span>)</span><br></pre></td></tr></table></figure>
<p>查看这些数据文件,它们的编号都是最新的, 说明可能是最近flush到磁盘上,但是因为compact操作压缩为新的文件,删除之前flush的文件.导致之前flush的文件找不到才报错的.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">flush</span> forseti_fp device &amp;&amp; \</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">refresh</span> forseti_fp device &amp;&amp; \</span><br><span class="line">sudo -u <span class="keyword">admin</span> /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/sstableloader -<span class="keyword">d</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -<span class="keyword">t</span> <span class="number">50</span> /home/<span class="keyword">admin</span>/cassandra/<span class="keyword">data</span>/forseti_fp/device</span></span><br></pre></td></tr></table></figure>
<p>上面最后一句用<code>sudo -u admin</code>是因为flush产生的Summary.db文件没有权限. 如果没有使用admin,则报错:   </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> FSWriteError <span class="keyword">in</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>device/forseti_fp-device-jb-<span class="number">11150</span>-Summary.db</span><br><span class="line">Caused <span class="string">by:</span> java.nio.file.<span class="string">AccessDeniedException:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>device/forseti_fp-device-jb-<span class="number">11150</span>-Summary.db</span><br></pre></td></tr></table></figure>
<h3 id="非线上集群环境执行sstableloader">非线上集群环境执行sstableloader</h3><p>因为在线上会经常发生compaction,压缩操作会合并数据文件,并删除已经合并过的数据文件.<br>因此线上直接执行sstableloader时,在内存中会记录旧的数据文件,导致loader会找不到这些数据文件,报错FNFE.<br>所以一个办法是:将sstable都拷贝到另外的机器上(当然要求那个机器的容量足够).  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在目标节点(<span class="number">227</span>):建立从线上不同节点过来的文件夹(节点<span class="regexp">/ks/</span>tb).不能放在一起,因为不同节点的数据文件名称可能相同.  </span><br><span class="line">mkdir <span class="regexp">~/202/</span>forseti_fp <span class="regexp">~/203/</span>forseti_fp <span class="regexp">~/204/</span>forseti_fp <span class="regexp">~/205/</span>forseti_fp <span class="regexp">~/206/</span>forseti_fp <span class="regexp">~/221/</span>forseti_fp <span class="regexp">~/222/</span>forseti_fp <span class="regexp">~/224/</span>forseti_fp <span class="regexp">~/225/</span>forseti_fp <span class="regexp">~/226/</span>forseti_fp -p</span><br><span class="line"></span><br><span class="line">在线上各个节点复制表名的文件夹到目标节点, 其中最后的路径要按照keyspace/table,注意修改最后的文件夹:  </span><br><span class="line">du --max-depth=<span class="number">1</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>device_session_map -h</span><br><span class="line">scp -r <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>device_session_map qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>:<span class="regexp">~/202/</span>forseti_fp</span><br><span class="line">scp -r <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>device_session_map qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>:<span class="regexp">~/203/</span>forseti_fp</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">在目标节点load数据到新的集群中:  </span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader -d 192.168.47.227 -t 100 /</span>home<span class="regexp">/qihuang.zheng/</span><span class="number">205</span><span class="regexp">/forseti_fp/</span>device</span><br><span class="line"></span><br><span class="line">考虑到非线上集群,所以可以不用限制速率:  </span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader -d 192.168.47.227 /</span>home<span class="regexp">/qihuang.zheng/</span><span class="number">205</span><span class="regexp">/forseti_fp/</span>device</span><br><span class="line"></span><br><span class="line">load完毕,记得删除数据:</span><br><span class="line">rm -rf <span class="regexp">~/205/</span>forseti_fp<span class="regexp">/device ~/</span><span class="number">206</span><span class="regexp">/forseti_fp/</span>device <span class="regexp">~/221/</span>forseti_fp<span class="regexp">/device ~/</span><span class="number">222</span><span class="regexp">/forseti_fp/</span>device <span class="regexp">~/224/</span>forseti_fp<span class="regexp">/device ~/</span><span class="number">225</span><span class="regexp">/forseti_fp/</span>device <span class="regexp">~/226/</span>forseti_fp/device</span><br></pre></td></tr></table></figure>
<p>自动化脚本要做的是: 登陆到每台远程服务器上,将sstable文件拷贝到指定节点的指定文件夹,并在指定节点执行sstableloader命令,执行完成后,删除拷贝过来的文件.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pexpect</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. scp -r /home/admin/cassandra/data/forseti_fp/device qihuang.zheng@192.168.47.227:~/202/forseti_fp</span></span><br><span class="line"><span class="comment">#2. /usr/install/cassandra/bin/sstableloader -d 192.168.47.227 /home/qihuang.zheng/202/forseti_fp/device</span></span><br><span class="line"><span class="comment">#3. rm -rf ~/202/forseti_fp/device</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">username = <span class="string">"qihuang.zheng"</span>  <span class="comment">#用户名</span></span><br><span class="line">passwd = <span class="string">"xxx@"</span>      <span class="comment">#密码</span></span><br><span class="line"></span><br><span class="line">host_post = [<span class="number">202</span>,<span class="number">203</span>,<span class="number">204</span>,<span class="number">205</span>,<span class="number">206</span>,<span class="number">221</span>,<span class="number">222</span>,<span class="number">223</span>,<span class="number">224</span>,<span class="number">225</span>,<span class="number">226</span>]</span><br><span class="line">tables = [<span class="string">'analysis'</span>,<span class="string">'android_device_index'</span>,<span class="string">'android_device_session_temp'</span>,<span class="string">'device'</span>,<span class="string">'device_session'</span>,<span class="string">'ios_device_index'</span>,</span><br><span class="line">          <span class="string">'ios_device_session  page_info'</span>,<span class="string">'tcp_stack_ua'</span>,<span class="string">'android_device'</span>,<span class="string">'android_device_session'</span>,<span class="string">'api_invoke_result'</span>,</span><br><span class="line">          <span class="string">'devicedbmap'</span>,<span class="string">'device_session_map'</span>,<span class="string">'ios_device_info'</span>,<span class="string">'ip_device_id'</span>,<span class="string">'smart_device_map'</span>,<span class="string">'tcp_syn_data'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#inputPass=1: 需要输入密码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssh2</span><span class="params">(ip,cmd,inputPass)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ssh = paramiko.SSHClient()</span><br><span class="line">        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">        ssh.connect(ip,<span class="number">22</span>,username,passwd,timeout=<span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> cmd:</span><br><span class="line">            stdin, stdout, stderr = ssh.exec_command(m)</span><br><span class="line">            <span class="keyword">if</span>(inputPass==<span class="number">1</span>):</span><br><span class="line">                stdin.write(passwd)</span><br><span class="line">            out = stdout.readlines()</span><br><span class="line">            <span class="comment">#屏幕输出</span></span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> out:</span><br><span class="line">                <span class="keyword">print</span> o,</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'%s\tOK\n'</span>%(ip)</span><br><span class="line">        ssh.close()</span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'%s\tError\n'</span>%(ip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    table = <span class="string">"ip_device_id"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> host_post:</span><br><span class="line">        ip=<span class="string">"192.168.47."</span>+i</span><br><span class="line">        cmd1=<span class="string">"scp -r /home/admin/cassandra/data/forseti_fp/"</span>+table+<span class="string">" qihuang.zheng@192.168.47.227:~/"</span>+ip+<span class="string">"/forseti_fp"</span></span><br><span class="line">        ssh2(ip,cmd1,<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'scp complete@'</span>+ip</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> host_post:</span><br><span class="line">        cmd2=<span class="string">"/usr/install/cassandra/bin/sstableloader -d 192.168.47.227 /home/qihuang.zheng/"</span>+i+<span class="string">"/forseti_fp/"</span>+table</span><br><span class="line">        ssh2(<span class="string">"192.168.47.227"</span>,cmd2,<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'sstableloader complete@192.168.47.'</span>+i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> host_post:</span><br><span class="line">        cmd3=<span class="string">"rm -rf ~/"</span>+i+<span class="string">"/forseti_fp/"</span>+table</span><br><span class="line">        ssh2(<span class="string">"192.168.47.227"</span>,cmd3,<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'rm backfile complete@192.168.47.'</span>+i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'all complete..'</span></span><br></pre></td></tr></table></figure>
<p><strong>线上forseti_fp数据迁移方案一</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>[大数据]       历史数据导入到新集群(<span class="number">227</span>)中</span><br><span class="line"><span class="number">2.</span>[forseti_fp]  写入业务逻辑同时写入到两个集群(<span class="number">202</span>,<span class="number">207</span>), 查询业务仍然不变</span><br><span class="line"><span class="number">3.</span>[大数据]       历史数据和业务写入之间的数据同步</span><br><span class="line"><span class="number">4.</span>[forseti_fp]  关闭写入旧集群(<span class="number">202</span>),查询业务更改为查询新集群.</span><br><span class="line"></span><br><span class="line">-----|-------------------|------------------------|------------------------|-----------------</span><br><span class="line">   T1:导入历史数据       T2:写入双集群,查询旧集群    T3:同步T1-T2之间的数据     T4:关闭写入旧集群,查询新集群</span><br></pre></td></tr></table></figure>
<h3 id="使用快照snapshot方式">使用快照snapshot方式</h3><p>由于sstableloader的缺点是不能迁移整个keyspace. 而snapshot支持一个keyspace. 先以一张表测试: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 snapshots]$ sudo -u admin /usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">snapshot</span> -cf analysis forseti_fp</span><br><span class="line">Requested creating <span class="keyword">snapshot</span> <span class="keyword">for</span>: forseti_fp <span class="keyword">and</span> <span class="keyword">table</span>: analysis</span><br><span class="line"><span class="keyword">Exception</span> <span class="keyword">in</span> <span class="keyword">thread</span> <span class="string">"main"</span> <span class="keyword">java</span>.lang.RuntimeException: Tried <span class="keyword">to</span> hard <span class="keyword">link</span> <span class="keyword">to</span> <span class="keyword">file</span> that does <span class="keyword">not</span> exist /home/<span class="keyword">admin</span>/cassandra/<span class="keyword">data</span>/forseti_fp/analysis/forseti_fp-analysis-jb-<span class="number">674</span>-Summary.db</span></span><br></pre></td></tr></table></figure>
<p>恢复快照有几种方式: <a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_backup_snapshot_restore_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_backup_snapshot_restore_t.html</a>  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">You can <span class="operator"><span class="keyword">restore</span> a <span class="keyword">snapshot</span> <span class="keyword">in</span> several ways:</span><br><span class="line"></span><br><span class="line">+ <span class="keyword">Use</span> the sstableloader tool.</span><br><span class="line">+ Copy the <span class="keyword">snapshot</span> SSTable <span class="keyword">directory</span> <span class="keyword">to</span> the <span class="keyword">data</span>/keyspace/table_name <span class="keyword">directory</span> <span class="keyword">and</span> <span class="keyword">then</span> <span class="keyword">call</span> the JMX method </span><br><span class="line">  loadNewSSTables() <span class="keyword">in</span> the <span class="keyword">column</span> family MBean <span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">column</span> family <span class="keyword">through</span> JConsole. </span><br><span class="line">  You can <span class="keyword">use</span> nodetool <span class="keyword">refresh</span> instead <span class="keyword">of</span> the loadNewSSTables() <span class="keyword">call</span>.</span><br><span class="line"></span><br><span class="line">  The tokens <span class="keyword">for</span> the cluster you <span class="keyword">are</span> restoring must <span class="keyword">match</span> exactly the tokens <span class="keyword">of</span> the backed-up cluster <span class="keyword">at</span> the <span class="keyword">time</span> <span class="keyword">of</span> the <span class="keyword">snapshot</span>. </span><br><span class="line">  Furthermore, the <span class="keyword">snapshot</span> must be copied <span class="keyword">to</span> the correct node <span class="keyword">with</span> matching tokens matching. </span><br><span class="line">  <span class="keyword">If</span> the tokens <span class="keyword">do</span> <span class="keyword">not</span> <span class="keyword">match</span>, <span class="keyword">or</span> the <span class="built_in">number</span> <span class="keyword">of</span> nodes <span class="keyword">do</span> <span class="keyword">not</span> <span class="keyword">match</span>, <span class="keyword">use</span> the sstableloader <span class="keyword">procedure</span>.</span><br><span class="line">+ Node restart 重启节点,在线上环境不建议使用!</span></span><br></pre></td></tr></table></figure>
<p>第一种方式使用sstableloader我们已经试过了. 第二种直接拷贝snapshot快照文件到数据文件的目录,并刷新节点.<br>但是这里有个限制: 恢复节点和备份节点的tokens必须完全匹配. 并且快照要拷贝到匹配的tokens的正确节点上. 看起来手工操作无法完成了.    </p>
<p><strong>snapshot和hard link</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 forseti_fp]$ du --max-depth=<span class="number">1</span> . -h</span><br><span class="line"><span class="number">2.2</span>G  ./analysis</span><br><span class="line"></span><br><span class="line">可以看到analysis目录大小为<span class="number">2.2</span>G. analysize包含了数据文件和snapshots目录</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 analysis]$ du --max-depth=<span class="number">1</span> . -h</span><br><span class="line"><span class="number">208</span>M  ./snapshots</span><br><span class="line"><span class="number">2.2</span>G  .</span><br><span class="line"></span><br><span class="line">可以看到snapshots目录占用了<span class="number">208</span>M. 但是进入snapshots后, 它的一个快照占用了<span class="number">2.2</span>G,但是因为是硬链接,不会占用实际硬盘空间的.  </span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 analysis]$ cd snapshots/</span><br><span class="line">[qihuang.zheng@cass047202 snapshots]$ ls</span><br><span class="line"><span class="number">46</span>c7a471-<span class="number">46</span>d7-<span class="number">11e5</span>-a829-e3947c4c5aee</span><br><span class="line">[qihuang.zheng@cass047202 snapshots]$ du --max-depth=<span class="number">1</span> . -h</span><br><span class="line"><span class="number">2.2</span>G  ./<span class="number">46</span>c7a471-<span class="number">46</span>d7-<span class="number">11e5</span>-a829-e3947c4c5aee</span><br><span class="line"><span class="number">2.2</span>G  .</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2><ul>
<li>迁移数据库, 首先想到的是使用不同的cluster_name</li>
<li>Cassandra提供了sstableloader命令可以在不同的集群中迁移数据</li>
<li>线上直接使用sstableloader会遇到FileNotFoundException, PASS</li>
<li>将线上数据拷贝到线下,在线下做sstableloader, 需要将所有线上数据拷贝到线下, 虽然可以自动化,但是比较麻烦</li>
<li>sstableloader一次只能导入一张表, snapshot可以一次一个数据库</li>
</ul>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/">Cassandra数据迁移1 新集群sstableloader</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年08月28日 - 00时00分</p>
  <p><span>最后更新:</span>2015年12月19日 - 16时31分</p>
  <p>
    <span>原始链接:</span><a href="/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/" title="Cassandra数据迁移1 新集群sstableloader">http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/08/28/2015-08-28-Cassandra-Migration1_NewCluster/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/">
        Cassandra数据迁移3 多数据中心数据迁移
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/">
        Apache Cassandra架构理解
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#完全迁移到新的集群"><span class="toc-number">1.</span> <span class="toc-text">完全迁移到新的集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用sstableloader在线上环境直接迁移数据"><span class="toc-number">1.1.</span> <span class="toc-text">使用sstableloader在线上环境直接迁移数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非线上集群环境执行sstableloader"><span class="toc-number">1.2.</span> <span class="toc-text">非线上集群环境执行sstableloader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用快照snapshot方式"><span class="toc-number">1.3.</span> <span class="toc-text">使用快照snapshot方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.</span> <span class="toc-text">总结</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
</script>


<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/08/28/2015-08-28-Cassandra-Migration3_TestSandbox/" title="上一篇: Cassandra数据迁移3 多数据中心数据迁移">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/08/25/2015-08-25-Cassandra-Architecture/" title="下一篇: Apache Cassandra架构理解">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2015 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>