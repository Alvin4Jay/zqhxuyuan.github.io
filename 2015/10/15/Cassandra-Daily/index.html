<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra日常运维 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Cassandra日常运维, OpsCenter">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra日常运维">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/10/15/Cassandra-Daily/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="Cassandra日常运维, OpsCenter">
<meta property="og:image" content="http://img.blog.csdn.net/20151030101713671">
<meta property="og:updated_time" content="2016-03-15T11:54:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra日常运维">
<meta name="twitter:description" content="Cassandra日常运维, OpsCenter">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/cassandra/" style="font-size: 18.57px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 17.14px;">drill</a> <a href="/tags/druid/" style="font-size: 14.29px;">druid</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/hbase/" style="font-size: 15.71px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/redis/" style="font-size: 11.43px;">redis</a> <a href="/tags/scala/" style="font-size: 12.86px;">scala</a> <a href="/tags/spark/" style="font-size: 14.29px;">spark</a> <a href="/tags/storm/" style="font-size: 15.71px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12.86px;">timeseries</a> <a href="/tags/work/" style="font-size: 11.43px;">work</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Cassandra-Daily" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/15/Cassandra-Daily/" class="article-date">
  	<time datetime="2015-10-14T16:00:00.000Z" itemprop="datePublished">2015-10-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra日常运维
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>Cassandra日常运维, OpsCenter</p>
<a id="more"></a>
<h2 id="Cassandra日常运维">Cassandra日常运维</h2><h3 id="线上应急">线上应急</h3><p><strong>[日志]超过10s的GC:</strong>  </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> /var/<span class="built_in">log</span>/cassandra/<span class="built_in">system</span>.<span class="built_in">log</span> | <span class="keyword">grep</span> <span class="string">'2016-03'</span> | <span class="keyword">grep</span> <span class="string">'GC for .*: [0-9][0-9][0-9][0-9][0-9]'</span></span><br><span class="line"></span><br><span class="line">./pssh.<span class="keyword">sh</span> ip_forseti.txt <span class="string">"cat /var/log/cassandra/system.log | grep '2016-03' | grep 'GC for .*: [0-9][0-9][0-9][0-9][0-9]'"</span></span><br><span class="line"></span><br><span class="line">./pssh.<span class="keyword">sh</span> ip_forseti.txt <span class="string">"nodetool compactionstats"</span></span><br><span class="line"></span><br><span class="line">不需要pssh也可以执行多台机器的命令（仅限于nodetool可以指定-<span class="keyword">h</span>的命令）：</span><br><span class="line">nodetool status| fgrep RAC|cut -b5-<span class="number">20</span> | <span class="keyword">while</span> <span class="keyword">read</span> ip; <span class="keyword">do</span> <span class="keyword">echo</span> $ip; nodetool -<span class="keyword">h</span> $ip cfhistograms forseti velocity_global; done</span><br><span class="line"></span><br><span class="line"><span class="keyword">cat</span> /var/<span class="built_in">log</span>/cassandra/<span class="built_in">system</span>.<span class="built_in">log</span> | <span class="keyword">grep</span> <span class="string">'GC for ConcurrentMarkSweep'</span> | <span class="keyword">grep</span> <span class="string">'2015-11-03'</span></span><br><span class="line"></span><br><span class="line">tail -<span class="keyword">f</span> /var/<span class="built_in">log</span>/cassandra/<span class="built_in">system</span>.<span class="built_in">log</span> | <span class="keyword">grep</span> <span class="string">'2016-03-02'</span> | <span class="keyword">grep</span> <span class="string">'GC'</span></span><br><span class="line"></span><br><span class="line">fgrep <span class="string">'GC for'</span> /var/<span class="built_in">log</span>/cassandra/<span class="built_in">system</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p><strong>[JVM]查看GC:</strong>  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo -<span class="keyword">u</span> admin jstat -gc -<span class="keyword">h</span> 10 `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` 1000 | \</span><br><span class="line">awk '&#123;printf(<span class="string">"%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t\n"</span>,<span class="label">$1</span>,<span class="label">$5</span>,<span class="label">$3</span>,<span class="label">$4</span>,<span class="label">$6</span>,<span class="label">$8</span>,<span class="label">$11</span>,<span class="label">$12</span>,<span class="label">$13</span>,<span class="label">$14</span>)&#125;'</span><br><span class="line"></span><br><span class="line">sudo -<span class="keyword">u</span> admin jstat -gcutil `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` 1000 </span><br><span class="line"></span><br><span class="line">sudo -<span class="keyword">u</span> admin jstat -gc -<span class="keyword">h</span> 10 `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` 500 | \</span><br><span class="line">awk '&#123;printf(<span class="string">"%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t\n"</span>,<span class="label">$1</span>,<span class="label">$3</span>,<span class="label">$4</span>,<span class="label">$5</span>,<span class="label">$6</span>,<span class="label">$7</span>,<span class="label">$8</span>,<span class="label">$11</span>,<span class="label">$12</span>,<span class="label">$13</span>,<span class="label">$14</span>)&#125;'</span><br><span class="line"></span><br><span class="line">sudo -<span class="keyword">u</span> admin jmap -dump:<span class="keyword">format</span>=b,<span class="keyword">file</span>=/home/qihuang.zheng/1031.dat `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'`</span><br><span class="line"></span><br><span class="line">       S0C         S0U         S1U          EC          EU          OC          <span class="keyword">OU</span>         YGC        YGCT         FGC        FGCT</span><br><span class="line">  419392.0    419392.0    419392.0   3355520.0   3355520.0  12582912.0  11641724.1      995186   39005.793        1951     810.868</span><br></pre></td></tr></table></figure>
<p><strong>[进程]重启Cassandra进程:</strong>  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool <span class="keyword">flush</span> &amp;&amp; </span><br><span class="line">sudo -u <span class="keyword">admin</span> <span class="keyword">kill</span> -<span class="number">9</span> <span class="string">`sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;'`</span></span><br><span class="line">ps -ef|grep cassandra</span><br><span class="line">sudo -u <span class="keyword">admin</span> /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cassandra</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool setstreamthroughput <span class="comment">-- 4</span></span></span><br></pre></td></tr></table></figure>
<p><strong>[日志]查询tombstone:</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_forseti<span class="class">.txt</span> <span class="string">"cat /var/log/cassandra/system.log | grep '2015-11-05' | grep 'tombstone'"</span></span><br><span class="line">./pssh<span class="class">.sh</span> ip_forseti<span class="class">.txt</span> <span class="string">"cat /var/log/cassandra/system.log | grep '2015-11-05' | grep 'messages dropped in last 5000ms'"</span></span><br></pre></td></tr></table></figure>
<p><strong>[网络]查看网卡流量和限制Streams流量:</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool getstreamthroughput'</span></span><br><span class="line"></span><br><span class="line">sudo iftop  </span><br><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool setstreamthroughput -- 10'</span></span><br></pre></td></tr></table></figure>
<p><strong>[进程]查看最耗费CPU的线程:</strong>  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top -Hp `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` | head -8 | tail -1 | awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'</span><br><span class="line">printf '%x\<span class="keyword">n</span>' </span><br><span class="line">sudo -<span class="keyword">u</span> admin jstack `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` | grep</span><br></pre></td></tr></table></figure>
<p><strong>[统计]查看表的读写延迟:</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_forseti<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool cfstats forseti.velocity | head -3'</span></span><br><span class="line"></span><br><span class="line">./pssh<span class="class">.sh</span> ip_fp<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool cfstats forseti_fp.android_device_session_temp | head -3'</span></span><br><span class="line">./pssh<span class="class">.sh</span> ip_fp<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool cfstats forseti_fp.ios_device_session | head -3'</span></span><br></pre></td></tr></table></figure>
<p><strong>[统计]KeyCache命中率:</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">'/usr/install/cassandra/bin/nodetool info | tail -2 | head -1'</span></span><br></pre></td></tr></table></figure>
<p><strong>[应用]CQL查询示例:</strong>  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> velocity <span class="keyword">where</span> <span class="keyword">attribute</span>=<span class="string">'111111'</span> <span class="keyword">and</span> partner_code=<span class="string">'koudai'</span> <span class="keyword">and</span> app_name=<span class="string">'weidian_cross'</span> <span class="keyword">and</span> <span class="keyword">type</span>=<span class="string">'accountLogin'</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> partner_code <span class="keyword">desc</span>, app_name <span class="keyword">desc</span>, <span class="keyword">type</span> <span class="keyword">desc</span>, <span class="keyword">timestamp</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1000</span>;</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">"desc table forseti_fp.android_device_session_temp;"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span></span><br></pre></td></tr></table></figure>
<p><strong>清空表数据:</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/cassandra/bin/cqlsh -e <span class="string">"truncate forseti_fp.android_device_session_temp;"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line">/usr/install/cassandra/bin/nodetool clearsnapshot -h  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> forseti_fp</span><br><span class="line">/usr/install/cassandra/bin/nodetool clearsnapshot -h  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> forseti_fp</span><br></pre></td></tr></table></figure>
<h3 id="机器预估">机器预估</h3><p>1.每天的调用量有5000万, 预估需要多少容量  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cassandra配置: SSD, <span class="number">8</span>CPU, <span class="number">32</span>G内存, <span class="number">3.5</span>T</span><br><span class="line">一个节点, <span class="number">2.5</span>亿keys, ttl=<span class="number">3</span>M, 占用<span class="number">500</span>G.  </span><br><span class="line">ttl=<span class="number">1</span>Y, 需要<span class="number">2</span>T. <span class="number">182</span>亿条keys, 需要<span class="number">145.6</span>T</span><br><span class="line">一条activity会有大概十几条velocity. <span class="number">182</span>亿的activity,对应velocity需要<span class="number">1456</span>T. </span><br><span class="line"></span><br><span class="line"><span class="number">10</span>Nodes, <span class="number">3</span>M <span class="number">25</span>亿velocity <span class="number">2.5</span>亿activity <span class="number">500</span>G*<span class="number">10</span>=<span class="number">5</span>T </span><br><span class="line">         <span class="number">6</span>M                            <span class="number">5</span>T*<span class="number">2</span>=<span class="number">10</span>T</span><br><span class="line">         <span class="number">182</span>亿activity, <span class="number">10</span>*(<span class="number">182</span>/<span class="number">2.5</span>)=<span class="number">3600</span>T=<span class="number">728</span>T</span><br></pre></td></tr></table></figure>
<p>2.velocity新的三张表保存半年数据的容量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>Nodes - <span class="number">1</span>Week - <span class="number">1</span>T</span><br><span class="line"><span class="number">4</span>Nodes - <span class="number">1</span>Month - <span class="number">4</span>T</span><br><span class="line"><span class="number">4</span>Nodes - <span class="number">6</span>Month - <span class="number">24</span>T</span><br><span class="line"><span class="number">8</span>Nodes - <span class="number">6</span>Month - <span class="number">12</span>T</span><br></pre></td></tr></table></figure>
<h3 id="安装">安装</h3><p>1.统一使用admin用户安装启动软件, 方便管理和其他用户的使用:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown admin:admin -R /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.15</span></span><br></pre></td></tr></table></figure>
<p>2.建立软链接,方便升级. 如果有升级, 只要替换软链接, 启动命令不需要改变:  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin ln -s <span class="regexp">/usr/i</span>nstall<span class="regexp">/apache-cassandra-2.0.15 /u</span>sr<span class="regexp">/install/</span>cassandra</span><br></pre></td></tr></table></figure>
<p>3.关闭swap</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -<span class="tag">a</span></span><br><span class="line">sudo vi /etc/fstab</span><br><span class="line"></span><br><span class="line">sed -<span class="tag">i</span> <span class="string">'s/^\(.*swap\)/#\1/'</span> /etc/fstab</span><br><span class="line">echo <span class="string">"vm.swappiness = 1"</span> &gt; /etc/sysctl.d/swappiness<span class="class">.conf</span></span><br><span class="line">sysctl -<span class="tag">p</span> /etc/sysctl.d/swappiness.conf</span><br></pre></td></tr></table></figure>
<h3 id="升级">升级</h3><p><a href="http://zhaoyanblog.com/archives/815.html" target="_blank" rel="external">http://zhaoyanblog.com/archives/815.html</a>  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">第一步：更改配置文件</span><br><span class="line">把Cassandra <span class="number">2</span>.<span class="number">0</span>的配置通过比对, 把你原来cassandra.yaml配置文件里的参数移植到新版本的cassandra.yaml配置文件中。</span><br><span class="line">因为cassandra2.<span class="number">1</span>增加了一些配置，也减少了一些配置。所以你不能直接复制过来。你只要把新版的配置文件中有的配置项，从老的配置文件中挪过来就可以了。</span><br><span class="line"></span><br><span class="line">第二步：创建快照，防止升级失败</span><br><span class="line"><span class="label">nodetool</span> snapshot keyspace -t snapshot_20150828 创建快照。</span><br><span class="line">如果你使用了JNA，快照是通过硬链接实现的，并不会增加磁盘空间，创建快照时间很短。</span><br><span class="line"></span><br><span class="line">第三步：停节点</span><br><span class="line">先执行<span class="keyword">bin/nodetool </span>drain 关闭写入，同时把数据写入文件。</span><br><span class="line">执行<span class="keyword">bin/nodetool </span>stodaemon停掉本节点。</span><br><span class="line"></span><br><span class="line">第四步: 启动新节点</span><br><span class="line"><span class="keyword">bin/cassandra。</span><br><span class="line"></span></span><br><span class="line">第五步：重复一到四步把集群所有机器都升级为新版本。</span><br><span class="line"></span><br><span class="line">第六步：在所有节点执行升级sstable文件操作</span><br><span class="line">后台执行</span><br><span class="line"><span class="label">nohup</span> <span class="keyword">bin/nodetool </span>upgradesstables &amp;</span><br><span class="line">目前看，这个操作不会产生太大的负载</span><br><span class="line">等所有节点操作完毕，至此升级完毕。</span><br></pre></td></tr></table></figure>
<h3 id="文件">文件</h3><p>1.递归查看磁盘的容量或者Cassandra每个keyspace/table占用的大小(第三个按照大小排序取前10个):  </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ll</span> /home/admin/cassandra/data/forseti_fp/android_device_session -rSh|<span class="keyword">grep</span> Data|tail</span><br><span class="line"></span><br><span class="line">du --<span class="built_in">max</span>-depth=<span class="number">1</span> /home/admin/cassandra/data/forseti -<span class="keyword">h</span></span><br><span class="line">du /home/admin/cassandra/data/forseti/* -<span class="keyword">sh</span> *</span><br><span class="line"><span class="keyword">cd</span> /home/admin/cassandra/data/forseti &amp;&amp; <span class="keyword">for</span> <span class="keyword">i</span> in $(<span class="keyword">ls</span> -<span class="keyword">l</span> |<span class="keyword">grep</span> <span class="string">'^d'</span> |du -<span class="keyword">s</span> * |<span class="built_in">sort</span> -nr|awk <span class="string">'&#123;print $2&#125;'</span>);<span class="keyword">do</span> du -<span class="keyword">sh</span> $<span class="keyword">i</span>;done | head -<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cd</span> /home/admin/cassandra/data/forseti_fp &amp;&amp; <span class="keyword">for</span> <span class="keyword">i</span> in $(<span class="keyword">ls</span> -<span class="keyword">l</span> |<span class="keyword">grep</span> <span class="string">'^d'</span> |du -<span class="keyword">s</span> * |<span class="built_in">sort</span> -nr|awk <span class="string">'&#123;print $2&#125;'</span>);<span class="keyword">do</span> du -<span class="keyword">sh</span> $<span class="keyword">i</span>;done</span><br></pre></td></tr></table></figure>
<p>2.找出修改时间在三个月前的文件(第二个命令会删除这些文件):  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti/</span>activity_detail -type f -mtime +<span class="number">90</span> -exec ls -lrth &#123;&#125; \; | <span class="keyword">grep</span> Data</span><br><span class="line"><span class="keyword">find</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti/</span>activity_detail -type f -mtime +<span class="number">90</span> -exec rm &#123;&#125; \;</span><br><span class="line"><span class="keyword">find</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session -type f -mtime +<span class="number">30</span> -exec rm &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<p>3.查看是否有快照文件, 如果没有文件夹会报错<code>No such file or directory</code>:  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti/</span>velocity<span class="regexp">/snapshots</span></span><br></pre></td></tr></table></figure>
<p>4.查看所有节点/home目录(数据目录)的磁盘剩余空间:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pssh -A -h ip<span class="class">.txt</span> -<span class="tag">i</span> <span class="string">'df -h | grep /home'</span></span><br><span class="line">./pssh<span class="class">.sh</span> <span class="string">"df -h | grep /home"</span></span><br></pre></td></tr></table></figure>
<p>5.重建数据目录:  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin rm -rf <span class="regexp">/home/</span>admin<span class="regexp">/cassandra &amp;&amp; sudo mkdir /</span>home<span class="regexp">/admin/</span>cassandra &amp;&amp; sudo chown <span class="string">admin:</span>admin -R <span class="regexp">/home/</span>admin<span class="regexp">/cassandra &amp;&amp; ll /</span>home<span class="regexp">/admin/</span>cassandra</span><br></pre></td></tr></table></figure>
<p>6.统计每天的Data文件数量:  </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ll /home/admin/cassandra/data/forseti/velocity_app -rth | grep Data | \</span><br><span class="line">awk <span class="string">'&#123;count[$6$7]++;&#125;END&#123;for (i in count) &#123;print i"\t"count[i]&#125;&#125;'</span> | sort -k <span class="number">2</span> -t \t</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> /home/admin/cassandra/data/forseti/velocity_app/*; do <span class="keyword">if</span> [ `date -r <span class="variable">$filename</span> +<span class="decorator">%m</span>` == <span class="string">"12"</span> ];<span class="keyword">then</span> sudo mv <span class="variable">$filename</span> ~/<span class="number">12_</span>m; fi done</span><br></pre></td></tr></table></figure>
<h3 id="进程">进程</h3><p>1.启动Cassandra进程: <code>sudo -u admin /usr/install/cassandra/bin/cassandra</code><br>2.查看Cassandra进程: <code>sudo -u admin jps -lm</code> 或 <code>ps -ef | grep cassandra</code>  </p>
<p>3.杀死Cassandra进程: 下面的命令不需要先用ps查看pid,再kill -9 pid, 直接使用一条命令就可以搞定.  </p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u <span class="literal">admin</span> kill -<span class="number">9</span> `sudo -u <span class="literal">admin</span> jps | grep CassandraDaemon |awk '&#123;<span class="literal">print</span> <span class="variable">$1</span>&#125;'`</span><br><span class="line">sudo -u <span class="literal">admin</span> jps | grep CassandraDaemon |awk '&#123;<span class="literal">print</span> <span class="variable">$1</span>&#125;' | xargs sudo -u <span class="literal">admin</span> kill -<span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>4.找出Cassandra进程内最耗费CPU的线程(假设Cassandra的进程PID=20893):<br>A.查看进程相关的所有线程: 使用ps -Lfp pid或者ps -mp pid -o THREAD, tid, time或者top -Hp pid  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ top -Hp <span class="number">20893</span></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line"><span class="number">44755</span> admin     <span class="number">24</span>   <span class="number">4</span>  <span class="number">158</span>g  <span class="number">31</span>g  <span class="number">11</span>g R <span class="number">85.4</span> <span class="number">50.2</span> <span class="number">639</span>:<span class="number">34.07</span> java</span><br><span class="line"><span class="number">44728</span> admin     <span class="number">24</span>   <span class="number">4</span>  <span class="number">158</span>g  <span class="number">31</span>g  <span class="number">11</span>g R <span class="number">84.1</span> <span class="number">50.2</span> <span class="number">608</span>:<span class="number">12.93</span> java</span><br><span class="line"><span class="number">44730</span> admin     <span class="number">24</span>   <span class="number">4</span>  <span class="number">158</span>g  <span class="number">31</span>g  <span class="number">11</span>g R <span class="number">83.1</span> <span class="number">50.2</span> <span class="number">691</span>:<span class="number">32.11</span> java</span><br><span class="line"><span class="number">44958</span> admin     <span class="number">20</span>   <span class="number">0</span>  <span class="number">158</span>g  <span class="number">31</span>g  <span class="number">11</span>g R <span class="number">82.1</span> <span class="number">50.2</span>   <span class="number">1028</span>:<span class="number">58</span> java</span><br></pre></td></tr></table></figure>
<p>B.TIME列就是各个Java线程耗费的CPU时间, 计算进程ID对应的16进制   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ <span class="built_in">printf</span> <span class="string">"%x\n"</span> <span class="number">44958</span></span><br><span class="line">af9e</span><br></pre></td></tr></table></figure>
<p>C.输出Cassandra进程的堆栈信息，然后根据线程ID的十六进制值grep, 下面表示Cassandra进程耗费的CPU主要在于传输数据.    </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ sudo -u admin jstack <span class="number">20893</span> | grep af9e</span><br><span class="line"><span class="string">"STREAM-IN-/192.168.47.225"</span> daemon prio=<span class="number">10</span> tid=<span class="number">0x00007ff1229ec000</span> nid=<span class="number">0xaf9e</span> runnable [<span class="number">0x00007ff12c7e9000</span>]</span><br></pre></td></tr></table></figure>
<p>5.启动Cassandra进程如果报错找不到java:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">5</span>] <span class="number">15</span>:<span class="number">35</span>:<span class="number">54</span> [FAILURE] <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span> Exited with error code <span class="number">1</span></span><br><span class="line">Cassandra <span class="number">2.0</span> and later require Java <span class="number">7</span> or later.</span><br><span class="line">Stderr: which: <span class="function">no java <span class="title">in</span> <span class="params">(/usr/local/bin:/bin:/usr/bin)</span></span></span><br></pre></td></tr></table></figure>
<p>解决方式: </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives  --install  <span class="regexp">/usr/</span>bin<span class="regexp">/java java /u</span>sr<span class="regexp">/java/</span>jdk1.<span class="number">7.0</span>_51<span class="regexp">/bin/</span>java <span class="number">1888</span></span><br><span class="line">sudo update-alternatives  --install  <span class="regexp">/usr/</span>bin<span class="regexp">/javac javac /u</span>sr<span class="regexp">/java/</span>jdk1.<span class="number">7.0</span>_51<span class="regexp">/bin/</span>javac <span class="number">1888</span></span><br><span class="line">sudo update-alternatives --config java</span><br><span class="line">sudo update-alternatives --config javac</span><br></pre></td></tr></table></figure>
<p>6.查看GC信息(第二条格式化输出美观的格式):  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -<span class="keyword">u</span> admin jstat -gc `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` 1000</span><br><span class="line"></span><br><span class="line">sudo -<span class="keyword">u</span> admin jstat -gc -<span class="keyword">h</span> 20 `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'` 1000 | \</span><br><span class="line">awk '&#123;printf(<span class="string">"%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t\n"</span>,<span class="label">$1</span>,<span class="label">$5</span>,<span class="label">$3</span>,<span class="label">$4</span>,<span class="label">$6</span>,<span class="label">$8</span>,<span class="label">$11</span>,<span class="label">$12</span>,<span class="label">$13</span>,<span class="label">$14</span>)&#125;'</span><br></pre></td></tr></table></figure>
<h3 id="CQL查询客户端">CQL查询客户端</h3><p>1.不进入客户端,直接在终端执行脚本: 第二个命令查看forseti的ks, 会打印很多信息, 如果只是看ks的拓扑信息,使用head.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspaces'</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span></span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspace forseti'</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> | <span class="keyword">head</span></span></span><br></pre></td></tr></table></figure>
<p>2.创建keyspace,并指定副本数:   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> KEYSPACE forseti <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'SimpleStrategy'</span>, <span class="string">'replication_factor'</span> : <span class="number">3</span> &#125;;</span></span><br></pre></td></tr></table></figure>
<p>3.导出csv文件(数据文件太大,COPY TO实际也需要查询):  </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cqlsh 192.168.6.52 -e "<span class="built_ins">copy</span> forseti.historical_prices (ticker,date,adj_close,close,high,low,open,<span class="built_ins">volume</span>) to 'historical.csv';"</span><br><span class="line"></span><br><span class="line"><span class="built_in">copy</span> <span class="bash">forseti.velocity (attribute,partner_code,app_name,<span class="built_in">type</span>,<span class="string">"timestamp"</span>,event,sequence_id) to <span class="string">'217.csv'</span>;</span><br><span class="line"></span>Request did not complete within rpc_timeout.</span><br><span class="line"></span><br><span class="line">/usr/install/cassandra/bin/cqlsh 192.168.47.242 -e "<span class="built_ins">copy</span> forseti.velocity (attribute,partner_code,app_name,type,timestamp,event,sequence_id) to 'test1.csv';"</span><br><span class="line">/usr/install/cassandra/bin/cqlsh 192.168.47.242 -e "<span class="built_ins">copy</span> forseti.velocity to 'test1.csv';"</span><br></pre></td></tr></table></figure>
<p>4.跳板机直接访问线上数据库</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">在跳板机上生成建表语句: </span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cqlsh -e <span class="string">'desc keyspace forseti_fp'</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> &gt; forseti_fp.cql</span><br><span class="line"></span><br><span class="line">创建<span class="string">keyspace:</span></span><br><span class="line">CREATE KEYSPACE forseti_fp WITH REPLICATION = &#123; <span class="string">'class'</span> : <span class="string">'SimpleStrategy'</span>, <span class="string">'replication_factor'</span> : <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">修改副本数: </span><br><span class="line">ALTER KEYSPACE forseti_fp WITH REPLICATION = &#123; <span class="string">'class'</span> : <span class="string">'SimpleStrategy'</span>, <span class="string">'replication_factor'</span> : <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">在跳板机上执行建表语句:</span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cqlsh <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -f forseti_fp.cql</span><br><span class="line"></span><br><span class="line">在跳板机上查询:</span><br><span class="line">[qihuang.zheng<span class="annotation">@fd</span>047022 ~]$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cqlsh <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line">cqlsh&gt; desc KEYSPACES ;</span><br><span class="line">system  forseti_fp  system_traces</span><br><span class="line"></span><br><span class="line">cqlsh&gt; use forseti_fp ;</span><br><span class="line"><span class="string">cqlsh:</span>forseti_fp&gt; desc TABLES ;</span><br><span class="line">analysis                device              ios_device_info     tcp_stack_ua</span><br></pre></td></tr></table></figure>
<h3 id="集群维护">集群维护</h3><p><strong>1.扩容: 添加新节点到原集群forseti_cluster:</strong>  </p>
<p>0.原先的集群中关于本机的配置(202): </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@cass</span>047202 conf]$ find <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>conf -name <span class="string">"*"</span> | xargs grep <span class="number">192.168</span><span class="number">.47</span></span><br><span class="line">./cassandra.<span class="string">yaml:</span><span class="string">rpc_address:</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span></span><br><span class="line">./cassandra.<span class="string">yaml:</span><span class="string">listen_address:</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span></span><br><span class="line">./cassandra.<span class="string">yaml:</span>  - &#123;<span class="string">seeds:</span> <span class="string">'192.168.47.203,192.168.47.204,192.168.47.202'</span>&#125;</span><br><span class="line">./cassandra-env.<span class="string">sh:</span>JVM_OPTS=<span class="string">"$JVM_OPTS -Djava.rmi.server.hostname=192.168.47.202"</span></span><br></pre></td></tr></table></figure>
<p>A.在202上拷贝Cassandra安装目录和安装脚本到目标节点:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.15</span> qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.215</span>:~/  </span><br><span class="line">scp install_cassandra.sh qihuang.zheng@<span class="number">192.168</span><span class="number">.47</span><span class="number">.215</span>:~/</span><br></pre></td></tr></table></figure>
<p>B.在目标节点执行安装脚本<code>sudo sh install_cassandra.sh</code>:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">host=`ifconfig | grep <span class="string">"192.168.47"</span> | awk <span class="string">'/inet addr/&#123;sub("addr:",""); print $2&#125;'</span>`</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/rpc_address: 192.168.47.202/rpc_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/listen_address: 192.168.47.202/listen_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/192.168.47.202/<span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra-env.sh</span><br><span class="line"><span class="comment">##修改种子节点和集群名称</span></span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/192.168.47.203,192.168.47.204,192.168.47.202/192.168.47.226,192.168.48.47/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/cluster_name: forseti_cluster/cluster_name: forseti_velocity/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line"><span class="comment">##如果是全新的集群,则不需要加入:  </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"auto_bootstrap:false"</span> &gt;&gt; apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">##数据目录使用不同磁盘</span></span><br><span class="line"><span class="comment">#sed -i -e 's#commitlog_directory: /home/admin/cassandra/commitlog#commitlog_directory: /data/cassandra/commitlog#g' apache-cassandra-2.0.15/conf/cassandra.yaml</span></span><br><span class="line"></span><br><span class="line">sudo mv ~/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install</span><br><span class="line">sudo chown admin:admin -R /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span></span><br><span class="line">sudo -u admin ln <span class="operator">-s</span> /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install/cassandra</span><br><span class="line">sudo mkdir /home/admin/cassandra</span><br><span class="line">sudo chown admin:admin -R /home/admin/cassandra</span><br><span class="line">sudo mkdir /var/<span class="built_in">log</span>/cassandra</span><br><span class="line">sudo chown admin:admin -R /var/<span class="built_in">log</span>/cassandra</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: 一般加入新节点后, 需要对新节点repair, 老节点cleanup. 但是线上测试时发现这两个操作都很耗时.  </p>
</blockquote>
<p>统一使用admin用户的安装脚本. 首先要从sftp服务器上下载cassandra.tar.gz </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">host=`ifconfig | grep <span class="string">"192.168"</span> | awk <span class="string">'/inet addr/&#123;sub("addr:",""); print $2&#125;'</span>`</span><br><span class="line"></span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/rpc_address: 192.168.48.47/rpc_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/listen_address: 192.168.48.47/listen_address: <span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/192.168.48.47/<span class="variable">$host</span>/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra-env.sh</span><br><span class="line"></span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/seeds: '192.168.48.47'/seeds: '192.168.49.56'/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s/cluster_name: forseti_realtime/cluster_name: forseti_galaxy/g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/cassandra.yaml</span><br><span class="line">sed -i <span class="operator">-e</span> <span class="string">"s#/var/log/cassandra/system.log#/home/admin/log/cassandra/system.log#g"</span> apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span>/conf/<span class="built_in">log</span>4j-server.properties</span><br><span class="line"></span><br><span class="line">mv ~/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install</span><br><span class="line">ln <span class="operator">-s</span> /usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">15</span> /usr/install/cassandra</span><br><span class="line"></span><br><span class="line">mkdir /home/admin/cassandra</span><br><span class="line">mkdir -p /home/admin/<span class="built_in">log</span>/cassandra</span><br></pre></td></tr></table></figure>
<p><strong>2.删除/下线节点:</strong>  </p>
<p>A.正在运行的节点: <code>nodetool decommission</code><br>B.挂掉的节点:   </p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nodetool removenode host-<span class="property">id</span></span><br><span class="line">nodetool removenode status</span><br><span class="line">nodetool removenode force</span><br></pre></td></tr></table></figure>
<p><strong>3.授权访问</strong></p>
<p><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/security/security_config_native_authenticate_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/security/security_config_native_authenticate_t.html</a></p>
<p>A.将cassandra.yaml的authenticator从AllowAllAuthenticator修改成密码方式  </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">authenticator</span>: <span class="string">PasswordAuthenticator</span></span><br></pre></td></tr></table></figure>
<p>B.增大system_auth keyspace的副本数等于集群中每个数据中心的节点数量  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE <span class="string">"Excalibur"</span> <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123; <span class="string">'class'</span> : <span class="string">'SimpleStrategy'</span>, <span class="string">'replication_factor'</span> : <span class="number">3</span> &#125;;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> KEYSPACE system_auth <span class="keyword">WITH</span> <span class="keyword">REPLICATION</span> = &#123;<span class="string">'class'</span> : <span class="string">'NetworkTopologyStrategy'</span>, <span class="string">'dc1'</span> : <span class="number">3</span>, <span class="string">'dc2'</span> : <span class="number">2</span>&#125;;</span></span><br></pre></td></tr></table></figure>
<p>在每个节点依次执行<code>nodetool repair</code>, 这样会将副本数据拷贝到其他节点. 不至于一个节点当掉, 导致无法访问C.  </p>
<p>….TODO</p>
<h3 id="OpsCenter:">OpsCenter:</h3><h4 id="安装opscenter">安装opscenter</h4><p>opscenter只需要安装server端即可, 启动方式: <code>sudo -u admin /usr/install/opscenter-5.2.2/bin/opscenter</code><br>启动后会在opscenter下生成一个twistd.pid代表server的进程id.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047222 opscenter-<span class="number">5.2</span><span class="number">.0</span>]$ ps -ef | grep opscenter</span><br><span class="line">admin     <span class="number">6344</span>     <span class="number">1</span> <span class="number">39</span> <span class="number">11</span>:<span class="number">22</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> /usr/bin/python2<span class="number">.6</span> ./bin/twistd -r epoll -oy bin/start_opscenter.py</span><br></pre></td></tr></table></figure>
<p>杀掉opscenter进程的方式:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kill -<span class="number">9</span> `sudo -u admin cat /usr/install/opscenter-<span class="number">5.2</span><span class="number">.2</span>/twistd.pid`</span><br></pre></td></tr></table></figure>
<h4 id="创建集群和安装agent">创建集群和安装agent</h4><p>访问localhost:8888端口, 初始时没有任何集群, 选择管理已经存在的Cassandra集群. 填写上Cassandra集群的部分地址即可.<br>会提示: 没有安装Agent: <code>OpsCenter is having trouble connecting with the agents. Click here for more details Fix Now</code><br>点击<code>Fix Now</code>, 输入自己能访问这台机器的用户名密码, 完成每个Agent节点的安装.<br>正常在页面上安装完Agent后, 监控图是没有问题的. 但是经过一段时间有时候会没有数据. 需要修改每个agent的配置.  </p>
<h4 id="修改agent配置">修改agent配置</h4><p>agent安装完后, 需要更改各个agent节点的配置信息: 更改local_interface的地址. stomp_interface是opscenter的地址.<br><code>sudo vi /var/lib/datastax-agent/conf/address.yaml</code>:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stomp_interface: <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">use_ssl: <span class="number">0</span></span><br><span class="line">async_pool_size: <span class="number">200</span></span><br><span class="line">thrift_max_cons: <span class="number">200</span></span><br><span class="line">async_queue_size: <span class="number">20000</span></span><br><span class="line">hosts : [<span class="string">"192.168.47.202"</span>,<span class="string">"192.168.47.203"</span>....]</span><br><span class="line">local_interface: <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line">cassandra_conf: /usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.15</span>/conf/cassandra.yaml</span><br></pre></td></tr></table></figure>
<p>修改完配置, 需要把agent进程杀掉  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo kill -9 `ps -ef|grep datastax_agent_monitor | head -1 |awk '&#123;<span class="keyword">print</span> <span class="label">$2&#125;</span>'` &amp;&amp; \</span><br><span class="line">sudo kill -9 `<span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">run</span>/datastax-agent/datastax-agent.pid`</span><br></pre></td></tr></table></figure>
<p>注意并不需要重启Agent(因为agent节点并没有启动的命令). 启动Agent的方式只能通过web页面的提示点击<code>Fix now</code>重新修复.    </p>
<p>彻底删除agent(当opscenter修改配置完并重装还是没有起作用时):  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo kill -<span class="number">9</span> <span class="string">`ps -ef|grep datastax_agent_monitor | head -1 |awk '&#123;print $2&#125;'`</span> &amp;&amp;</span><br><span class="line">sudo kill -<span class="number">9</span> <span class="string">`cat /var/run/datastax-agent/datastax-agent.pid`</span> &amp;&amp;</span><br><span class="line">sudo rm -rf /var/<span class="class"><span class="keyword">lib</span>/<span class="title">datastax</span>-<span class="title">agent</span> &amp;&amp;</span></span><br><span class="line">sudo rm -rf /usr/share/datastax-agent</span><br></pre></td></tr></table></figure>
<h4 id="堡垒机无法查看opscenter">堡垒机无法查看opscenter</h4><p><a href="https://docs.datastax.com/en/opscenter/5.1/opsc/troubleshooting/opscTroubleshootingZeroNodes.html" target="_blank" rel="external">https://docs.datastax.com/en/opscenter/5.1/opsc/troubleshooting/opscTroubleshootingZeroNodes.html</a></p>
<h4 id="手动安装agent">手动安装agent</h4><p><a href="http://docs.datastax.com/en//opscenter/5.0/opsc/install/opsc-agentInstallManual_t.html" target="_blank" rel="external">http://docs.datastax.com/en//opscenter/5.0/opsc/install/opsc-agentInstallManual_t.html</a></p>
<h2 id="nodetool工具集">nodetool工具集</h2><h3 id="nodetool维护工具">nodetool维护工具</h3><p>1.查看数据库所有的表(适合脚本方式获取并批量处理):  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool cfstats forseti_fp | grep <span class="string">"Table: "</span> | sed -<span class="keyword">e</span> <span class="string">'s+^.*: ++'</span></span></span><br></pre></td></tr></table></figure>
<p>2.查看CF的历史信息:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/cassandra/bin/nodetool cfhistograms forseti velocity -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span></span><br></pre></td></tr></table></figure>
<p>3.清理keyspace的快照:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pssh -A -h ip<span class="class">.txt</span> -<span class="tag">i</span> <span class="string">'/usr/install/apache-cassandra-2.0.15/bin/nodetool clearsnapshot forseti_fp'</span></span><br><span class="line">pssh -A -H <span class="number">192.168</span>.<span class="number">47.203</span> -<span class="tag">i</span> <span class="string">'/usr/install/apache-cassandra-2.0.15/bin/nodetool clearsnapshot forseti_fp'</span></span><br></pre></td></tr></table></figure>
<p>5.修复集群的每个节点: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup nodetool <span class="operator"><span class="keyword">repair</span> -par -pr <span class="comment">-- forseti &amp;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="快照:_snapshot">快照: snapshot</h3><p>A.清理snapshot快照文件:  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> ~]<span class="variable">$ </span>/usr/install/apache-cassandra-<span class="number">2.0</span>.<span class="number">16</span>/bin/nodetool clearsnapshot  opstest</span><br><span class="line"><span class="constant">Requested</span> clearing snapshot <span class="symbol">for:</span> opstest</span><br><span class="line">[qihuang.zheng<span class="variable">@dp0653</span> ~]<span class="variable">$ </span>ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cassandra</span>/<span class="title">data</span>/<span class="title">opstest</span>/<span class="title">user</span>/</span></span><br><span class="line">总用量 <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>B.删除集群所有节点forseti keyspace的快照(pssh.sh在202上)  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pssh -A -h ip<span class="class">.txt</span> -<span class="tag">i</span> <span class="string">'/usr/install/apache-cassandra-2.0.15/bin/nodetool clearsnapshot forseti'</span></span><br><span class="line">./pssh<span class="class">.sh</span> <span class="string">'/usr/install/apache-cassandra-2.0.15/bin/nodetool clearsnapshot forseti'</span></span><br></pre></td></tr></table></figure>
<p><strong>问题</strong>  </p>
<p>1.sstableloader的文件夹必须是keyspace/table格式,否则空指针异常:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ /usr/install/cassandra/bin/sstableloader -d localhost <span class="number">1445938244634</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>.&lt;init&gt;(SSTableLoader<span class="class">.java</span>:<span class="number">59</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">$ cd /home/admin/data/cassandra/data/forseti/velocity/snapshots</span><br><span class="line">$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> <span class="number">1445938244634</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>.&lt;init&gt;(SSTableLoader<span class="class">.java</span>:<span class="number">59</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>2.做快照后会在表目录生成snapshots文件夹, 不能直接在表目录上使用sstableloader:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity/snapshots/<span class="number">1445938244634</span></span><br><span class="line">Could not retrieve endpoint ranges:</span><br><span class="line"><span class="function"><span class="title">InvalidRequestException</span><span class="params">(why:No such keyspace: snapshots)</span></span></span><br><span class="line">Run with --debug to get full stack trace or --help to get help.</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@mysql006070 ~]$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity</span><br><span class="line">Established connection to <span class="attribute">initial</span> hosts</span><br><span class="line">Opening sstables and calculating sections to stream</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> FSWriteError <span class="keyword">in</span> /home/admin/data/cassandra/data/forseti/velocity/forseti-velocity-jb-<span class="number">414</span>-Summary<span class="class">.db</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.FileUtils</span><span class="class">.deleteWithConfirm</span>(FileUtils<span class="class">.java</span>:<span class="number">122</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableReader</span><span class="class">.loadSummary</span>(SSTableReader<span class="class">.java</span>:<span class="number">546</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableReader</span><span class="class">.openForBatch</span>(SSTableReader<span class="class">.java</span>:<span class="number">173</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>$<span class="number">1</span>.<span class="function"><span class="title">accept</span><span class="params">(SSTableLoader.java:<span class="number">107</span>)</span></span></span><br><span class="line">  at java<span class="class">.io</span><span class="class">.File</span><span class="class">.list</span>(File<span class="class">.java</span>:<span class="number">1155</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.openSSTables</span>(SSTableLoader<span class="class">.java</span>:<span class="number">68</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">150</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br><span class="line">Caused by: java<span class="class">.nio</span><span class="class">.file</span><span class="class">.AccessDeniedException</span>: /home/admin/data/cassandra/data/forseti/velocity/forseti-velocity-jb-<span class="number">414</span>-Summary<span class="class">.db</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.FileUtils</span><span class="class">.deleteWithConfirm</span>(FileUtils<span class="class">.java</span>:<span class="number">118</span>)</span><br><span class="line">  ... <span class="number">7</span> more</span><br><span class="line">[qihuang.zheng@mysql006070 ~]$ sudo -u admin /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity</span><br><span class="line">Caused by: java<span class="class">.net</span><span class="class">.UnknownHostException</span>: mysql006070: 未知的名称或服务</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.Inet6AddressImpl</span><span class="class">.lookupAllHostAddr</span>(Native Method)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span>$<span class="number">1</span>.<span class="function"><span class="title">lookupAllHostAddr</span><span class="params">(InetAddress.java:<span class="number">901</span>)</span></span></span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span><span class="class">.getAddressesFromNameService</span>(InetAddress<span class="class">.java</span>:<span class="number">1293</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span><span class="class">.getLocalHost</span>(InetAddress<span class="class">.java</span>:<span class="number">1469</span>)</span><br><span class="line">  ... <span class="number">11</span> more</span><br></pre></td></tr></table></figure>
<p>3.使用sstableloader时, 在表目录下不能存在snapshots目录.  <a href="http://tonywutao.github.io/2013/10/17/SSS-Table-Loader-in-Cassandra/" target="_blank" rel="external">http://tonywutao.github.io/2013/10/17/SSS-Table-Loader-in-Cassandra/</a><br>但是做快照时, snapshots目录又是生成在表目录下, 所以不能直接用sstableloader, 解决办法是将快照文件夹拷贝到别的地方,并按照keyspace/table格式.<br>如果运行sstableloader的机器的内存不足, 会报OOM, 可以加大内存, 但是如果机器本身内存不足, 最好的办法只能是scp到一台比较大内存的机器.  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.TreeMap</span><span class="class">.put</span>(TreeMap<span class="class">.java</span>:<span class="number">569</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.TreeSet</span><span class="class">.add</span>(TreeSet<span class="class">.java</span>:<span class="number">255</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.compress</span><span class="class">.CompressionMetadata</span><span class="class">.getChunksForSections</span>(CompressionMetadata<span class="class">.java</span>:<span class="number">226</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.messages</span><span class="class">.OutgoingFileMessage</span>.&lt;init&gt;(OutgoingFileMessage<span class="class">.java</span>:<span class="number">76</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamTransferTask</span><span class="class">.addTransferFile</span>(StreamTransferTask<span class="class">.java</span>:<span class="number">56</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.addTransferFiles</span>(StreamSession<span class="class">.java</span>:<span class="number">340</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamPlan</span><span class="class">.transferFiles</span>(StreamPlan<span class="class">.java</span>:<span class="number">138</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br><span class="line">ERROR <span class="number">13</span>:<span class="number">32</span>:<span class="number">10</span>,<span class="number">104</span> Error <span class="keyword">in</span> ThreadPoolExecutor</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="class">.readAndCompute</span>(BackgroundActivityMonitor<span class="class">.java</span>:<span class="number">84</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="class">.getIOWait</span>(BackgroundActivityMonitor<span class="class">.java</span>:<span class="number">125</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="variable">$BackgroundActivityReporter</span>.<span class="function"><span class="title">run</span><span class="params">(BackgroundActivityMonitor.java:<span class="number">153</span>)</span></span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.concurrent</span><span class="class">.DebuggableScheduledThreadPoolExecutor</span><span class="variable">$UncomplainingRunnable</span>.<span class="function"><span class="title">run</span><span class="params">(DebuggableScheduledThreadPoolExecutor.java:<span class="number">80</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.runAndReset</span>(FutureTask<span class="class">.java</span>:<span class="number">304</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.access$<span class="number">301</span>(ScheduledThreadPoolExecutor<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.<span class="function"><span class="title">run</span><span class="params">(ScheduledThreadPoolExecutor.java:<span class="number">293</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span></span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>)</span><br><span class="line"></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: GC overhead limit exceeded</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.compress</span><span class="class">.CompressionMetadata</span><span class="class">.getChunksForSections</span>(CompressionMetadata<span class="class">.java</span>:<span class="number">226</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.messages</span><span class="class">.OutgoingFileMessage</span>.&lt;init&gt;(OutgoingFileMessage<span class="class">.java</span>:<span class="number">76</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamTransferTask</span><span class="class">.addTransferFile</span>(StreamTransferTask<span class="class">.java</span>:<span class="number">56</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.addTransferFiles</span>(StreamSession<span class="class">.java</span>:<span class="number">340</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamPlan</span><span class="class">.transferFiles</span>(StreamPlan<span class="class">.java</span>:<span class="number">138</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/32715401/cassandra-migrate-keyspace-data-from-multinode-cluster-to-singlenode-cluster" target="_blank" rel="external">http://stackoverflow.com/questions/32715401/cassandra-migrate-keyspace-data-from-multinode-cluster-to-singlenode-cluster</a></p>
<hr>
<h3 id="删除节点:_removenode">删除节点: removenode</h3><p><a href="http://zhaoyanblog.com/archives/533.html" target="_blank" rel="external">http://zhaoyanblog.com/archives/533.html</a></p>
<p><code>A</code>.对正在运行Cassandra进程的节点下线,或者在其他节点-h指定要下线的目标节点. 运行命令的节点会有NodeCmd进程.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool decommission</span><br><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool decommission -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.226</span></span><br></pre></td></tr></table></figure>
<p><code>B</code>.如果节点已经下线,比如进程被杀死, 则在正常的节点上删除节点:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool status 获取宕机节点的host-id</span><br><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool removenode  <span class="number">2591</span>cec9-<span class="number">42f</span>9-<span class="number">4f</span>60-a622-<span class="number">00</span>d463910994</span><br></pre></td></tr></table></figure>
<p><code>C</code>.进程挂住的解决办法:<br>1).线上采用decommission后, 发现执行了很久都没有完成. 后来发现是streamming的一个bug:<br>nodetool removenode hangs: <a href="https://issues.apache.org/jira/browse/CASSANDRA-6542" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-6542</a>,<br><a href="http://stackoverflow.com/questions/25943261/nodetool-removenode-stuck-during-removal" target="_blank" rel="external">http://stackoverflow.com/questions/25943261/nodetool-removenode-stuck-during-removal</a><br>Streams hang in repair: <a href="https://issues.apache.org/jira/browse/CASSANDRA-8472" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-8472</a></p>
<blockquote>
<p>Streaming hanging is a familiar trouble in my cluster (2.0/2.1). In my experience,<br>the node that being restarted recently won’t hang the streaming.<br>So each time when I want to add or remove a node, I will restart all nodes one by one.<br>这种方式在线上是不可行的, 需要重启线上的每个节点. 于是尝试使用force直接中断.  </p>
</blockquote>
<p>2).杀掉226的Cassandra进程, 在202上使用B方式removenode删除226. 不过removenode也存在hang的情况.   </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">918468213369</span><span class="number">8409841</span>). Waiting for replication confirmation from [/<span class="number">192.168.47.206</span>,/<span class="number">192.168.47.222</span>,/<span class="number">192.168.47.221</span>,/<span class="number">192.168.47.204</span>,/<span class="number">192.168.47.205</span>,/<span class="number">192.168.47.202</span>,/<span class="number">192.168.47.224</span>,/<span class="number">192.168.47.225</span>].</span><br></pre></td></tr></table></figure>
<p>3).由于nodetool命令都是调用JMX方法,所以尽管kill掉进程,命令对应的进程实际是还存在的.  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>jps</span><br><span class="line"><span class="number">8596</span> <span class="constant">NodeCmd</span></span><br><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>kill -<span class="number">9</span> <span class="number">8596</span></span><br><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>nodetool removenode status</span><br><span class="line"><span class="constant">RemovalStatus</span>: <span class="constant">Removing</span> token (-<span class="number">9184682133698409841</span>). <span class="constant">Waiting</span> <span class="keyword">for</span> replication confirmation from [<span class="regexp">/192.168.47.206,/</span><span class="number">192.168</span>.<span class="number">47.222</span>,<span class="regexp">/192.168.47.221,/</span><span class="number">192.168</span>.<span class="number">47.204</span>,<span class="regexp">/192.168.47.205,/</span><span class="number">192.168</span>.<span class="number">47.202</span>,<span class="regexp">/192.168.47.224,/</span><span class="number">192.168</span>.<span class="number">47.225</span>].</span><br></pre></td></tr></table></figure>
<p>4).删除操作正在进行,不能重复执行removenode命令,不过提示信息给了我们另一种解决方案.  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">UN  <span class="number">192.168</span>.<span class="number">47.202</span>  <span class="number">612.13</span> GB  <span class="number">256</span>     <span class="number">7.4%</span>   abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7  RAC1</span><br><span class="line">DL  <span class="number">192.168</span>.<span class="number">47.226</span>  <span class="number">406.34</span> GB  <span class="number">256</span>     <span class="number">7.6%</span>   <span class="number">2591</span>cec9-<span class="number">42</span>f9-<span class="number">4</span>f60-a622-<span class="number">00</span>d463910994  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode <span class="number">2591</span>cec9-<span class="number">42</span>f9-<span class="number">4</span>f60-a622-<span class="number">00</span>d463910994</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.UnsupportedOperationException</span>: This node is already processing <span class="tag">a</span> removal. Wait <span class="keyword">for</span> it to complete, or use <span class="string">'removenode force'</span> <span class="keyword">if</span> this has failed.</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.StorageService</span><span class="class">.removeNode</span>(StorageService<span class="class">.java</span>:<span class="number">3342</span>)</span><br><span class="line">  ...</span><br><span class="line">  at com<span class="class">.sun</span><span class="class">.jmx</span><span class="class">.interceptor</span><span class="class">.DefaultMBeanServerInterceptor</span><span class="class">.invoke</span>(DefaultMBeanServerInterceptor<span class="class">.java</span>:<span class="number">819</span>)</span><br><span class="line">  at com<span class="class">.sun</span><span class="class">.jmx</span><span class="class">.mbeanserver</span><span class="class">.JmxMBeanServer</span><span class="class">.invoke</span>(JmxMBeanServer<span class="class">.java</span>:<span class="number">801</span>)</span><br></pre></td></tr></table></figure>
<p>5).如果removenode失败, 则强制删除, 使用<code>nodetool removenode force</code>命令,不需要跟上host-id.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode force 2591cec<span class="number">9-42f9-4</span>f60-a<span class="number">622-00d46</span><span class="number">3910994</span></span><br><span class="line">Missing an argument for removenode (either status, force, or an ID)</span><br><span class="line">usage: java org.apache.cassandra.tools.NodeCmd --host &lt;arg&gt; &lt;command&gt;</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode force</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">918468213369</span><span class="number">8409841</span>). Waiting for replication confirmation from [/<span class="number">192.168.47.206</span>,/<span class="number">192.168.47.222</span>,/<span class="number">192.168.47.221</span>,/<span class="number">192.168.47.204</span>,/<span class="number">192.168.47.205</span>,/<span class="number">192.168.47.202</span>,/<span class="number">192.168.47.224</span>,/<span class="number">192.168.47.225</span>].</span><br></pre></td></tr></table></figure>
<p>6).成功删除后, 下线的226节点不会出现在状态列表中, 并且集群的Owns也发生了变化. gossipinfo可以查看状态为removed.   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: No token removals in process.</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>  <span class="number">612.13</span> GB  <span class="number">256</span>     <span class="number">8.1</span>%   abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047204 ~]$ nodetool gossipinfo</span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.226</span></span><br><span class="line">  STATUS:removed,<span class="number">2591</span>cec9-<span class="number">42f</span>9-<span class="number">4f</span>60-a622-<span class="number">00</span>d463910994,<span class="number">1446339305944</span></span><br><span class="line">  REMOVAL_COORDINATOR:REMOVER,abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7</span><br></pre></td></tr></table></figure>
<p><code>D</code>.Active Streams:  </p>
<p>下图是对225进行decommission,225的数据通过streams转移到其他节点:  </p>
<p><img src="http://img.blog.csdn.net/20151030101713671" alt="streams"></p>
<hr>
<h3 id="替换节点:_replace_address">替换节点: replace_address</h3><p><a href="http://zhaoyanblog.com/archives/591.html" target="_blank" rel="external">http://zhaoyanblog.com/archives/591.html</a><br><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_replace_node_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_replace_node_t.html</a></p>
<blockquote>
<p>CAUTION:<br>1.Wait at least 72 hours to ensure that old node information is removed from gossip.<br>If removed from the property file too soon, problems may result.<br>2.auto_bootstrap不能设置为false:<br>java.lang.RuntimeException: Trying to replace_address with auto_bootstrap disabled will not work, check your configuration</p>
</blockquote>
<p>要被替换的节点状态为DN, 新启动的节点启动时加上-Dcassandra.replace_address选项:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin /usr/install/cassandra/bin/cassandra -Dcassandra.replace_address=<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"></span><br><span class="line"> WARN <span class="number">13</span>:<span class="number">49</span>:<span class="number">37</span>,<span class="number">423</span> Token -<span class="number">3920394820366823756</span> changing ownership from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> to /<span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span></span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">122</span> Node /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> is now part of the cluster</span><br><span class="line"> WARN <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">127</span> Not updating token metadata <span class="keyword">for</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> because I am replacing it</span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">127</span> Nodes /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> and /<span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> have the same token -<span class="number">1001533036333769848.</span>  Ignoring /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> </span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">51</span>:<span class="number">10</span>,<span class="number">272</span> FatClient /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> has been silent <span class="keyword">for</span> <span class="number">30000</span>ms, removing from gossip</span><br></pre></td></tr></table></figure>
<p>查看节点的状态:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048160 ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">460.9</span> GB   <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">6.02</span> MB    <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.4</span> TB     <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">483.48</span> GB  <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">686.97</span> GB  <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">460.78</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.4</span> TB     <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">483.41</span> GB  <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">686.93</span> GB  <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.上面发现一个奇怪的现象就是229和160的HostID都是一样的, 所以日志中会有<code>have the same token ignoring</code><br>2.227并不认识160, 而是认为229状态为DN<br>3.160上能看到其他节点, 但是看不到229.  </p>
</blockquote>
<p>过了有一周, 再次查看发现还是上面的状况, 而且160的日志还是经常打印Ignoring…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048160 ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">972.25</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">250.64</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">972.16</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>索性把160停掉重启(注意要加上auto_bootstrap:false), 现在227上能观察到160了. 但是160上还是看不到229.<br>不过更加奇怪的是229的HostID变成了null(因为出现160就不能同时再出现229了).这样子没办法removenode了.<br>其实也不能removenode了, 因为229和160的HostID之前是一样的!如果根据hostId删除,会把160也都删除掉了.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">973.32</span> GB  <span class="number">256</span>     <span class="number">17.4</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">250.93</span> GB  <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">16.4</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>不能根据hostId来removenode 229, 那怎么删除229节点?  </p>
<p>下面采用JMX的方式也不行: <a href="https://gist.github.com/justenwalker/8338334" target="_blank" rel="external">https://gist.github.com/justenwalker/8338334</a>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ java -jar ./jmxterm<span class="class">.jar</span></span><br><span class="line">Welcome to JMX terminal. Type <span class="string">"help"</span> <span class="keyword">for</span> available commands.</span><br><span class="line">$&gt;open localhost:<span class="number">7199</span></span><br><span class="line"><span class="id">#Connection</span> to localhost:<span class="number">7199</span> is opened</span><br><span class="line">$&gt;bean org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line"><span class="hexcolor">#bea</span>n is set to org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line">$&gt;run unsafeAssassinateEndpoint <span class="number">192.168</span>.<span class="number">47.229</span></span><br><span class="line"><span class="id">#calling</span> operation unsafeAssassinateEndpoint of mbean org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line"><span class="id">#RuntimeMBeanException</span>: java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br></pre></td></tr></table></figure>
<p><a href="https://gist.github.com/nstielau/3373649" target="_blank" rel="external">https://gist.github.com/nstielau/3373649</a>  </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java -jar jmxsh-R*.jar -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -p <span class="number">7199</span></span><br><span class="line"></span><br><span class="line">% [Hit Enter <span class="keyword">to</span> go into Browse Mode]</span><br><span class="line"><span class="keyword">Select</span> a domain: [Enter <span class="built_in">number</span> <span class="keyword">for</span> org.apache.cassandra.net]</span><br><span class="line"><span class="keyword">Select</span> an mbean: [Enter <span class="built_in">number</span> <span class="keyword">for</span> org.apache.cassandra.net:type=Gossiper]</span><br><span class="line"><span class="keyword">Select</span> an attribute <span class="literal">or</span> operation: [Enter <span class="built_in">number</span> <span class="keyword">for</span> unsafeAssassinateEndpoint(<span class="built_in">String</span>  p1)]</span><br><span class="line">p1 (<span class="built_in">String</span>): <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"></span><br><span class="line">It may also be possible <span class="keyword">to</span> <span class="built_in">run</span> it directly (untested):</span><br><span class="line">% jmx_invoke -m org.apache.cassandra.net:type=Gossiper unsafeAssassinateEndpoint &lt;STALE-IP-ADDRESS&gt;</span><br></pre></td></tr></table></figure>
<p>但最后还是报错NPE:  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">%</span><br><span class="line"><span class="header">Entering browse mode.</span><br><span class="line">====================================================</span></span><br><span class="line"><span class="code"> Available Domains:</span></span><br><span class="line"><span class="code">       1. org.apache.cassandra.internal</span></span><br><span class="line"><span class="code">       2. org.apache.cassandra.metrics</span></span><br><span class="line"><span class="code">       6. org.apache.cassandra.request</span></span><br><span class="line"><span class="code">       7. org.apache.cassandra.net      ⬅️</span></span><br><span class="line"><span class="code">      10. org.apache.cassandra.db</span></span><br><span class="line"><span class="code">  SERVER: service:jmx:rmi:///jndi/rmi://192.168.47.227:7199/jmxrmi</span></span><br><span class="line"></span><br><span class="line">Exception caught: java.lang.NullPointerException</span><br></pre></td></tr></table></figure>
<p>查看每个节点自己的peers, 发现229和160的host_id一样:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span> | df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line"></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> | <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">17.4</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">461.6</span> GB   <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">6.09</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1.2</span> TB     <span class="number">256</span>     <span class="number">16.4</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.34</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>因为peers表的主键是peer, 所以可以根据peer删除一条记录:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> | <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"></span><br><span class="line">nodetool status -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">虽然peers中已经把<span class="number">229</span>移除了, 但是staus还是能看到<span class="number">229</span>为null</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">467.14</span> GB  <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/20549284/cassandra-how-to-remove-a-dead-node" target="_blank" rel="external">http://stackoverflow.com/questions/20549284/cassandra-how-to-remove-a-dead-node</a></p>
<p>另一种方式: 重启229, 这时候会分配一个新的HostID, 然后停掉, 再用removenode移除229.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.48.161</span>  1.16 TB    256     17.1%  <span class="number">54b3a7e0</span>-f<span class="number">778-4087</span>-98c3-ac<span class="number">84e56f77e6</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.160</span>  473.62 GB  256     16.1%  18a87c56-dcba-4614-adba-804aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  6.1 TB     256     16.8%  f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.229</span>  44.07 KB   256     16.7%  <span class="number">41211503-27</span>cd-47b0-b7c0-e<span class="number">5a7a4074</span>d34  RAC1    ⬅️</span><br><span class="line">UN  <span class="number">192.168.48.159</span>  1.22 TB    256     17.8%  df9a693b-efc1-41bc-9a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  1.35 TB    256     15.4%  <span class="number">02575631-6</span>ccb-4803-81fd-5bf<span class="number">7a978726</span>d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">91890739788</span><span class="number">95940412</span>). Waiting for replication confirmation from [/<span class="number">192.168.48.161</span>,/<span class="number">192.168.48.160</span>,/<span class="number">192.168.47.228</span>,/<span class="number">192.168.48.159</span>,/<span class="number">192.168.47.227</span>].</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool ring | grep <span class="number">91890739788</span><span class="number">95940412</span></span><br><span class="line"><span class="number">192.168.47.229</span>  RAC1        Down   Leaving 44.07 KB        16.73%              -<span class="number">91890739788</span><span class="number">95940412</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool removenode force</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">91890739788</span><span class="number">95940412</span>). Waiting for replication confirmation from [/<span class="number">192.168.48.161</span>,/<span class="number">192.168.48.160</span>,/<span class="number">192.168.47.228</span>,/<span class="number">192.168.48.159</span>,/<span class="number">192.168.47.227</span>].</span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.48.161</span>  1.16 TB    256     20.6%  <span class="number">54b3a7e0</span>-f<span class="number">778-4087</span>-98c3-ac<span class="number">84e56f77e6</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.160</span>  474.38 GB  256     20.2%  18a87c56-dcba-4614-adba-804aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  6.1 TB     256     20.4%  f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.159</span>  1.22 TB    256     20.1%  df9a693b-efc1-41bc-9a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  1.35 TB    256     18.8%  <span class="number">02575631-6</span>ccb-4803-81fd-5bf<span class="number">7a978726</span>d  RAC1</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="集群状态:_nodetool_decribecluster">集群状态: nodetool decribecluster</h3><p>启动OpsCenter后, 在8888上新建Cluster时报异常:  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:07+08</span>00 [forseti_cluster]  WARN: Node <span class="number">192.168.47.206</span> is reporting a schema disagreement: </span><br><span class="line">&#123;UUID('bc083db4-b<span class="number">544-38d1</span>-a37c-be3e78db1df1'): ['<span class="number">192.168.47.229</span>'], </span><br><span class="line">UUID('<span class="number">67462d4</span>d-a<span class="number">9c9-38a1</span>-afd<span class="number">8-1a39172</span>32b8a'): ['<span class="number">192.168.47.203</span>', '<span class="number">192.168.47.228</span>', '<span class="number">192.168.47.227</span>', '<span class="number">192.168.47.202</span>', '<span class="number">192.168.47.225</span>', '<span class="number">192.168.47.204</span>', '<span class="number">192.168.47.205</span>', '<span class="number">192.168.47.206</span>', '<span class="number">192.168.47.221</span>', '<span class="number">192.168.47.222</span>', '<span class="number">192.168.47.224</span>']&#125;</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:07+08</span>00 []  WARN: [control connection] No schema built on connect<span class="comment">; retrying without wait for schema agreement</span></span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:13+08</span>00 []  WARN: Host <span class="number">192.168.47.229</span> has been marked down</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:14+08</span>00 []  WARN: Failed to create connection pool for new host <span class="number">192.168.47.229</span>: errors=Timed out creating connection, last_host=None</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:47:07+08</span>00 []  INFO: Host <span class="number">192.168.47.229</span> may be up<span class="comment">; will prepare queries and open connection pool</span></span><br></pre></td></tr></table></figure>
<p>按照这里的方式, 如果状态为UNREACHABLE,则重启后再观察.<br><a href="http://docs.datastax.com/en/cassandra/2.1/cassandra/troubleshooting/trblshootSchemaDisagree.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.1/cassandra/troubleshooting/trblshootSchemaDisagree.html</a>  </p>
<p>果然有一个状态是UNREACHABLE的:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        <span class="number">3e4</span>c6580-<span class="number">3</span>d3c-<span class="number">327</span>b-<span class="number">986</span>c-<span class="number">63086e93</span>e94f: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br><span class="line">        UNREACHABLE: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>]</span><br></pre></td></tr></table></figure>
<p>发现229当掉, 重启后, 版本不一致:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        <span class="number">3e4</span>c6580-<span class="number">3</span>d3c-<span class="number">327</span>b-<span class="number">986</span>c-<span class="number">63086e93</span>e94f: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br><span class="line"></span><br><span class="line">        d2601534-c7ff-<span class="number">394</span>d-a656-<span class="number">33</span>d9da3dc574: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>]</span><br></pre></td></tr></table></figure>
<p>但是在229上查看到所有节点都不可达:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        UNREACHABLE: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br></pre></td></tr></table></figure>
<p>229过了段时间因为GC, 再次重启, 再次查看, 版本一样了:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">  Name: forseti_cluster</span><br><span class="line">  Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">  Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">  Schema versions:</span><br><span class="line">    <span class="number">977</span>ca50d-<span class="number">70</span>ab-<span class="number">3f</span>45-a1e6-ca18560b0c29: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="节点信息:_nodetool_info">节点信息: nodetool info</h3><p>主要关注KeyCache, 容量为512M(key_cache_size_in_mb), 用了500M左右, 命中率为65%. 没有开启RowCache(row_cache_size_in_mb:0).<br>堆内存16G, 用了6G(执行命令的这一时刻,并不是说总是占用这么点), 堆外内存off-heap使用了1G. 异常50个.    </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool info</span><br><span class="line">Token                  : (invoke with -T/<span class="comment">--tokens to see all 256 tokens)</span></span><br><span class="line">ID                     : abaa0cbc-09d3-4990-8698-ff4d2f2bb4f7</span><br><span class="line">Gossip active          : true</span><br><span class="line">Thrift active          : true</span><br><span class="line">Native Transport active: true</span><br><span class="line"><span class="operator"><span class="keyword">Load</span>                   : <span class="number">618.81</span> GB</span><br><span class="line">Generation <span class="keyword">No</span>          : <span class="number">1445525962</span></span><br><span class="line">Uptime (seconds)       : <span class="number">651191</span></span><br><span class="line"><span class="keyword">Heap</span> <span class="keyword">Memory</span> (MB)       : <span class="number">6167.96</span> / <span class="number">15974.44</span></span><br><span class="line"><span class="keyword">Off</span> <span class="keyword">Heap</span> <span class="keyword">Memory</span> (MB)   : <span class="number">1154.13</span></span><br><span class="line"><span class="keyword">Data</span> Center            : DC1</span><br><span class="line">Rack                   : RAC1</span><br><span class="line"><span class="keyword">Exceptions</span>             : <span class="number">50</span></span><br><span class="line"><span class="keyword">Key</span> <span class="keyword">Cache</span>              : <span class="keyword">size</span> <span class="number">520120120</span> (<span class="keyword">bytes</span>), <span class="keyword">capacity</span> <span class="number">536870912</span> (<span class="keyword">bytes</span>), <span class="number">112077861</span> hits, <span class="number">182128983</span> requests, <span class="number">0.656</span> recent hit rate, <span class="number">14400</span> <span class="keyword">save</span> <span class="keyword">period</span> <span class="keyword">in</span> seconds</span><br><span class="line"><span class="keyword">Row</span> <span class="keyword">Cache</span>              : <span class="keyword">size</span> <span class="number">0</span> (<span class="keyword">bytes</span>), <span class="keyword">capacity</span> <span class="number">0</span> (<span class="keyword">bytes</span>), <span class="number">0</span> hits, <span class="number">0</span> requests, <span class="keyword">NaN</span> recent hit rate, <span class="number">0</span> <span class="keyword">save</span> <span class="keyword">period</span> <span class="keyword">in</span> seconds</span></span><br></pre></td></tr></table></figure>
<p>off-heap保存的是什么?  <a href="http://noflex.org/cassandra-component-on-heap-or-off-heap/" target="_blank" rel="external">http://noflex.org/cassandra-component-on-heap-or-off-heap/</a><br>cassandra 2.0 and later use offheap for  </p>
<ul>
<li>bloom filter</li>
<li>compression offset map</li>
<li>partition summary</li>
<li>index samples</li>
<li>row cache </li>
</ul>
<p>仅仅查看每个节点的KeyCache:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">"/usr/install/cassandra/bin/nodetool info | tail -2 | head -1"</span></span><br><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">"/usr/install/cassandra/bin/nodetool info | sed -n '14p'"</span></span><br></pre></td></tr></table></figure>
<h3 id="Gossip信息:_nodetool_gossipinfo">Gossip信息: nodetool gossipinfo</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nodetool gossipinfo</span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1027890057681052346</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1004054309250591595</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1062467338696068910</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1130382709140432588</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1137590811836749748</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1024266383569750575</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">105769922317262244</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1061781412716791842</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">104095308743394398</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line">  STATUS:LEFT,-<span class="number">9088453765955214068</span>,<span class="number">1448966282585</span></span><br></pre></td></tr></table></figure>
<h3 id="网络状态netstats:_显示一个节点的Active_Stream">网络状态netstats: 显示一个节点的Active Stream</h3><p>1.正在加入集群的节点JOINING:   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047224 cassandra]$ /usr/install/cassandra/bin/nodetool netstats</span><br><span class="line">Mode: JOINING</span><br><span class="line">Bootstrap fcca1bf0-<span class="number">4</span>a6e-<span class="number">11e5</span>-<span class="number">8677</span>-<span class="number">6</span>da22c7e072c</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">        Receiving <span class="number">929</span> files, <span class="number">259726626064</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/forseti_fp/tcp_syn_data/forseti_fp-tcp_syn_data-tmp-jb-<span class="number">198</span>-Data.db <span class="number">120433605</span>/<span class="number">120433605</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">        Receiving <span class="number">976</span> files, <span class="number">214785965744</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/forseti/ip_mobilephone/forseti-ip_mobilephone-tmp-jb-<span class="number">16</span>-Data.db <span class="number">30801577</span>/<span class="number">30801577</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br></pre></td></tr></table></figure>
<p>2.离开集群的节点LEAVING:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047225 snapshots]$ nodetool netstats | head</span><br><span class="line">Mode: LEAVING</span><br><span class="line">Restore replica count dad915d0-<span class="number">7</span>d6f-<span class="number">11e5</span>-<span class="number">8681</span>-<span class="number">9f</span>6f9f8ad5ca</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span></span><br><span class="line">        Sending <span class="number">243</span> files, <span class="number">7877174416</span> bytes total</span><br></pre></td></tr></table></figure>
<p>下线的节点除了发送数据给其他节点, 也会接收数据.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047225 ~]$ nodetool netstats | grep <span class="string">"files"</span></span><br><span class="line">        Sending <span class="number">183</span> files, <span class="number">2169787693</span> bytes total</span><br><span class="line">        Sending <span class="number">223</span> files, <span class="number">6492707205</span> bytes total</span><br><span class="line">        ....</span><br><span class="line">        Receiving <span class="number">242</span> files, <span class="number">10438497913</span> bytes total</span><br><span class="line">        Receiving <span class="number">279</span> files, <span class="number">12407597530</span> bytes total</span><br></pre></td></tr></table></figure>
<p>3.正常的节点NORMAL, 会发送文件给其他节点, 并从下线的节点接收文件:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@spark047245 ~]$ /usr/install/cassandra/bin/nodetool netstats | head</span><br><span class="line">Mode: NORMAL</span><br><span class="line">Restore replica count db2a4310-<span class="number">7</span>d6f-<span class="number">11e5</span>-a4ef-<span class="number">8f</span>719a2aece0</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span></span><br><span class="line">        Sending <span class="number">309</span> files, <span class="number">25090493062</span> bytes total</span><br><span class="line"></span><br><span class="line">Unbootstrap <span class="number">00</span>ecfbb0-<span class="number">7</span>ea6-<span class="number">11e5</span>-<span class="number">9266</span>-f38b27f65aa6</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span></span><br><span class="line">        Receiving <span class="number">556</span> files, <span class="number">58062261421</span> bytes total</span><br></pre></td></tr></table></figure>
<h3 id="表相关的信息">表相关的信息</h3><p>1.查看表的信息, 前面四行是当前的读写延迟和读写次数.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@cass</span>047202 cassandra]$ nodetool cfstats forseti.velocity</span><br><span class="line"><span class="string">Keyspace:</span> forseti</span><br><span class="line">    Read <span class="string">Count:</span> <span class="number">10470099</span></span><br><span class="line">    Read <span class="string">Latency:</span> <span class="number">1.3186399419909973</span> ms.</span><br><span class="line">    Write <span class="string">Count:</span> <span class="number">146970362</span></span><br><span class="line">    Write <span class="string">Latency:</span> <span class="number">0.06062576270989929</span> ms.</span><br><span class="line">    Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">        Table:</span> velocity</span><br><span class="line">        SSTable <span class="string">count:</span> <span class="number">2144</span></span><br><span class="line">        SSTables <span class="keyword">in</span> each <span class="string">level:</span> [<span class="number">1</span>, <span class="number">10</span>, <span class="number">96</span>, <span class="number">723</span>, <span class="number">1314</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        Space used (live), <span class="string">bytes:</span> <span class="number">509031385679</span></span><br><span class="line">        Space used (total), <span class="string">bytes:</span> <span class="number">523815500936</span></span><br><span class="line">        Off heap memory used (total), <span class="string">bytes:</span> <span class="number">558210701</span></span><br><span class="line">        SSTable Compression <span class="string">Ratio:</span> <span class="number">0.23635049381008288</span></span><br><span class="line">        Number of keys (estimate): <span class="number">269787648</span></span><br><span class="line">        Memtable cell <span class="string">count:</span> <span class="number">271431</span></span><br><span class="line">        Memtable data size, <span class="string">bytes:</span> <span class="number">141953019</span></span><br><span class="line">        Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">1713</span></span><br><span class="line">        Local read <span class="string">count:</span> <span class="number">10470099</span></span><br><span class="line">        Local read <span class="string">latency:</span> <span class="number">1.266</span> ms</span><br><span class="line">        Local write <span class="string">count:</span> <span class="number">146970371</span></span><br><span class="line">        Local write <span class="string">latency:</span> <span class="number">0.053</span> ms</span><br><span class="line">        Pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">        Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">534721</span></span><br><span class="line">        Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.13542</span></span><br><span class="line">        Bloom filter space used, <span class="string">bytes:</span> <span class="number">180529808</span></span><br><span class="line">        Bloom filter off heap memory used, <span class="string">bytes:</span> <span class="number">180512656</span></span><br><span class="line">        Index summary off heap memory used, <span class="string">bytes:</span> <span class="number">118613037</span></span><br><span class="line">        Compression metadata off heap memory used, <span class="string">bytes:</span> <span class="number">259085008</span></span><br><span class="line">        Compacted partition minimum <span class="string">bytes:</span> <span class="number">104</span></span><br><span class="line">        Compacted partition maximum <span class="string">bytes:</span> <span class="number">190420296972</span></span><br><span class="line">        Compacted partition mean <span class="string">bytes:</span> <span class="number">8656</span></span><br><span class="line">        Average live cells per slice (last five minutes): <span class="number">0.0</span></span><br><span class="line">        Average tombstones per slice (last five minutes): <span class="number">0.0</span></span><br></pre></td></tr></table></figure>
<p>velocity在当前节点的keys有2.6亿. 其中最大的partition有190G! 说明存在一些很宽的行wide rows. 平均每个partition的大小是104Byte.   </p>
<p><a href="http://docs.datastax.com/en/cql/3.1/cql/cql_reference/compactSubprop.html" target="_blank" rel="external">http://docs.datastax.com/en/cql/3.1/cql/cql_reference/compactSubprop.html</a>  </p>
<blockquote>
<p>sstable_size_in_mb默认是160MB. The target size for SSTables that use the leveled compaction strategy.<br>Although SSTable sizes should be less or equal to sstable_size_in_mb, 尽管SSTable的大小应该比默认的160M要小或相等.<br>it is possible to have a larger SSTable during compaction. 在Compaction过程中,可能产生更大的SSTable.<br>This occurs when data for a given partition key is exceptionally large. 当某个分区键的数据非常大时,<br>The data is not split into two SSTables. 分区很大的键在compact时不会拆分到两个SSTable文件中(因为partition key只会在一个SSTable中).  </p>
</blockquote>
<p>2.线程池状态: tpstatus可以查看的内容和system.log中打印的StatsLogger差不多.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ nodetool tpstats</span><br><span class="line">Pool Name                    Active   Pending      Completed   Blocked  All time blocked</span><br><span class="line">ReadStage                         <span class="number">2</span>         <span class="number">0</span>       <span class="number">10960442</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">RequestResponseStage              <span class="number">0</span>         <span class="number">0</span>      <span class="number">447942623</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MutationStage                     <span class="number">0</span>         <span class="number">0</span>      <span class="number">239315421</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReadRepairStage                   <span class="number">0</span>         <span class="number">0</span>        <span class="number">1124868</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReplicateOnWriteStage             <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">GossipStage                       <span class="number">0</span>         <span class="number">0</span>        <span class="number">1477282</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CacheCleanupExecutor              <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MigrationStage                    <span class="number">0</span>         <span class="number">0</span>             <span class="number">46</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemoryMeter                       <span class="number">0</span>         <span class="number">0</span>          <span class="number">10694</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">FlushWriter                       <span class="number">0</span>         <span class="number">0</span>          <span class="number">11360</span>         <span class="number">0</span>               <span class="number">511</span></span><br><span class="line">ValidationExecutor                <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">InternalResponseStage             <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">AntiEntropyStage                  <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemtablePostFlusher               <span class="number">0</span>         <span class="number">0</span>          <span class="number">16487</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MiscStage                         <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">PendingRangeCalculator            <span class="number">0</span>         <span class="number">0</span>             <span class="number">39</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CompactionExecutor                <span class="number">3</span>         <span class="number">3</span>          <span class="number">47113</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">commitlog_archiver                <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">HintedHandoff                     <span class="number">0</span>         <span class="number">1</span>            <span class="number">867</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Message type           Dropped</span><br><span class="line">RANGE_SLICE                  <span class="number">0</span></span><br><span class="line">READ_REPAIR                  <span class="number">0</span></span><br><span class="line">PAGED_RANGE                  <span class="number">0</span></span><br><span class="line">BINARY                       <span class="number">0</span></span><br><span class="line">READ                         <span class="number">0</span></span><br><span class="line">MUTATION                     <span class="number">0</span></span><br><span class="line">_TRACE                       <span class="number">0</span></span><br><span class="line">REQUEST_RESPONSE             <span class="number">2</span></span><br><span class="line">COUNTER_MUTATION             <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>比如正在运行的CompactionExecutor有3个, 用compactionstats可以查看正在运行Compaction的表:   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">4</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction         forseti        velocity      <span class="number">9600330302</span>     <span class="number">12886138624</span>     bytes    <span class="number">74.50</span>%</span><br><span class="line">               Compaction         forseti  device_account        <span class="number">64712962</span>      <span class="number">1923986398</span>     bytes     <span class="number">3.36</span>%</span><br><span class="line">     Tombstone Compaction         forseti        velocity        <span class="number">95382333</span>    <span class="number">170991248015</span>     bytes     <span class="number">0.06</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h00m38s</span><br></pre></td></tr></table></figure>
<h3 id="compactionhistory">compactionhistory</h3><p><a href="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCompactionHistory.html" target="_blank" rel="external">https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCompactionHistory.html</a></p>
<p>最后一列表示rows_merged：{tables:rows}. For example: {1:3, 3:1} means 3 rows were taken from one SSTable (1:3)<br>and 1 row taken from 3 SSTables (3:1) to make the one SSTable in that compaction operation.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 &gt; compactionhistory.log</span><br><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 | awk '&#123;for(i=4<span class="comment">;i&lt;=NF;i++) printf"%s\t",$i&#125; &#123;print ""&#125;' | head </span></span><br><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 | awk '&#123;if(NF&gt;9) print $0&#125;'</span><br><span class="line"></span><br><span class="line">3cb01450-e<span class="number">5d7-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751483035</span>7             <span class="number">985256393</span>      <span class="number">869306399</span>      &#123;<span class="number">1:325289</span>, <span class="number">2:11651</span>&#125;</span><br><span class="line">ff100470-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751472696</span>7             <span class="number">161269131</span>      <span class="number">159732166</span>      &#123;<span class="number">1:207378</span>, 2:9918&#125;</span><br><span class="line">bafef020-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751461277</span>0             <span class="number">1171434739</span>     <span class="number">1167942768</span>     &#123;<span class="number">1:811453</span>, <span class="number">2:28598</span>&#125;</span><br><span class="line">b7c08e00-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751460732</span>8             <span class="number">144946713</span>      <span class="number">143529681</span>      &#123;<span class="number">1:187320</span>, <span class="number">2:10070</span>&#125;</span><br><span class="line"><span class="number">6f66d380</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751448594</span>4             <span class="number">128493647</span>      <span class="number">127148807</span>      &#123;<span class="number">1:167405</span>, 2:9312&#125;</span><br><span class="line">2be5ca30-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751437269</span>1             <span class="number">112061194</span>      <span class="number">111124311</span>      &#123;<span class="number">1:151315</span>, 2:6405&#125;</span><br><span class="line"><span class="number">2a335f40</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751436984</span>4             <span class="number">2078394794</span>     <span class="number">2073816751</span>     &#123;<span class="number">1:1298699</span>, <span class="number">2:39956</span>&#125;</span><br><span class="line"><span class="number">04070880</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751430579</span>9             <span class="number">103532684</span>      <span class="number">102206816</span>      &#123;<span class="number">1:137231</span>, 2:9020&#125;</span><br><span class="line">bb648530-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">1457514183938</span>             <span class="number">86832984</span>       <span class="number">85571719</span>       &#123;<span class="number">1:115214</span>, 2:8749&#125;</span><br><span class="line"><span class="number">750254f0</span>-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751406585</span>5             <span class="number">69678994</span>       <span class="number">68516377</span>       &#123;<span class="number">1:93817</span>, 2:7968&#125;</span><br><span class="line"><span class="number">3b9a2260</span>-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751396954</span>2             <span class="number">53715409</span>       <span class="number">51918781</span>       &#123;<span class="number">1:69930</span>, 2:6969, 3:2522&#125;</span><br></pre></td></tr></table></figure>
<p>system.log中对于每次Compaction操作都有记录本次合并了多少个文件：  </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INFO [CompactionExecutor:<span class="number">48884</span>] <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">08</span>:<span class="number">34</span>,<span class="number">162</span> CompactionTask.java (<span class="built_in">line</span> <span class="number">120</span>) Compacting [</span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947338-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947335-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947334-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947336-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947337-Data.db'</span>)]</span><br><span class="line">INFO [CompactionExecutor:<span class="number">48884</span>] <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">08</span>:<span class="number">34</span>,<span class="number">181</span> CompactionTask.java (<span class="built_in">line</span> <span class="number">299</span>) Compacted <span class="number">5</span> sstables <span class="built_in">to</span> [</span><br><span class="line">/home/admin/cassandra/data/<span class="keyword">system</span>/compactions_in_progress/<span class="keyword">system</span>-compactions_in_progress-jb-<span class="number">947339</span>,].  </span><br><span class="line"><span class="number">1</span>,<span class="number">803</span> <span class="keyword">bytes</span> <span class="built_in">to</span> <span class="number">1</span>,<span class="number">044</span> (~<span class="number">57</span>% <span class="operator">of</span> original) <span class="operator">in</span> <span class="number">18</span>ms = <span class="number">0.055313</span>MB/s.  </span><br><span class="line"><span class="number">12</span> total partitions merged <span class="built_in">to</span> <span class="number">8.</span>  Partition <span class="built_in">merge</span> counts were &#123;<span class="number">1</span>:<span class="number">8</span>, <span class="number">2</span>:<span class="number">2</span>, &#125;</span><br></pre></td></tr></table></figure>
<p>1:8表示：有8行从一个sstables中获取<br>2:2表示：有2行从两个sstables中获取</p>
<p>疑问：partitions数量从12个被合并为8个，为什么partition会减少呢？<br>totalSourceRows=12, totalkeysWritten=8<br>rows和keys的概念是不同的。 相同key可以有多个rows。<br>所以12条记录中，会有4条记录的row-key和8条中的相同。最后的keys数量也就只有4个。  </p>
<h2 id="日志分析">日志分析</h2><h3 id="ParNew统计">ParNew统计</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">INFO [ScheduledTasks:1] 2016-03-02 23:05:42,594 GCInspector.java (<span class="keyword">line</span> 116) GC <span class="keyword">for</span> ParNew: 406 ms <span class="keyword">for</span> 2 collections, 8366932456 used; max is 16750411776</span><br><span class="line">INFO [ScheduledTasks:1] 2016-03-02 23:06:57,084 GCInspector.java (<span class="keyword">line</span> 116) GC <span class="keyword">for</span> ParNew: 520 ms <span class="keyword">for</span> 1 collections, 4986064208 used; max is 16750411776</span><br><span class="line"></span><br><span class="line">统计所有的ParNew</span><br><span class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/cassandra/system.<span class="keyword">log</span> | grep <span class="string">"GC for ParNew"</span> | awk '&#123;<span class="keyword">print</span> <span class="label">$3&#125;</span>' | uniq -c</span><br><span class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/cassandra/system.<span class="keyword">log</span> | grep <span class="string">"GC for ParNew"</span> | awk '&#123;<span class="keyword">if</span>(<span class="label">$11</span>&gt;200) <span class="keyword">print</span> <span class="label">$3&#125;</span>' | uniq -c</span><br><span class="line">按照时间排序：</span><br><span class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/cassandra/system.<span class="keyword">log</span>* | grep <span class="string">"GC for ParNew"</span> | awk '&#123;<span class="keyword">print</span> <span class="label">$3&#125;</span>' | uniq -c | awk '&#123;<span class="keyword">print</span> <span class="label">$2</span><span class="string">" "</span><span class="label">$1&#125;</span>' | <span class="keyword">sort</span> | tail -30</span><br><span class="line">    126 2016-03-01</span><br><span class="line">    153 2016-03-02</span><br><span class="line">    146 2016-03-03</span><br><span class="line"></span><br><span class="line">按天统计超过500ms的ParNew</span><br><span class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/cassandra/system.<span class="keyword">log</span> | grep <span class="string">"GC for ParNew"</span> | awk '&#123;<span class="keyword">if</span>(<span class="label">$11</span>&gt;500) <span class="keyword">print</span> <span class="label">$3&#125;</span>' | uniq -c</span><br><span class="line">     57 2016-03-01</span><br><span class="line">     73 2016-03-02</span><br><span class="line">     89 2016-03-03</span><br><span class="line"></span><br><span class="line">按天-小时统计超过500ms的ParNew</span><br><span class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/cassandra/system.<span class="keyword">log</span> | grep <span class="string">"GC for ParNew"</span> | awk '&#123;<span class="keyword">if</span>(<span class="label">$11</span>&gt;500) <span class="keyword">print</span> <span class="label">$3</span><span class="string">" "</span><span class="literal">substr</span>(<span class="label">$4</span>,0,2)&#125;' | uniq -c | tail</span><br><span class="line">     14 2016-03-14 18</span><br><span class="line">      3 2016-03-14 19</span><br><span class="line">      7 2016-03-14 20</span><br><span class="line">      7 2016-03-14 21</span><br><span class="line">      2 2016-03-14 23</span><br><span class="line">      1 2016-03-15 00</span><br><span class="line">     10 2016-03-15 08</span><br><span class="line">     20 2016-03-15 09</span><br><span class="line">     41 2016-03-15 10</span><br><span class="line">     15 2016-03-15 11</span><br></pre></td></tr></table></figure>
<h3 id="tombstone与GC的比较">tombstone与GC的比较</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> WARN [ReadStage:69] <span class="number">2016-03-02</span> <span class="number">07:52:55,238</span> SliceQueryFilter.java (line 231) Read 1002 live and 5112 tombstone cells in forseti.velocity (see tombstone_warn_threshold). 1001 columns was requested, slices=[dhgate:dh_web_seller:ip<span class="number">3:145378055</span>2156:sequence_id-dhgate:!]</span><br><span class="line"></span><br><span class="line">统计多个文件，要加sort</span><br><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat system.log* | grep "tombstone cells in forseti.velocity" | awk '&#123;print substr($3,0,7)&#125;' | sort |  uniq -c | head</span><br><span class="line">  <span class="number">10155 2015</span>-07</span><br><span class="line"> <span class="number">192148 2015</span>-08</span><br><span class="line"> <span class="number">257728 201</span>5-09</span><br><span class="line">  <span class="number">59041 2015</span>-10</span><br><span class="line">   <span class="number">3499 2015</span>-11</span><br><span class="line">   <span class="number">3189 2015</span>-12</span><br><span class="line">  <span class="number">18997 2016</span>-01</span><br><span class="line">  <span class="number">12411 2016</span>-02</span><br><span class="line">   <span class="number">7466 2016</span>-03</span><br></pre></td></tr></table></figure>
<h2 id="性能调优">性能调优</h2><h3 id="GC">GC</h3><p>大内存</p>
<ul>
<li>会降低GC执行次数(一次可以容纳的东西较多，不需要经常打扫)</li>
<li>相应的会增加GC执行耗时(东西太多了，整理的慢)</li>
</ul>
<p>小内存</p>
<ul>
<li>会缩小单次GC耗时（东西本来就很少，整理的也很快）</li>
<li>相应的会增加GC执行次数（进来的数据量不变，每次只整理一小批，就要不停地打扫）</li>
</ul>
<p>GC中年轻代和老年代大小变化的影响：</p>
<table>
<thead>
<tr>
<th>generation</th>
<th>decrement:too small</th>
<th>increment:too large</th>
</tr>
</thead>
<tbody>
<tr>
<td>Old</td>
<td>降低FGC执行时间，可能面临OOM，更频繁的FGC</td>
<td>减少FGC执行次数，单次FGC耗时将会增加</td>
</tr>
<tr>
<td>Yung</td>
<td>Minor GC就会频繁执行,转移到老年代的对象增多，也会引起FGC的频繁执行</td>
</tr>
</tbody>
</table>
<p><a href="https://segmentfault.com/a/1190000004303843" target="_blank" rel="external">https://segmentfault.com/a/1190000004303843</a>  </p>
<p>并发模式失败:CMS GC执行中并不会伴随内存压缩，因此GC速度相比Parallel GC会更快一些，<br>GC清理过程中释放的内存便会成为空闲空间。因为空间不连续，可能会导致在创建大对象时空间不足。<br>如果老年代尚有300M空闲，却不能为10MB的对象分配足够的连续空间,就会触发内存压缩。<br>结论：<strong>当内存压缩时，CMS将会变慢</strong>  </p>
<p>如果GC执行时间满足以下判断条件，那么GC调优并没那么必须。  </p>
<ul>
<li>Minor GC执行迅速(50毫秒以内)</li>
<li>Minor GC执行不频繁(间隔10秒左右一次)</li>
<li>Full GC执行迅速(1秒以内)</li>
<li>Full GC执行不频繁(间隔10分钟左右一次)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048162 cassandra]$ sudo -u admin jstat -gcutil <span class="number">31596</span> <span class="number">1</span>s</span><br><span class="line">  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  <span class="number">0.99</span>   <span class="number">0.00</span>  <span class="number">61.69</span>  <span class="number">15.02</span>  <span class="number">59.74</span>  <span class="number">12044</span>  <span class="number">546.120</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.214</span></span><br><span class="line">  <span class="number">2.56</span>   <span class="number">0.00</span>   <span class="number">3.27</span>  <span class="number">15.21</span>  <span class="number">59.74</span>  <span class="number">12046</span>  <span class="number">546.197</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.291</span></span><br><span class="line">  <span class="number">2.56</span>   <span class="number">0.00</span>  <span class="number">49.09</span>  <span class="number">15.21</span>  <span class="number">59.74</span>  <span class="number">12046</span>  <span class="number">546.197</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.291</span></span><br><span class="line">  <span class="number">0.00</span>  <span class="number">12.90</span>  <span class="number">30.43</span>  <span class="number">15.21</span>  <span class="number">59.74</span>  <span class="number">12047</span>  <span class="number">546.219</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.314</span></span><br><span class="line">  <span class="number">0.00</span>  <span class="number">12.90</span>  <span class="number">84.14</span>  <span class="number">15.21</span>  <span class="number">59.74</span>  <span class="number">12047</span>  <span class="number">546.219</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.314</span></span><br><span class="line">  <span class="number">8.59</span>   <span class="number">0.00</span>  <span class="number">39.23</span>  <span class="number">15.43</span>  <span class="number">59.74</span>  <span class="number">12048</span>  <span class="number">546.252</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.347</span></span><br><span class="line">  <span class="number">8.59</span>   <span class="number">0.00</span>  <span class="number">83.73</span>  <span class="number">15.43</span>  <span class="number">59.74</span>  <span class="number">12048</span>  <span class="number">546.252</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.347</span></span><br><span class="line">  <span class="number">0.00</span>   <span class="number">9.15</span>  <span class="number">40.61</span>  <span class="number">15.57</span>  <span class="number">59.74</span>  <span class="number">12049</span>  <span class="number">546.282</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.376</span></span><br><span class="line">  <span class="number">0.00</span>   <span class="number">9.15</span>  <span class="number">87.59</span>  <span class="number">15.57</span>  <span class="number">59.74</span>  <span class="number">12049</span>  <span class="number">546.282</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.376</span></span><br><span class="line">  <span class="number">7.39</span>   <span class="number">0.00</span>  <span class="number">43.98</span>  <span class="number">15.73</span>  <span class="number">59.74</span>  <span class="number">12050</span>  <span class="number">546.310</span>    <span class="number">48</span>   <span class="number">20.094</span>  <span class="number">566.404</span></span><br></pre></td></tr></table></figure>
<p>MinorGC的平均时间=546/12044=0.04s=40ms，上面统计了10s中，发生了12050-12044=6次MinorGC<br>FGC的平均时间=20/48=0.41s=410ms，看起来也没有太长时间的FGC。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048162 cassandra]$ sudo -u admin jstat -gccapacity <span class="number">31596</span> <span class="number">10</span>s</span><br><span class="line"> NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC      PGCMN    PGCMX     PGC       PC     YGC    FGC</span><br><span class="line"><span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span>  <span class="number">21248.0</span>  <span class="number">83968.0</span>  <span class="number">45824.0</span>  <span class="number">45824.0</span> <span class="number">126883</span>   <span class="number">691</span></span><br><span class="line"><span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span>  <span class="number">21248.0</span>  <span class="number">83968.0</span>  <span class="number">45824.0</span>  <span class="number">45824.0</span> <span class="number">126887</span>   <span class="number">691</span></span><br><span class="line"><span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span>  <span class="number">21248.0</span>  <span class="number">83968.0</span>  <span class="number">45824.0</span>  <span class="number">45824.0</span> <span class="number">126891</span>   <span class="number">691</span></span><br><span class="line"><span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span>  <span class="number">21248.0</span>  <span class="number">83968.0</span>  <span class="number">45824.0</span>  <span class="number">45824.0</span> <span class="number">126898</span>   <span class="number">692</span></span><br><span class="line"><span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">4194304.0</span> <span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span>  <span class="number">21248.0</span>  <span class="number">83968.0</span>  <span class="number">45824.0</span>  <span class="number">45824.0</span> <span class="number">126902</span>   <span class="number">693</span></span><br></pre></td></tr></table></figure>
<p>New : 4,194,304=4G<br>Old : 12,582,912=12G<br>New : Old = 4G : 12G = 1 : 3<br>这是通过<code>-Xms16G -Xmx16G -Xmn4G</code>指定的。   </p>
<h4 id="memtable_total_space_in_mb">memtable_total_space_in_mb</h4><p>默认堆1/4大小。我们集群机器内存32G，cassandra-env.sh关于堆内存的配置：-Xms16G，-Xmx16G，-Xmn4G<br>堆1/4=4G(和Xmn新生代大小一样)。那么堆内存是由什么决定的呢？看下面的两个配置：  </p>
<h4 id="MAX_HEAP_SIZE&amp;HEAP_NEWSIZE">MAX_HEAP_SIZE&amp;HEAP_NEWSIZE</h4><p><code>Xms和Xmx</code>对应<code>MAX_HEAP_SIZE</code>，<code>-Xmn</code>对应<code>HEAP_NEWSIZE</code><br>而MAX_HEAP_SIZE建议为系统内存的1/4,但不超过8G。Java的堆内存不宜过高的原因是：  </p>
<ul>
<li>超过8G时，Java处理GC回收的能力会有所减弱</li>
<li>现代操作系统对频繁访问的数据会放到PageCache里（内存中），如果JVM堆内存过大，PageCache内存就减少，这部分的工作也不是很好</li>
</ul>
<p>基于java的Cassandra,一般为堆分配8G内存，现代机器的内存一般超过8G，<br>Cassandra可以使用额外的内存（分配给堆剩余的内存）作为page cache，<br>当磁盘上的文件(sstable)被访问时会被放入page cache,<br>所以访问的sstable文件并不是在堆内存里，而是在page cache里，因此也有内存级的访问速度！  </p>
<p>HEAP_NEWSIZE为100M*Core(不过有些文章说为Heap的1/4)：  </p>
<ul>
<li>NEW越大，GC暂停的时间越长，因为在内存中的数据越多 -&gt; GC时间长，次数少；  </li>
<li>NEW越小，GC的代价越大，因为内存很容易满，越容易发生GC -&gt; GC时间短，次数多。  </li>
</ul>
<table>
<thead>
<tr>
<th>config</th>
<th>old value</th>
<th>suggest value</th>
<th>explain</th>
</tr>
</thead>
<tbody>
<tr>
<td>MAX_HEAP_SIZE(Xmx)</td>
<td>16G</td>
<td>8G</td>
<td>物理内存的1/4,最多8G</td>
</tr>
<tr>
<td>HEAP_NEWSIZE(Xms)</td>
<td>4G</td>
<td>800M/2G</td>
<td>100*8cores,堆内存的1/4</td>
</tr>
<tr>
<td>memtable_total_space_in_mb</td>
<td>1G</td>
<td>2G</td>
<td>堆内存的1/4</td>
</tr>
</tbody>
</table>
<blockquote>
<p>问题：<code>HEAP_NEWSIZE</code>和<code>memtable_total_space_in_mb</code>大小都是堆内存的1/4,两者有关联吗？  </p>
</blockquote>
<p>几种GC的发生：</p>
<ul>
<li>Eden满了，发生minor gc，将eden中存活的移动到Survivor</li>
<li>Survivor满了，会将eden中存活的和survivor中存活的移动到另一个survivor</li>
<li>对象在survivor中超过指定年龄，被promot到old</li>
<li>old满了，发生FullGC</li>
</ul>
<p>if you see long ParNew GC pauses it’s because many objects are being promoted. </p>
<p>If you have long ParNew pauses, it means that a lot of the objects in eden are not (yet) garbage, and they’re being copied around to the survivor space, or into the old gen.</p>
<p>通常来说大部分的对象存活周期都很短(short lived objects)。找出并移除要被回收的对象是很快的。<br>但是将没有被回收的对象从eden移动到survivor，或者从survivor移动到old，则很慢。<br>长时间的ParNew GC停顿，表示新生代的很多对象没有被回收，需要移动的对象很多，因此耗时较长。  </p>
<p>哪些对象会被提升：在新生代存活超过MaxTenuringThreshold(默认为1，因为大部分对象都是short live)  </p>
<p>By increasing the young generation space it decreases the frequency at which we have to run GC because more objects can accumulate before we reach 75% capacity. By increasing the young generation and the MaxTenuringThreshold you give the short lived objects more time to die, and dead objects don’t get promoted. </p>
<p>As of Cassandra 2.0, there are two major pieces of the storage engine that still depend on the JVM heap: memtables and the key cache.</p>
<p>The only thing that should live in tenured space is the key cache and memtables.</p>
<p>Although no random I/O occurs, compaction can still be a fairly heavyweight operation. During compaction, there is a temporary spike in disk space usage and disk I/O because the old and new SSTables co-exist. To minimize deteriorating read speed, compaction runs in the background.</p>
<p>To lessen the impact of compaction on application requests, Cassandra performs these operations:</p>
<ul>
<li>Throttles compaction I/O to compaction_throughput_mb_per_sec (default 16MB/s).</li>
<li>Requests that the operating system pull newly compacted partitions into the page cache when the key cache indicates that the compacted partition is hot for recent reads.</li>
</ul>
<h3 id="其他配置信息">其他配置信息</h3><ul>
<li>提高compaction流量，对于大的partition让compaction尽快完成。已完成</li>
<li>修改内存配置（堆内存，New大小，memtable大小）为官方建议的配置。未完成</li>
<li>修改compaction策略。待评估</li>
</ul>
<h4 id="compaction_throughput_mb_per_sec_√">compaction_throughput_mb_per_sec √</h4><p>插入速度越快，就应该更快地compact便于减少sstable的数量。<br>如果没有及时compact，sstable数量变多，查询分布在多个sstable会变慢。<br>默认值为16M. 建议的值是每秒写入量(MB/s)的16-32倍，这个值是针对整个集群而言。<br>目前的值是128M,对应的写入量大概是8M/s.<br>因为要求尽快地compact,所以应该提升compact的流量。<br>提高到200M:  <code>nodetool setcompactionthroughput 200</code>  </p>
<p>为什么是提高而不是减少？降低后本来应该快速被compaction完成的对象现在由于流量限制，compaction完成的慢了，对象存活时间越长。  </p>
<blockquote>
<p>Throttling compaction can even make it worse by forcing Cassandra to keep objects in memory longer than necessary, causing promotion which leads to memory compaction which is bound by memory bandwidth of the system.</p>
<p>该配置主要针对大的partitions(partition指的是partition key对应的记录)</p>
</blockquote>
<h4 id="LeveledCompactionStrategy">LeveledCompactionStrategy</h4><p>Row Fragmentation行碎片，相同行多个列分散在多个sstable文件中，增加读延迟，因为要读取多个文件</p>
<p>相同partition key的数据写入包括两种情况：列被覆盖（比如最近的访问时间，则每次更新同一列），<br>添加新列（比如以sequenceId作为cluster key，则对于相同attribtue,都是添加新列，这种叫做wide rows）。  </p>
<p>层级压缩策略：在compaction时花费更多的IO（代价）来确保一行记录分布在尽量少的sstable上（读延迟低）。<br>使用该配置，在90%的情况下读取一行记录只需要读取一个sstable文件。  </p>
<p>Leveled compaction essentially treats more disk IO for a guarantee of how many SSTables a row may be spread. Below are the cases where Leveled Compaction can be a good option.</p>
<ul>
<li>Low latency read is required</li>
<li>High read/write ratio</li>
<li>Rows are frequently updated. If size-tiered compaction is used, a row will spread across multiple SSTables.</li>
</ul>
<p>Below are the cases where size-tiered compaction can be a good option.</p>
<ul>
<li>Disk I/O is expensive</li>
<li>Write heavy workloads.</li>
<li>Rows are write once. If the rows are written once and then never updated, they will be contained in a single SSTable naturally. There’s no point to use the more I/O intensive leveled compaction.</li>
</ul>
<table>
<thead>
<tr>
<th>Leveled</th>
<th>velocity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low latency read</td>
<td>+(20ms)</td>
</tr>
<tr>
<td>High read/write ratio</td>
<td>-(写多读少)</td>
</tr>
<tr>
<td>Rows frequently updated</td>
<td>+(attribute)</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Size-tiered</th>
<th>velocity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Disk I/O is expensive</td>
<td>-(SSD)</td>
</tr>
<tr>
<td>Write heavy workloads</td>
<td>+(20倍于读)</td>
</tr>
<tr>
<td>Rows are write once</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Leveled has many small and fixed sized SSTables grouped into levels. Within a level, the SSTables do not have any overlap. </p>
<p>Consider SizeTiered Compaction when:</p>
<ul>
<li>There is uncertainty of which compaction strategy is best; SizeTiered Compaction provides a good set of tradeoffs for acceptable performance under most workloads.</li>
<li>Mixed workload of reads, updates, and deletes; avoiding updates to existing rows helps avoid fragmentation.</li>
<li>Read latency is not important; the upper bound to fragmentation is the number of SSTables representing the column family.</li>
<li>Tombstones make up a substantial portion of at rest data, and are reaped via manual compaction.</li>
<li>There is sufficient free space to store 100% growth of the largest column family.</li>
</ul>
<p>Consider Leveled Compaction when:</p>
<ul>
<li>Read-heavy workload; many reads, some updates</li>
<li>Workloads which frequently update existing rows</li>
<li>Read latency is important; the upper bound to fragmentation is reduced as the number of SSTables in the column family grows (due to the leveled compaction process)</li>
<li>Tombstone space recovery is not important; tombstones will not be reaped until an SSTable moves to the next compaction tier (i.e. moves from L1 to L2).</li>
<li>There is not sufficient free space to store 100% growth of the largest column family. Leveled compaction requires 10 times available storage space of the largest SSTable in a column family.</li>
</ul>
<blockquote>
<p>Notice: Very wide rows are bad for compaction performance; wide rows fragmented across multiple SSTables (especially with partial updates) seem to result in lazy compaction.</p>
</blockquote>
<h3 id="Ref">Ref</h3><ul>
<li><p><a href="https://docs.datastax.com/en/cassandra/2.0/cassandra/dml/dml_write_path_c.html" target="_blank" rel="external">https://docs.datastax.com/en/cassandra/2.0/cassandra/dml/dml_write_path_c.html</a></p>
</li>
<li><p><a href="https://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html" target="_blank" rel="external">https://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html</a></p>
</li>
<li><p><a href="https://tobert.github.io/pages/als-cassandra-21-tuning-guide.html" target="_blank" rel="external">https://tobert.github.io/pages/als-cassandra-21-tuning-guide.html</a></p>
</li>
<li><p><a href="http://www.datastax.com/dev/blog/when-to-use-leveled-compaction" target="_blank" rel="external">http://www.datastax.com/dev/blog/when-to-use-leveled-compaction</a></p>
</li>
<li><a href="http://www.datastax.com/dev/blog/leveled-compaction-in-apache-cassandra" target="_blank" rel="external">http://www.datastax.com/dev/blog/leveled-compaction-in-apache-cassandra</a></li>
<li><a href="http://www.roman10.net/2012/08/24/apache-cassandra-how-compaction-works/" target="_blank" rel="external">http://www.roman10.net/2012/08/24/apache-cassandra-how-compaction-works/</a></li>
<li><a href="http://engblog.polyvore.com/2015/03/cassandra-compaction-and-tombstone.html" target="_blank" rel="external">http://engblog.polyvore.com/2015/03/cassandra-compaction-and-tombstone.html</a></li>
</ul>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/10/15/Cassandra-Daily/">Cassandra日常运维</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年10月15日 - 00时00分</p>
  <p><span>最后更新:</span>2016年03月15日 - 19时54分</p>
  <p>
    <span>原始链接:</span><a href="/2015/10/15/Cassandra-Daily/" title="Cassandra日常运维">http://github.com/zqhxuyuan/2015/10/15/Cassandra-Daily/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/10/15/Cassandra-Daily/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/10/15/Cassandra-exception/">
        Cassandra常见异常
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/09/10/2015-09-10-Storm-Window/">
        Storm的滑动窗口
      </a>
    </div>
  
</nav>

  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cassandra日常运维"><span class="toc-number">1.</span> <span class="toc-text">Cassandra日常运维</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线上应急"><span class="toc-number">1.1.</span> <span class="toc-text">线上应急</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#机器预估"><span class="toc-number">1.2.</span> <span class="toc-text">机器预估</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">1.3.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#升级"><span class="toc-number">1.4.</span> <span class="toc-text">升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件"><span class="toc-number">1.5.</span> <span class="toc-text">文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进程"><span class="toc-number">1.6.</span> <span class="toc-text">进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CQL查询客户端"><span class="toc-number">1.7.</span> <span class="toc-text">CQL查询客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群维护"><span class="toc-number">1.8.</span> <span class="toc-text">集群维护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpsCenter:"><span class="toc-number">1.9.</span> <span class="toc-text">OpsCenter:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装opscenter"><span class="toc-number">1.9.1.</span> <span class="toc-text">安装opscenter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建集群和安装agent"><span class="toc-number">1.9.2.</span> <span class="toc-text">创建集群和安装agent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改agent配置"><span class="toc-number">1.9.3.</span> <span class="toc-text">修改agent配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#堡垒机无法查看opscenter"><span class="toc-number">1.9.4.</span> <span class="toc-text">堡垒机无法查看opscenter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动安装agent"><span class="toc-number">1.9.5.</span> <span class="toc-text">手动安装agent</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodetool工具集"><span class="toc-number">2.</span> <span class="toc-text">nodetool工具集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nodetool维护工具"><span class="toc-number">2.1.</span> <span class="toc-text">nodetool维护工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快照:_snapshot"><span class="toc-number">2.2.</span> <span class="toc-text">快照: snapshot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除节点:_removenode"><span class="toc-number">2.3.</span> <span class="toc-text">删除节点: removenode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#替换节点:_replace_address"><span class="toc-number">2.4.</span> <span class="toc-text">替换节点: replace_address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群状态:_nodetool_decribecluster"><span class="toc-number">2.5.</span> <span class="toc-text">集群状态: nodetool decribecluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#节点信息:_nodetool_info"><span class="toc-number">2.6.</span> <span class="toc-text">节点信息: nodetool info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gossip信息:_nodetool_gossipinfo"><span class="toc-number">2.7.</span> <span class="toc-text">Gossip信息: nodetool gossipinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#网络状态netstats:_显示一个节点的Active_Stream"><span class="toc-number">2.8.</span> <span class="toc-text">网络状态netstats: 显示一个节点的Active Stream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#表相关的信息"><span class="toc-number">2.9.</span> <span class="toc-text">表相关的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compactionhistory"><span class="toc-number">2.10.</span> <span class="toc-text">compactionhistory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志分析"><span class="toc-number">3.</span> <span class="toc-text">日志分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ParNew统计"><span class="toc-number">3.1.</span> <span class="toc-text">ParNew统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tombstone与GC的比较"><span class="toc-number">3.2.</span> <span class="toc-text">tombstone与GC的比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能调优"><span class="toc-number">4.</span> <span class="toc-text">性能调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GC"><span class="toc-number">4.1.</span> <span class="toc-text">GC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#memtable_total_space_in_mb"><span class="toc-number">4.1.1.</span> <span class="toc-text">memtable_total_space_in_mb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MAX_HEAP_SIZE&HEAP_NEWSIZE"><span class="toc-number">4.1.2.</span> <span class="toc-text">MAX_HEAP_SIZE&HEAP_NEWSIZE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他配置信息"><span class="toc-number">4.2.</span> <span class="toc-text">其他配置信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#compaction_throughput_mb_per_sec_√"><span class="toc-number">4.2.1.</span> <span class="toc-text">compaction_throughput_mb_per_sec √</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeveledCompactionStrategy"><span class="toc-number">4.2.2.</span> <span class="toc-text">LeveledCompactionStrategy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ref"><span class="toc-number">4.3.</span> <span class="toc-text">Ref</span></a></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>







    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/10/15/Cassandra-exception/" title="上一篇: Cassandra常见异常">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/09/10/2015-09-10-Storm-Window/" title="下一篇: Storm的滑动窗口">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2016 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>